<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finances</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7;
      --accent:#4CAF50; --accent2:#2dd4bf;
      --ring:#2a3543; --good:#22c55e; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -200px, rgba(76,175,80,.20), transparent 55%),
        radial-gradient(900px 700px at 10% 0%, rgba(45,212,191,.12), transparent 60%),
        var(--bg);
      color:var(--ink);
    }
    a{color:inherit; text-decoration:none}

    /* ---- top nav: single line ---- */
    .topbar{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.72));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(42,53,67,.55);
    }
    .topbar-inner{
      max-width:1120px; margin:0 auto;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      white-space:nowrap;
    }
    .nav{
      margin-left:auto;
      display:flex; gap:8px;
      align-items:center;
      flex:1 1 auto;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      white-space:nowrap;
      padding-bottom:2px;
    }
    .nav::-webkit-scrollbar{height:6px}
    .nav::-webkit-scrollbar-thumb{background:rgba(42,53,67,.6); border-radius:999px}
    .pill{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    .wrap{max-width:1120px; margin:0 auto; padding:12px}

    .card{
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Month nav above the 2 stats */
    .monthbar{
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 12px 0 12px;
    }
    .monthbtn{
      width:40px; height:38px;
      border-radius:12px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
    }
    .monthlabel{
      font-weight:950;
      color:var(--ink);
      letter-spacing:.2px;
      min-width: 160px;
      text-align:center;
    }

    .stats{
      display:grid; gap:12px; grid-template-columns: repeat(2, 1fr);
      padding:12px;
    }
    .stat{
      padding:12px 14px;
      background: rgba(11,15,20,.35);
      border:1px solid rgba(42,53,67,.55);
      border-radius: 14px;
      text-align:center;
    }
    .stat .v{font-size:24px; font-weight:900; color:var(--good); line-height:1.1}
    .stat .k{font-size:12px; color:var(--muted); margin-top:4px; font-weight:800}

    /* Week navigation inside the week stat */
    .weekbar{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .weekbtn{
      width:34px; height:30px;
      border-radius:12px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .weekbtn:disabled{
      opacity:.35;
      cursor:not-allowed;
    }
    .weeklabel{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      min-width: 92px;
      text-align:center;
    }

    /* Toggle button state */
    .btn.toggle-on{
      outline: 2px solid rgba(76,175,80,.55);
      background: rgba(76,175,80,.10);
      border-color: rgba(76,175,80,.55);
    }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
      margin-top:14px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns: 1.35fr .85fr}
    }

    .card-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(42,53,67,.55);
      gap:12px;
      flex-wrap:wrap;
    }
    .card-h h3{
      margin:0; font-size:14px; color:var(--muted);
      display:flex; align-items:center; gap:8px;
      letter-spacing:.2px;
    }
    .card-b{padding:14px 16px}

    .btn{
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
    }

    .donut-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(11,15,20,.35);
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    /* Extra controls on the donut row */
    .donut-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tab.filter{padding:8px 14px}

    /* Store selector panel (only visible in Stores mode) */
    .store-panel{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .store-btn{
      padding: 9px 12px;
      border-radius: 999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(11,15,20,.35);
      color:var(--muted);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .store-btn.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    canvas{max-width:100%; width:100%}

    .legend{margin-top:12px; display:flex; flex-direction:column; gap:8px;}
    .legend-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      cursor:pointer;
      user-select:none;
    }
    .legend-left{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:#888;
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .legend-name{font-weight:900}
    .legend-meta{font-size:12px; color:var(--muted); font-weight:800}
    .legend-right{text-align:right}
    .legend-amt{font-weight:900; color:var(--good)}
    .legend-row.selected{
      outline: 2px solid rgba(76,175,80,.55);
      background: rgba(76,175,80,.08);
    }

    .empty{
      color:var(--muted);
      display:flex; align-items:center; justify-content:center;
      padding:26px 10px;
      gap:10px;
      text-align:center;
    }

    .recent{display:flex; flex-direction:column; gap:10px;}
    .recent-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      gap:10px;
      cursor:pointer;
    }
    .recent-left{display:flex; flex-direction:column; gap:2px; min-width:0}
    .recent-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .recent-sub{font-size:12px; color:var(--muted); font-weight:800}
    .recent-toggle{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .chev{
      width:100%;
      justify-content:center;
      gap:8px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="https://ragnorak02.github.io/levelUp/main.html" title="Back to LevelUp">üè† <span>Finances</span></a>
      <div class="nav">
        <a class="pill active" href="index.html">Home</a>
        <a class="pill" href="food.html">Food</a>
        <a class="pill" href="search.html">Search</a>
        <a class="pill" href="receipts.html">Receipts</a>
        <a class="pill" href="analytics.html">Analytics</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" style="margin-top:12px;">
      <div class="monthbar">
        <button class="monthbtn" id="monthPrev" type="button">‚óÄ</button>
        <div class="monthlabel" id="monthLabel">Month</div>
        <button class="monthbtn" id="monthNext" type="button">‚ñ∂</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="v" id="statMonth">$0.00</div>
          <div class="k">Month Total</div>
        </div>
        <div class="stat">
          <div class="v" id="statWeek">$0.00</div>
          <div class="weekbar">
            <button class="weekbtn" id="weekPrev" type="button" aria-label="Previous week">‚óÄ</button>
            <div class="weeklabel" id="weekLabel">--/--‚Äì--/--</div>
            <button class="weekbtn" id="weekNext" type="button" aria-label="Next week">‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <h3>üìä Spending by Category</h3>
          <div>
	            <button class="btn" id="mortgageToggleBtn" type="button" title="Hide or show mortgage payments in charts">Hide Mortgage</button>
            <button class="btn" id="donutResetBtn" type="button">Reset</button>
            <button class="btn" id="storesBtn" type="button">Stores</button>
          </div>
        </div>

        <div class="card-b">
          <div class="donut-top">
            <div class="tabs">
              <div class="tab active" id="tabAll">All</div>
              <div class="tab" id="tabGroceries">Groceries</div>
            </div>
            <div class="donut-actions">
              <button class="tab filter" id="rentalFilterBtn" type="button" title="Show only receipts tagged as rental">Rental</button>
            </div>
          </div>

          <div id="storePanel" class="store-panel" style="display:none;"></div>

          <div style="margin-top:12px;">
            <canvas id="donutCanvas" width="620" height="360"></canvas>
          </div>

          <div class="legend" id="donutLegend"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h3>üß† Budget Status</h3>
        </div>
        <div class="card-b">
          <div class="empty">üéØ Set up budgets to track your spending goals.</div>
          <div style="display:flex; justify-content:center;">
            <a class="btn" href="budget.html">Set Budgets</a>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="card-h">
        <h3>üõí Recent Purchases</h3>
      </div>
      <div class="card-b">
        <div class="recent" id="recentPurchases"></div>
        <div class="recent-toggle" id="recentToggleWrap" style="display:none;">
          <button class="btn chev" id="recentToggleBtn" type="button">Show more ‚ñº</button>
        </div>
      </div>
    </div>
  </div>

  <script src="dataLoader.js"></script>
  <script>
    const fmtMoney = (n) => `$${(Number(n)||0).toFixed(2)}`;
    const toDate = (d) => (d instanceof Date ? d : new Date(d));

    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtMD(date){
      const d = new Date(date);
      return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
    }

    function startOfWeekSunday(date){
      const dt = new Date(date);
      dt.setHours(0,0,0,0);
      const day = dt.getDay(); // 0=Sun
      dt.setDate(dt.getDate() - day);
      return dt;
    }
    function endOfWeekSaturday(date){
      const s = startOfWeekSunday(date);
      const e = new Date(s);
      e.setDate(e.getDate()+6);
      e.setHours(23,59,59,999);
      return e;
    }
    function inRange(dt, start, end){
      const t = dt.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    // ---- stable color mapping by category NAME ----
    const FIXED_COLORS = {
      // top-level
      "Groceries":"#4CAF50",
      "Cafe":"#f59e0b",
      "Restaurant":"#ef4444",
      "Home":"#60a5fa",
      "Rental Property":"#a78bfa",
      "Transportation":"#14b8a6",
      "Utilities":"#f97316",
      "Medical":"#f472b6",
      "Other":"#94a3b8",

      // grocery breakdown
      "Meat/Fish":"#2dd4bf",
      "Dairy":"#60a5fa",
      "Produce":"#22c55e",
      "Snacks":"#fb7185",
      "Pantry":"#a78bfa",
      "Bakery":"#f59e0b",
      "Drinks":"#14b8a6",
      "Grains":"#f97316",
      "Unknown":"#94a3b8"
    };

    // ---- fixed store colors (used in Stores mode) ----
    const STORE_ORDER = ["Walmart","Trader Joe's","Starbucks","Price Chopper","Other"];
    const STORE_COLORS = {
      "Walmart": "#60a5fa",        // blue
      "Trader Joe's": "#22c55e",    // green
      "Starbucks": "#2dd4bf",      // teal
      "Price Chopper": "#f97316",  // orange
      "Other": "#94a3b8"           // gray
    };

    function hashColor(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const hue = Math.abs(h) % 360;
      return `hsl(${hue} 70% 55%)`;
    }
    function getColor(name){
      const key = (name || "Unknown").trim();
      return FIXED_COLORS[key] || hashColor(key);
    }

    // ---------- donut drawing ----------
    function drawDonut(ctx, w, h, categories, selectedIndex){
      ctx.clearRect(0,0,w,h);
      const total = categories.reduce((a,c)=>a + (c.total||0), 0) || 0;

      const centerX = w/2;
      const centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      ctx.save();
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius*1.35, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(76,175,80,0.06)';
      ctx.fill();
      ctx.restore();

      let currentAngle = -Math.PI/2;

      categories.forEach((cat, i) => {
        const sliceAngle = total === 0 ? 0 : (cat.total / total) * 2 * Math.PI;
        const isSelected = (selectedIndex === i);
        const outerR = isSelected ? radius * 1.08 : radius;

        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();

        ctx.fillStyle = cat.color;
        ctx.fill();

        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.stroke();

        currentAngle += sliceAngle;
      });

      // center text
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.65)';
      ctx.shadowBlur = 8;

      ctx.fillStyle = '#e8eef6';
      ctx.font = '900 40px system-ui';
      ctx.fillText(total ? `$${Math.round(total)}` : '$0', centerX, centerY - 6);

      ctx.fillStyle = 'rgba(159,176,199,0.95)';
      ctx.font = '800 14px system-ui';
      ctx.fillText('Total', centerX, centerY + 28);

      // selected label ABOVE donut
      if (selectedIndex != null && categories[selectedIndex]) {
        const c = categories[selectedIndex];
        ctx.fillStyle = '#e8eef6';
        ctx.font = '900 18px system-ui';
        ctx.fillText(`${c.name}: ${fmtMoney(c.total)}`, centerX, centerY - (radius + 36));
      }
      ctx.restore();
    }

    function getSliceAtPoint(w, h, categories, x, y){
      const centerX = w/2, centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      const dx = x - centerX;
      const dy = y - centerY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < innerRadius || dist > radius*1.12) return null;

      let ang = Math.atan2(dy, dx);
      ang = ang - (-Math.PI/2);
      if (ang < 0) ang += Math.PI*2;

      const total = categories.reduce((a,c)=>a+(c.total||0),0) || 0;
      let acc = 0;
      for (let i=0;i<categories.length;i++){
        const slice = total === 0 ? 0 : (categories[i].total/total) * Math.PI*2;
        if (ang >= acc && ang < acc + slice) return i;
        acc += slice;
      }
      return null;
    }

    function buildLegend(container, categories, selectedIndex, onPick){
      container.innerHTML = '';
      categories.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'legend-row' + (selectedIndex === idx ? ' selected' : '');

        const left = document.createElement('div');
        left.className = 'legend-left';

        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.background = c.color;

        const nameWrap = document.createElement('div');

        const name = document.createElement('div');
        name.className = 'legend-name';
        name.textContent = c.name;

        const meta = document.createElement('div');
        meta.className = 'legend-meta';
        meta.textContent = `${c.itemsCount} items`;

        nameWrap.appendChild(name);
        nameWrap.appendChild(meta);

        left.appendChild(dot);
        left.appendChild(nameWrap);

        const right = document.createElement('div');
        right.className = 'legend-right';

        const amt = document.createElement('div');
        amt.className = 'legend-amt';
        amt.textContent = fmtMoney(c.total);

        right.appendChild(amt);

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener('click', () => onPick(idx));
        container.appendChild(row);
      });
    }

    // ---- OPTIONAL items DB load (safe if file missing) ----
    async function loadItemsDb(){
      try{
        const r = await fetch('itemsDatabase.json', {cache:'no-store'});
        if (!r.ok) return null;
        return await r.json();
      }catch(e){
        return null;
      }
    }

    function norm(s){
      return String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
    }

    function lookupFoodCategoryFromItemsDb(itemsDb, itemName){
      if (!itemsDb) return null;

      if (itemsDb.map && typeof itemsDb.map === 'object'){
        const n = norm(itemName);
        for (const k of Object.keys(itemsDb.map)){
          if (n.includes(norm(k))) return itemsDb.map[k];
        }
      }

      if (Array.isArray(itemsDb.items)){
        const n = norm(itemName);
        for (const it of itemsDb.items){
          if (!it) continue;
          const key = norm(it.name || it.item || it.title);
          if (key && n.includes(key)) return it.category || it.foodCategory || null;
        }
      }

      return null;
    }

    function guessFoodCategory(itemName){
      const n = norm(itemName);
      const has = (...words) => words.some(w => n.includes(w));

      if (has('beef','steak','chicken','pork','turkey','lamb','salmon','tuna','shrimp','fish','meat','teres','teres major')) return 'Meat/Fish';
      if (has('milk','yogurt','cheese','butter','cream','oatly','half and half','egg','eggs')) return 'Dairy';
      if (has('banana','apple','avocado','berries','strawberry','blueberry','raspberry','pepper','spinach','lettuce','tomato','onion','cucumber','carrot','produce')) return 'Produce';
      if (has('bread','bagel','bun','muffin','croissant','bakery')) return 'Bakery';
      if (has('rice','oats','oat','pasta','noodle','quinoa','grain','grains')) return 'Grains';
      if (has('chips','cookie','cookies','chocolate','candy','snack','snacks','ice cream')) return 'Snacks';
      if (has('soda','juice','water','coffee','tea','drink','drinks')) return 'Drinks';
      if (has('sauce','spice','salt','pepper','oil','vinegar','pantry')) return 'Pantry';

      return 'Other';
    }

    function sumReceiptItemsCount(r){
      return Array.isArray(r.items) ? r.items.length : (Number(r.itemsCount)||0);
    }

    // ---------- category builders ----------
    function aggregateByReceiptCategory(receipts){
      const map = new Map();
      receipts.forEach(r => {
        const name = (r.category || 'Other').trim();
        const prev = map.get(name) || { name, total:0, itemsCount:0 };
        prev.total += Number(r.total)||0;
        prev.itemsCount += sumReceiptItemsCount(r);
        map.set(name, prev);
      });

      return Array.from(map.values())
        .sort((a,b)=>b.total-a.total)
        .map(c => ({ ...c, color: getColor(c.name) }));
    }

    async function aggregateGroceriesBreakdown(receipts){
      const itemsDb = await loadItemsDb();

      const groceryReceipts = receipts.filter(r => {
        const cat = (r.category||'').trim();
        return ['Groceries','Meat/Fish','Dairy','Produce','Snacks','Pantry','Bakery','Drinks','Grains'].includes(cat);
      });

      const map = new Map();

      groceryReceipts.forEach(r=>{
        const cat = (r.category||'Other').trim();

        const directFood = ['Meat/Fish','Dairy','Produce','Snacks','Pantry','Bakery','Drinks','Grains'];
        if (directFood.includes(cat)){
          const prev = map.get(cat) || { name:cat, total:0, itemsCount:0 };
          prev.total += Number(r.total)||0;
          prev.itemsCount += sumReceiptItemsCount(r);
          map.set(cat, prev);
          return;
        }

        if (cat === 'Groceries' && Array.isArray(r.items) && r.items.length){
          r.items.forEach(it=>{
            const itemName = (it.name || it.item || it.title || it.description || '').trim();
            const qty = Number(it.qty ?? it.quantity ?? 1) || 1;
            const price = Number(it.total ?? it.price ?? it.amount ?? 0) || 0;

            const fromDb = lookupFoodCategoryFromItemsDb(itemsDb, itemName);
            const bucket = (fromDb || guessFoodCategory(itemName) || 'Other').trim();

            const prev = map.get(bucket) || { name:bucket, total:0, itemsCount:0 };
            prev.total += price;
            prev.itemsCount += qty;
            map.set(bucket, prev);
          });
          return;
        }

        const prev = map.get('Other') || { name:'Other', total:0, itemsCount:0 };
        prev.total += Number(r.total)||0;
        prev.itemsCount += sumReceiptItemsCount(r);
        map.set('Other', prev);
      });

      return Array.from(map.values())
        .sort((a,b)=>b.total-a.total)
        .map(c => ({ ...c, color: getColor(c.name) }));
    }

    function monthKey(date){
      const d = new Date(date.getFullYear(), date.getMonth(), 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function getMonthRangeFromBase(now, offset){
      const base = new Date(now.getFullYear(), now.getMonth() + offset, 1);
      const start = new Date(base.getFullYear(), base.getMonth(), 1, 0,0,0,0);
      const end = new Date(base.getFullYear(), base.getMonth()+1, 0, 23,59,59,999);
      return { start, end, labelDate: base };
    }

    // Week windows inside a month: [monthStart..monthStart+6], [monthStart+7..+13], ...
    function getWeeksWithinMonth(monthStart, monthEnd){
      const weeks = [];
      const s0 = new Date(monthStart);
      s0.setHours(0,0,0,0);
      const eMonth = new Date(monthEnd);
      eMonth.setHours(23,59,59,999);

      let cursor = new Date(s0);
      while (cursor.getTime() <= eMonth.getTime()){
        const s = new Date(cursor);
        const e = new Date(cursor);
        e.setDate(e.getDate()+6);
        e.setHours(23,59,59,999);
        if (e.getTime() > eMonth.getTime()) e.setTime(eMonth.getTime());
        weeks.push({ start: s, end: e });

        cursor = new Date(cursor);
        cursor.setDate(cursor.getDate()+7);
        cursor.setHours(0,0,0,0);
      }
      return weeks;
    }

    function defaultWeekIndexForMonth(now, monthStart){
      // If we're viewing the current month, land on the current 7-day window; otherwise start at the first week.
      const n = new Date(now); n.setHours(0,0,0,0);
      const ms = new Date(monthStart); ms.setHours(0,0,0,0);
      const diffDays = Math.floor((n.getTime() - ms.getTime()) / (1000*60*60*24));
      return diffDays >= 0 ? Math.floor(diffDays / 7) : 0;
    }

    function isMortgageReceipt(r){
      if (!r) return false;
      const store = String(r.store || '').toLowerCase();
      const cat = String(r.category || '').toLowerCase();
      const notes = String(r.notes || '').toLowerCase();
      if (store.includes('mortgage') || notes.includes('mortgage')) return true;
      if (cat === 'housing') return true;
      if (Array.isArray(r.items) && r.items.some(it => String(it.subcategory||'').toLowerCase() === 'mortgage')) return true;
      return false;
    }

    function formatMonthLabel(d, now){
      const sameYear = d.getFullYear() === now.getFullYear();
      const m = d.toLocaleString('en-US', { month:'long' });
      return sameYear ? m : `${m} ${d.getFullYear()}`;
    }

    async function main(){
      let data = null;
      try{
        if (window.loadAllData) data = await window.loadAllData();
        else if (window.loadReceiptsData) data = await window.loadReceiptsData();
      }catch(e){}

      if (!data) {
        const r = await fetch('receiptsData.json', {cache:'no-store'});
        data = await r.json();
      }
      const allReceipts = Array.isArray(data) ? data : (data.receipts || []);
      const now = new Date();

      // ---- month selection state ----
      let monthOffset = 0; // 0=current month, -1 previous, etc.
      let tab = 'all';     // 'all' | 'groceries'
      let selectedIndex = null;
      let activeCategories = [];

      // ---- filters & week selection state ----
      let hideMortgage = true;
      let rentalOnly = false;
      let weekIndex = 0; // 0=first week window inside the selected month

      // ---- chart modes ----
      // category: existing behavior
      // stores: donut shows monthly spending by store; selecting a store drills down
      let donutMode = 'category'; // 'category' | 'stores'
      let selectedStore = null;   // store name (one of STORE_ORDER), or null

      function isMortgageReceipt(r){
        const cat = String(r.category||'').trim().toLowerCase();
        const store = String(r.store||'').trim().toLowerCase();
        if (cat === 'housing') return true;
        if (store.includes('mortgage')) return true;
        if (Array.isArray(r.items) && r.items.some(it => String(it.subcategory||'').toLowerCase() === 'mortgage')) return true;
        return false;
      }

      function applyMortgageFilter(list){
        return hideMortgage ? list.filter(r => !isMortgageReceipt(r)) : list;
      }

      function applyRentalFilter(list){
        return rentalOnly ? list.filter(r => String(r.property||'').toLowerCase() === 'rental') : list;
      }

      function normalizeStoreName(store){
        const s = String(store||'').trim().toLowerCase();
        if (!s) return 'Other';
        if (s.includes('walmart')) return 'Walmart';
        if (s.includes("trader") && s.includes('joe')) return "Trader Joe's";
        if (s.includes('starbuck')) return 'Starbucks';
        if (s.includes('price chopper') || s.includes('pricechopper')) return 'Price Chopper';
        return 'Other';
      }

      function aggregateByStore(receipts){
        const map = new Map();
        receipts.forEach(r => {
          const name = normalizeStoreName(r.store);
          const prev = map.get(name) || { name, total:0, itemsCount:0 };
          prev.total += Number(r.total)||0;
          prev.itemsCount += sumReceiptItemsCount(r);
          map.set(name, prev);
        });

        // Ensure fixed order & include missing stores as 0s for consistent legend
        return STORE_ORDER
          .map(name => {
            const v = map.get(name) || { name, total:0, itemsCount:0 };
            return { ...v, color: STORE_COLORS[name] || getColor(name) };
          })
          .filter(v => v.total > 0 || v.name === 'Other');
      }

      function buildMonthWeeks(mStart, mEnd){
        // Weeks are 7-day windows that never cross the selected month boundaries.
        const weeks = [];
        const start = new Date(mStart);
        start.setHours(0,0,0,0);
        const end = new Date(mEnd);
        end.setHours(23,59,59,999);

        let cur = new Date(start);
        while (cur.getTime() <= end.getTime()){
          const wStart = new Date(cur);
          wStart.setHours(0,0,0,0);
          const wEnd = new Date(wStart);
          wEnd.setDate(wEnd.getDate() + 6);
          if (wEnd.getTime() > end.getTime()) wEnd.setTime(end.getTime());
          wEnd.setHours(23,59,59,999);
          weeks.push({ start: wStart, end: wEnd });
          cur.setDate(cur.getDate() + 7);
        }
        return weeks;
      }

      function defaultWeekIndexForMonth(mStart){
        // If the selected month is the current month, default to the week containing "now".
        if (monthOffset === 0){
          const ms = new Date(mStart);
          ms.setHours(0,0,0,0);
          const diffDays = Math.floor((now.getTime() - ms.getTime()) / (1000*60*60*24));
          return Math.max(0, Math.floor(diffDays / 7));
        }
        return 0;
      }

      const monthLabelEl = document.getElementById('monthLabel');
      const monthPrevEl = document.getElementById('monthPrev');
      const monthNextEl = document.getElementById('monthNext');

      const weekPrevEl = document.getElementById('weekPrev');
      const weekNextEl = document.getElementById('weekNext');
      const weekLabelEl = document.getElementById('weekLabel');

      const mortgageToggleBtn = document.getElementById('mortgageToggleBtn');
      if (mortgageToggleBtn){
        mortgageToggleBtn.classList.toggle('toggle-on', hideMortgage);
        mortgageToggleBtn.textContent = hideMortgage ? 'Show Mortgage' : 'Hide Mortgage';
      }

      const storesBtn = document.getElementById('storesBtn');
      const rentalFilterBtn = document.getElementById('rentalFilterBtn');
      const storePanel = document.getElementById('storePanel');

      const statMonthEl = document.getElementById('statMonth');
      const statWeekEl = document.getElementById('statWeek');

      const tabAllEl = document.getElementById('tabAll');
      const tabGroEl = document.getElementById('tabGroceries');

      const canvas = document.getElementById('donutCanvas');
      const legend = document.getElementById('donutLegend');
      const ctx = canvas.getContext('2d');

      // crisp on mobile
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = canvas.clientWidth || 620;
      const cssH = 360;
      canvas.style.height = cssH + 'px';
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      function getReceiptsForSelectedMonth(){
        const { start, end } = getMonthRangeFromBase(now, monthOffset);
        const inMonth = allReceipts.filter(r => inRange(toDate(r.date), start, end));
        return applyRentalFilter(applyMortgageFilter(inMonth));
      }

      function getReceiptsForCurrentView() {
        // Start with whatever your ‚Äúmonth receipts‚Äù function is
        // (should already respect month + mortgage hide)
        let list = getReceiptsForSelectedMonth();

        // --- Rental filter ---
        // If your rental toggle uses a boolean like rentalOnly:
        if (typeof rentalOnly !== "undefined" && rentalOnly) {
          list = list.filter(r => r && r.property === "rental");
        }

        // --- Stores mode ---
        // If you have storesMode boolean and selectedStore string:
        if (typeof storesMode !== "undefined" && storesMode) {
          const keyForStore = (r) => (r.store || r.restaurant || "Other");

          if (typeof selectedStore !== "undefined" && selectedStore) {
            // Drill-down: only receipts for the selected store
            list = list.filter(r => keyForStore(r) === selectedStore);
          } else {
            // Stores mode (no store selected): keep all receipts
            // (donut shows store totals; recent purchases should show filtered receipts list)
          }
        }

        // --- Tab logic ---
        // If your Groceries tab means ‚Äúonly show grocery receipts‚Äù:
        if (typeof tab !== "undefined" && tab === "groceries") {
          list = list.filter(r => String(r.category || "").toLowerCase() === "groceries");
        }

        return list;
      }


      function updateTopStats(){
        const { start: mStart, end: mEnd, labelDate } = getMonthRangeFromBase(now, monthOffset);
        monthLabelEl.textContent = formatMonthLabel(labelDate, now);

        // month total (respects mortgage & rental toggles)
        const monthReceipts = applyRentalFilter(applyMortgageFilter(allReceipts.filter(r => inRange(toDate(r.date), mStart, mEnd))));
        const monthSpent = monthReceipts.reduce((a,r)=>a+(Number(r.total)||0),0);


        // "This week" becomes a selectable week window within the selected month.
        const weeks = buildMonthWeeks(mStart, mEnd);
        if (!weeks.length){
          weekIndex = 0;
          weekLabelEl.textContent = '--/--‚Äì--/--';
          weekPrevEl.disabled = true;
          weekNextEl.disabled = true;
          statMonthEl.textContent = fmtMoney(monthSpent);
          statWeekEl.textContent = fmtMoney(0);
          return;
        }

        // initialize / clamp weekIndex
        const maxIdx = weeks.length - 1;
        if (weekIndex == null || Number.isNaN(weekIndex)) weekIndex = 0;
        if (weekIndex < 0) weekIndex = 0;
        if (weekIndex > maxIdx) weekIndex = maxIdx;

        const wk = weeks[weekIndex];
        const weekSpent = applyRentalFilter(applyMortgageFilter(allReceipts.filter(r => inRange(toDate(r.date), wk.start, wk.end))))
          .reduce((a,r)=>a+(Number(r.total)||0),0);

        weekLabelEl.textContent = `${fmtMD(wk.start)}‚Äì${fmtMD(wk.end)}`;
        weekPrevEl.disabled = (weekIndex <= 0);
        weekNextEl.disabled = (weekIndex >= maxIdx);

        statMonthEl.textContent = fmtMoney(monthSpent);
        statWeekEl.textContent = fmtMoney(weekSpent);
      }

      async function computeCategories(){
        const monthReceipts = getReceiptsForSelectedMonth();
        // Stores mode:
        // - no selectedStore => monthly totals by store
        // - selectedStore    => category breakdown filtered to that store (tabs still work)
        if (donutMode === 'stores'){
          if (!selectedStore){
            activeCategories = aggregateByStore(monthReceipts);
          } else {
            const filtered = monthReceipts.filter(r => normalizeStoreName(r.store) === selectedStore);
            if (tab === 'groceries') activeCategories = await aggregateGroceriesBreakdown(filtered);
            else activeCategories = aggregateByReceiptCategory(filtered);
          }
          return;
        }

        // Default category mode (existing behavior)
        if (tab === 'groceries') activeCategories = await aggregateGroceriesBreakdown(monthReceipts);
        else activeCategories = aggregateByReceiptCategory(monthReceipts);
      }

      function redraw(){
        drawDonut(ctx, cssW, cssH, activeCategories, selectedIndex);
        buildLegend(legend, activeCategories, selectedIndex, (idx)=>{
          selectedIndex = (selectedIndex === idx) ? null : idx;
          redraw();
        });
      }

      function renderStorePanel(){
        if (!storePanel) return;
        storePanel.innerHTML = '';

        const buttons = STORE_ORDER.filter(n => n !== 'Other');
        buttons.forEach(name => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'store-btn' + (selectedStore === name ? ' active' : '');
          b.textContent = name;
          b.addEventListener('click', async ()=>{
            // Clicking the active store toggles back to store totals
            selectedStore = (selectedStore === name) ? null : name;
            selectedIndex = null;
            renderStorePanel();
            await refreshAll();
          });
          storePanel.appendChild(b);
        });
      }

      function updateModeUI(){
        if (storesBtn) storesBtn.classList.toggle('toggle-on', donutMode === 'stores');
        if (rentalFilterBtn) rentalFilterBtn.classList.toggle('active', rentalOnly);
        if (storePanel){
          storePanel.style.display = (donutMode === 'stores') ? 'flex' : 'none';
          if (donutMode === 'stores') renderStorePanel();
        }
      }

      async function refreshAll(){
        updateTopStats();
        updateModeUI();
        selectedIndex = null;
        await computeCategories();
        redraw();
        renderRecent(); // keep recent list in sync with the viewed month
      }

      async function setTab(newTab){
        tab = newTab;
        selectedIndex = null;
        tabAllEl.classList.toggle('active', tab === 'all');
        tabGroEl.classList.toggle('active', tab === 'groceries');
        await computeCategories();
        redraw();
        renderRecent();

      }

      tabAllEl.addEventListener('click', ()=>setTab('all'));
      tabGroEl.addEventListener('click', ()=>setTab('groceries'));

      canvas.addEventListener('click', (ev) => {
        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const y = ev.clientY - rect.top;
        const idx = getSliceAtPoint(cssW, cssH, activeCategories, x, y);
        if (idx == null) selectedIndex = null;
        else selectedIndex = (selectedIndex === idx) ? null : idx;
        redraw();
      });

      document.getElementById('donutResetBtn').addEventListener('click', ()=>{
        // Full reset: back to default chart state
        donutMode = 'category';
        selectedStore = null;
        rentalOnly = false;
        tab = 'all';
        selectedIndex = null;

        tabAllEl.classList.toggle('active', true);
        tabGroEl.classList.toggle('active', false);
        updateModeUI();
        refreshAll();
      });

      monthPrevEl.addEventListener('click', async ()=>{
        monthOffset -= 1;
        const { start: mStart } = getMonthRangeFromBase(now, monthOffset);
        weekIndex = defaultWeekIndexForMonth(mStart);
        await refreshAll();
      });
      monthNextEl.addEventListener('click', async ()=>{
        monthOffset += 1;
        const { start: mStart } = getMonthRangeFromBase(now, monthOffset);
        weekIndex = defaultWeekIndexForMonth(mStart);
        await refreshAll();
      });

      weekPrevEl.addEventListener('click', ()=>{
        weekIndex = Math.max(0, (weekIndex||0) - 1);
        updateTopStats();
      });
      weekNextEl.addEventListener('click', ()=>{
        weekIndex = (weekIndex||0) + 1;
        updateTopStats();
      });

      // Stores toggle (monthly store totals + drill-down)
      if (storesBtn){
        storesBtn.addEventListener('click', async ()=>{
          donutMode = (donutMode === 'stores') ? 'category' : 'stores';
          selectedStore = null;
          selectedIndex = null;
          updateModeUI();
          await refreshAll();
        });
      }

      // Rental filter toggle (only include receipts tagged with { property: "rental" })
      if (rentalFilterBtn){
        rentalFilterBtn.addEventListener('click', async ()=>{
          rentalOnly = !rentalOnly;
          selectedIndex = null;
          updateModeUI();
          await refreshAll();
        });
      }

      if (mortgageToggleBtn){
        mortgageToggleBtn.addEventListener('click', async ()=>{
          hideMortgage = !hideMortgage;
          mortgageToggleBtn.classList.toggle('toggle-on', hideMortgage);
          mortgageToggleBtn.textContent = hideMortgage ? 'Show Mortgage' : 'Hide Mortgage';
          await refreshAll();
        });
      }

      // ---- recent purchases: show 3 by default with expand ----
      const recentWrap = document.getElementById('recentPurchases');
      const recentToggleWrap = document.getElementById('recentToggleWrap');
      const recentToggleBtn = document.getElementById('recentToggleBtn');
      let recentExpanded = false;

      function renderRecent(){
        const { start: mStart, end: mEnd } = getMonthRangeFromBase(now, monthOffset);

        const monthReceipts = allReceipts.filter(r => {
          const d = toDate(r.date);
          if (!(d >= mStart && d < mEnd)) return false;
          if (hideMortgage && isMortgageReceipt(r)) return false;
          return true;
        });

        const sorted = [...monthReceipts].sort((a,b)=> toDate(b.date) - toDate(a.date));


        const maxCollapsed = 3;
        const maxExpanded = 12;

        const toShow = recentExpanded ? sorted.slice(0, maxExpanded) : sorted.slice(0, maxCollapsed);

        recentWrap.innerHTML = '';
        if (!toShow.length){
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No purchases yet.';
          recentWrap.appendChild(empty);
          recentToggleWrap.style.display = 'none';
          return;
        }

        toShow.forEach(r=>{
          const row = document.createElement('div');
          row.className = 'recent-item';

          const left = document.createElement('div');
          left.className = 'recent-left';

          const title = document.createElement('div');
          title.className = 'recent-title';
          title.textContent = r.store || 'Unknown Store';

          const sub = document.createElement('div');
          sub.className = 'recent-sub';
          const d = toDate(r.date);
          const ds = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
          const count = sumReceiptItemsCount(r);
          sub.textContent = `${ds} ‚Ä¢ ${count} items`;

          left.appendChild(title);
          left.appendChild(sub);

          const right = document.createElement('div');
          right.style.fontWeight = '900';
          right.style.color = 'var(--good)';
          right.textContent = fmtMoney(r.total);

          row.appendChild(left);
          row.appendChild(right);

          row.addEventListener('click', ()=>{
            try{ localStorage.setItem('selectedReceiptId', r.id || ''); }catch(e){}
            window.location.href = 'receipts.html';
          });

          recentWrap.appendChild(row);
        });

        // show toggle only if there are more than 3 receipts total
        if (sorted.length > maxCollapsed){
          recentToggleWrap.style.display = 'flex';
          recentToggleBtn.textContent = recentExpanded ? 'Show less ‚ñ≤' : 'Show more ‚ñº';
        } else {
          recentToggleWrap.style.display = 'none';
        }
      }

      recentToggleBtn.addEventListener('click', ()=>{
        recentExpanded = !recentExpanded;
        renderRecent();
      });

      // initial paint
      {
        const { start: mStart } = getMonthRangeFromBase(now, monthOffset);
        weekIndex = defaultWeekIndexForMonth(mStart);
      }
      await refreshAll();
      renderRecent();
    }

    main().catch(console.error);
  </script>
</body>
</html>