<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevelUp Test Runner</title>
    <style>
        :root {
            --bg: #0f1117;
            --card: #1a1d27;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --muted: #71717a;
            --pass: #22c55e;
            --fail: #ef4444;
            --warn: #f59e0b;
            --accent: #60a5fa;
            --radius: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 24px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .subtitle {
            color: var(--muted);
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .seed-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .seed-input label {
            font-size: 13px;
            color: var(--muted);
        }

        .seed-input input {
            width: 80px;
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 14px;
            font-family: monospace;
        }

        .seed-input input:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        button:hover { opacity: 0.85; }
        button:active { transform: scale(0.98); }

        .btn-seed {
            background: var(--accent);
            color: #fff;
        }

        .btn-test {
            background: var(--pass);
            color: #fff;
        }

        .btn-clear {
            background: var(--fail);
            color: #fff;
        }

        .btn-summary {
            background: var(--border);
            color: var(--text);
        }

        /* Summary bar */
        .summary-bar {
            display: none;
            padding: 16px 20px;
            border-radius: var(--radius);
            background: var(--card);
            border: 1px solid var(--border);
            margin-bottom: 24px;
            font-size: 15px;
            font-weight: 600;
        }

        .summary-bar.show { display: flex; gap: 24px; align-items: center; }

        .summary-bar .passed { color: var(--pass); }
        .summary-bar .failed { color: var(--fail); }
        .summary-bar .total { color: var(--muted); }

        /* Status message */
        .status-msg {
            padding: 12px 16px;
            border-radius: var(--radius);
            background: var(--card);
            border: 1px solid var(--border);
            margin-bottom: 16px;
            font-size: 13px;
            display: none;
        }

        .status-msg.show { display: block; }
        .status-msg.success { border-color: var(--pass); color: var(--pass); }
        .status-msg.error { border-color: var(--fail); color: var(--fail); }

        /* Results */
        .results {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suite-header {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
            margin-top: 16px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-card {
            padding: 10px 16px;
            border-radius: 8px;
            background: var(--card);
            border-left: 4px solid var(--border);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .result-card.pass { border-left-color: var(--pass); }
        .result-card.fail { border-left-color: var(--fail); }

        .result-card .name { flex: 1; }

        .result-card .badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .result-card.pass .badge {
            background: rgba(34, 197, 94, 0.15);
            color: var(--pass);
        }

        .result-card.fail .badge {
            background: rgba(239, 68, 68, 0.15);
            color: var(--fail);
        }

        .error-msg {
            color: var(--fail);
            font-size: 12px;
            margin-top: 6px;
            font-family: monospace;
            word-break: break-all;
            opacity: 0.85;
        }

        /* Data summary table */
        .data-summary {
            display: none;
            margin-top: 16px;
        }

        .data-summary.show { display: block; }

        .data-summary table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-summary th,
        .data-summary td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-summary th {
            color: var(--muted);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-summary td:first-child {
            color: var(--accent);
            font-weight: 600;
        }

        /* Back link */
        .back-link {
            display: inline-block;
            color: var(--muted);
            text-decoration: none;
            font-size: 13px;
            margin-bottom: 16px;
        }

        .back-link:hover { color: var(--text); }
    </style>
</head>
<body>
    <a class="back-link" href="../main.html">&larr; Back to Dashboard</a>
    <h1>LevelUp Test Runner</h1>
    <p class="subtitle">Automated testing &amp; data seeding for all modules</p>

    <div class="controls">
        <div class="seed-input">
            <label for="seedVal">Seed:</label>
            <input type="number" id="seedVal" value="42" min="0">
        </div>
        <button class="btn-seed" id="btnSeed">Seed Data</button>
        <button class="btn-test" id="btnTest">Run Tests</button>
        <button class="btn-summary" id="btnSummary">Data Summary</button>
        <button class="btn-clear" id="btnClear">Clear Data</button>
    </div>

    <div class="status-msg" id="statusMsg"></div>

    <div class="summary-bar" id="summaryBar">
        <span class="passed" id="sumPassed"></span>
        <span class="failed" id="sumFailed"></span>
        <span class="total" id="sumTotal"></span>
    </div>

    <div class="data-summary" id="dataSummary">
        <table>
            <thead>
                <tr><th>Module</th><th>Summary</th></tr>
            </thead>
            <tbody id="dataSummaryBody"></tbody>
        </table>
    </div>

    <div class="results" id="results"></div>

    <!-- Load test infrastructure in dependency order -->
    <script src="prng.js"></script>
    <script src="dataPools.js"></script>
    <script src="seedGenerator.js"></script>
    <script src="seedInjector.js"></script>
    <script src="testFramework.js"></script>

    <!-- Load test suites -->
    <script src="testSuiteData.js"></script>
    <script src="testSuiteAggregation.js"></script>
    <script src="testSuiteUI.js"></script>

    <script>
    (function() {
        'use strict';

        var seedInput = document.getElementById('seedVal');
        var btnSeed = document.getElementById('btnSeed');
        var btnTest = document.getElementById('btnTest');
        var btnClear = document.getElementById('btnClear');
        var btnSummary = document.getElementById('btnSummary');
        var statusMsg = document.getElementById('statusMsg');
        var summaryBar = document.getElementById('summaryBar');
        var resultsEl = document.getElementById('results');
        var dataSummaryEl = document.getElementById('dataSummary');
        var dataSummaryBody = document.getElementById('dataSummaryBody');

        function showStatus(msg, type) {
            statusMsg.textContent = msg;
            statusMsg.className = 'status-msg show ' + (type || '');
            setTimeout(function() { statusMsg.classList.remove('show'); }, 5000);
        }

        /* ===== Seed Data ===== */
        btnSeed.addEventListener('click', function() {
            if (!confirm('WARNING: This will REPLACE all your LevelUp data (workouts, receipts, flashcards, meals, etc.) with fake seed data.\n\nYour real data will be lost.\n\nProceed?')) {
                showStatus('Seed cancelled', '');
                return;
            }

            var seed = parseInt(seedInput.value) || 42;
            window.TestPRNG.reset(seed);

            var dataset = window.SeedGenerator.generateFullDataset(seed);

            // Clear existing app data
            var toRemove = [];
            for (var i = 0; i < localStorage.length; i++) {
                var k = localStorage.key(i);
                if (k && (k.startsWith('powerUp:') || k.startsWith('bowling:week:') || k === 'finances:receipts' || k === 'finances:dataLoaded' || k === 'finances:dataVersion' || k === 'levelupFlashData' || k === 'nutrition:meals' || k === 'nutrition:targets' || k === 'nutrition:recipes' || k === 'calendar:events' || k === 'travel:trips' || k.startsWith('levelUp:'))) {
                    toRemove.push(k);
                }
            }
            toRemove.forEach(function(k) { localStorage.removeItem(k); });

            // Inject all data
            if (dataset.workouts) {
                Object.keys(dataset.workouts).forEach(function(key) {
                    localStorage.setItem(key, JSON.stringify(dataset.workouts[key]));
                });
            }
            if (dataset.receipts) {
                localStorage.setItem('finances:receipts', JSON.stringify(dataset.receipts));
                localStorage.setItem('finances:dataLoaded', 'true');
                localStorage.setItem('finances:dataVersion', 'seed');
            }
            if (dataset.flashData) {
                localStorage.setItem('levelupFlashData', JSON.stringify(dataset.flashData));
            }
            if (dataset.meals) {
                localStorage.setItem('nutrition:meals', JSON.stringify(dataset.meals));
            }
            if (dataset.trips) {
                localStorage.setItem('travel:trips', JSON.stringify(dataset.trips));
            }
            if (dataset.bowlingData) {
                Object.keys(dataset.bowlingData).forEach(function(key) {
                    localStorage.setItem(key, JSON.stringify(dataset.bowlingData[key]));
                });
            }
            if (dataset.events) {
                localStorage.setItem('calendar:events', JSON.stringify(dataset.events));
            }
            if (dataset.character) {
                localStorage.setItem('levelUp:characterLevel', String(dataset.character.level));
                localStorage.setItem('levelUp:transformCount', String(dataset.character.transformCount));
                localStorage.setItem('levelUp:exerciseResetAt', dataset.character.exerciseResetAt);
            }

            // Show summary
            var summary = window.SeedInjector.printDataSummary();
            showDataSummary(summary);
            showStatus('Seed data injected (seed=' + seed + ')', 'success');
            console.log('Seed data injected with seed=' + seed);
        });

        /* ===== Run Tests ===== */
        btnTest.addEventListener('click', function() {
            resultsEl.innerHTML = '';
            dataSummaryEl.classList.remove('show');

            var result = window.TestFramework.runAllSuites();

            // Show summary bar
            summaryBar.classList.add('show');
            document.getElementById('sumPassed').textContent = result.passed + ' passed';
            document.getElementById('sumFailed').textContent = result.failed + ' failed';
            document.getElementById('sumTotal').textContent = result.total + ' total';

            // Render result cards grouped by suite
            var currentSuite = '';
            window.TestResults.forEach(function(r) {
                if (r.suite !== currentSuite) {
                    currentSuite = r.suite;
                    var header = document.createElement('div');
                    header.className = 'suite-header';
                    header.textContent = r.suite;
                    resultsEl.appendChild(header);
                }

                var card = document.createElement('div');
                card.className = 'result-card ' + r.status;

                var nameDiv = document.createElement('div');
                nameDiv.className = 'name';
                nameDiv.textContent = r.test;

                var badge = document.createElement('span');
                badge.className = 'badge';
                badge.textContent = r.status.toUpperCase();

                card.appendChild(nameDiv);
                card.appendChild(badge);

                if (r.error) {
                    var errDiv = document.createElement('div');
                    errDiv.className = 'error-msg';
                    errDiv.textContent = r.error;
                    nameDiv.appendChild(errDiv);
                }

                resultsEl.appendChild(card);
            });

            if (result.failed === 0) {
                showStatus('All ' + result.total + ' tests passed!', 'success');
            } else {
                showStatus(result.failed + ' test(s) failed', 'error');
            }
        });

        /* ===== Clear Data ===== */
        btnClear.addEventListener('click', function() {
            var count = window.SeedInjector.clearAllData();
            if (count !== false) {
                showStatus('Cleared ' + count + ' app keys', 'success');
                summaryBar.classList.remove('show');
                resultsEl.innerHTML = '';
                dataSummaryEl.classList.remove('show');
            }
        });

        /* ===== Data Summary ===== */
        btnSummary.addEventListener('click', function() {
            var summary = window.SeedInjector.printDataSummary();
            showDataSummary(summary);
        });

        function showDataSummary(summary) {
            dataSummaryBody.innerHTML = '';
            Object.keys(summary).forEach(function(key) {
                var tr = document.createElement('tr');
                var tdKey = document.createElement('td');
                tdKey.textContent = key;
                var tdVal = document.createElement('td');
                tdVal.textContent = summary[key];
                tr.appendChild(tdKey);
                tr.appendChild(tdVal);
                dataSummaryBody.appendChild(tr);
            });
            dataSummaryEl.classList.add('show');
        }
    })();
    </script>
</body>
</html>
