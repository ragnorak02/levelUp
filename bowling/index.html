<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bowling â€” League Tracker</title>
<style>
  :root{
    --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7;
    --accent:#a855f7; --accent2:#c084fc;
    --gold:#d4a843; --goldDim:rgba(212,168,67,.35);
    --ring:#2a3543; --good:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box; margin:0; padding:0;}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    background:
      radial-gradient(1200px 800px at 50% -200px, rgba(168,85,247,.15), transparent 55%),
      radial-gradient(900px 700px at 10% 0%, rgba(192,132,252,.08), transparent 60%),
      var(--bg);
    color:var(--ink);
    padding-bottom:80px;
  }
  a{color:inherit; text-decoration:none}
  button{font-family:inherit; border:none; background:none; color:inherit; cursor:pointer;}

  .topbar{
    position:sticky; top:0; z-index:20;
    background: linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.75));
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--ring);
  }
  .topbar-inner{
    max-width:700px; margin:0 auto;
    padding:8px 10px;
    display:flex; align-items:center; gap:10px;
  }
  .brand-group{display:flex; align-items:center; gap:8px; flex:0 0 auto;}
  .brand{
    display:inline-flex; align-items:center; gap:6px;
    font-weight:900;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--ring);
    background: rgba(19,26,34,.55);
    box-shadow: var(--shadow);
    white-space:nowrap;
    font-size:13px;
  }
  .brand.active{
    color:#0b0f14;
    background: linear-gradient(135deg, rgba(168,85,247,1), rgba(192,132,252,1));
    border-color: transparent;
  }
  .nav{
    margin-left:auto;
    display:flex; gap:8px;
    align-items:center;
  }
  .nav .pill{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--ring);
    background: rgba(19,26,34,.55);
    color:var(--muted);
    font-weight:800;
    font-size:13px;
  }
  .nav .pill.active{
    color:#0b0f14;
    background: linear-gradient(135deg, rgba(168,85,247,1), rgba(192,132,252,1));
    border-color: transparent;
  }

  .wrap{max-width:700px; margin:0 auto; padding:10px; display:flex; flex-direction:column; gap:10px;}

  .card{
    background: var(--card);
    border:1px solid var(--ring);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card-inner{padding:12px;}

  /* Week nav */
  .week-nav{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:10px;
  }
  .week-nav-btn{
    width:32px; height:32px;
    border-radius:10px;
    border:1px solid var(--ring);
    background: rgba(255,255,255,.06);
    color:var(--ink);
    font-weight:900;
    font-size:14px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .week-nav-btn:hover{background: rgba(255,255,255,.10)}
  .week-nav-label{
    font-weight:950;
    font-size:14px;
    min-width:160px;
    text-align:center;
  }

  /* Game slots */
  .games-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:8px;
    margin-bottom:10px;
  }
  .game-slot{
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:12px 10px;
    text-align:center;
    cursor:pointer;
    min-height:80px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  .game-slot:hover{background: rgba(255,255,255,.06)}
  .game-slot.complete{
    border-color: rgba(34,197,94,.35);
    background: rgba(34,197,94,.06);
  }
  .game-slot.active{
    border-color: rgba(168,85,247,.40);
    background: rgba(168,85,247,.08);
  }
  .game-slot .gs-label{font-weight:950; font-size:13px; color:var(--muted);}
  .game-slot .gs-score{font-weight:950; font-size:22px; color:var(--ink);}
  .game-slot.complete .gs-score{color:var(--good)}
  .game-slot .gs-hint{font-size:11px; color:var(--muted); font-weight:800;}

  /* Weekly average */
  .week-avg{
    text-align:center;
    padding:8px;
    border-radius:12px;
    border:1px solid rgba(168,85,247,.25);
    background: rgba(168,85,247,.06);
    font-weight:950;
    font-size:13px;
    color:var(--accent2);
    margin-bottom:10px;
  }

  /* Start game button */
  .start-game-btn{
    display:flex; align-items:center; justify-content:center; gap:8px;
    width:100%; padding:12px;
    border-radius:14px;
    border:1px dashed rgba(168,85,247,.40);
    background: rgba(168,85,247,.06);
    color:var(--accent2);
    font-weight:950;
    font-size:14px;
  }
  .start-game-btn:active{transform: translateY(1px)}
  .start-game-btn:disabled{opacity:.4; cursor:not-allowed;}

  /* ========== Stats Panel ========== */
  .stats-panel{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:8px;
  }
  .stats-panel.compact{
    grid-template-columns: repeat(4, 1fr);
    gap:6px;
  }
  .stat-box{
    padding:10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    text-align:center;
  }
  .stat-box .sv{
    font-weight:950;
    font-size:20px;
    color:var(--ink);
    line-height:1.2;
  }
  .stats-panel.compact .stat-box .sv{font-size:16px;}
  .stat-box .sl{
    font-size:11px;
    font-weight:800;
    color:var(--muted);
    margin-top:2px;
  }
  .stat-box.highlight{
    border-color: rgba(168,85,247,.25);
    background: rgba(168,85,247,.06);
  }
  .stat-box.highlight .sv{color:var(--accent2);}
  .stats-empty{
    text-align:center;
    padding:16px 12px;
    color:var(--muted);
    font-weight:800;
    font-size:13px;
    line-height:1.5;
  }
  .stats-title{
    font-weight:950;
    font-size:14px;
    margin-bottom:8px;
    color:var(--ink);
  }

  /* Modal overlay */
  .modal-overlay{
    display:none;
    position:fixed;
    inset:0;
    z-index:50;
    background: rgba(0,0,0,.70);
    backdrop-filter: blur(4px);
    overflow-y:auto;
    padding:20px 10px;
  }
  .modal-overlay.show{display:flex; justify-content:center; align-items:flex-start;}
  .modal{
    width:min(600px, 100%);
    background: var(--card);
    border:1px solid var(--ring);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:16px;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:12px;
  }
  .modal-title{font-weight:950; font-size:16px;}
  .modal-close{
    width:32px; height:32px;
    display:flex; align-items:center; justify-content:center;
    border-radius:10px;
    border:1px solid var(--ring);
    background: rgba(255,255,255,.06);
    font-weight:900;
  }

  /* ========== Bowling Scorecard ========== */
  .scorecard{
    border:2px solid var(--gold);
    border-radius:10px;
    overflow:hidden;
    margin-bottom:12px;
    background: rgba(0,0,0,.25);
  }
  .sc-frames{
    display:flex;
  }
  .sc-frame{
    flex:1;
    min-width:0;
    border-right:1px solid var(--goldDim);
    display:flex;
    flex-direction:column;
  }
  .sc-frame:last-child{border-right:none;}
  .sc-frame.tenth{flex:1.5;}
  .sc-frame-num{
    text-align:center;
    font-size:9px;
    font-weight:900;
    color:var(--gold);
    padding:2px 0;
    border-bottom:1px solid var(--goldDim);
    background: rgba(212,168,67,.08);
  }
  .sc-frame.active .sc-frame-num{
    background: rgba(168,85,247,.25);
    color:var(--accent2);
  }
  .sc-shots-row{
    display:flex;
    border-bottom:1px solid var(--goldDim);
    min-height:22px;
  }
  .sc-shot-box{
    flex:1;
    text-align:center;
    font-weight:950;
    font-size:11px;
    color:var(--ink);
    padding:3px 0;
    border-right:1px solid rgba(212,168,67,.15);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .sc-shot-box:last-child{border-right:none;}
  .sc-shot-box.strike{color:var(--danger);}
  .sc-shot-box.spare{color:var(--accent2);}
  .sc-shot-box.gutter{color:var(--muted);}
  .sc-cumulative{
    text-align:center;
    font-weight:950;
    font-size:13px;
    color:var(--ink);
    padding:4px 0;
    min-height:24px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .sc-frame.active .sc-cumulative{
    color:var(--accent2);
  }

  /* Score + frame/ball indicator */
  .score-indicator{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:16px;
    margin-bottom:14px;
  }
  .si-score{font-weight:950; font-size:20px;}
  .si-frame-ball{font-weight:900; font-size:16px; color:var(--muted);}
  .si-frame-ball b{color:var(--ink);}

  /* Pin diagram */
  .pin-diagram{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    margin:16px 0;
  }
  .pin-row{display:flex; gap:10px; justify-content:center;}
  .pin{
    width:48px; height:48px;
    border-radius:50%;
    border:2px solid var(--goldDim);
    background: rgba(30,30,30,.90);
    color:var(--muted);
    font-weight:950;
    font-size:15px;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: all .15s ease;
    user-select:none;
  }
  .pin.standing{
    border-color: var(--gold);
    background: rgba(212,168,67,.12);
    color:var(--gold);
    box-shadow: 0 0 10px rgba(212,168,67,.20);
  }
  .pin.knocked{
    opacity:.20;
    border-color: rgba(255,255,255,.08);
    background: rgba(20,20,20,.60);
    color: rgba(255,255,255,.20);
    cursor:default;
  }

  /* Shot entry inputs */
  .input-group{
    display:flex;
    gap:8px;
    margin-bottom:8px;
  }
  .input-col{flex:1;}
  .input-col label{
    display:block;
    font-weight:900;
    font-size:11px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .input-col input{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid var(--ring);
    background: rgba(255,255,255,.06);
    color:var(--ink);
    font-weight:900;
    font-size:14px;
    outline:none;
    text-align:center;
    font-family:inherit;
  }
  .input-col input:focus{border-color: rgba(168,85,247,.55);}

  /* Shot actions */
  .shot-actions{
    display:flex;
    gap:8px;
    margin-top:14px;
  }
  .strike-btn{
    padding:10px 18px;
    border-radius:12px;
    border:2px solid var(--goldDim);
    background: rgba(212,168,67,.08);
    color:var(--gold);
    font-weight:950;
    font-size:13px;
  }
  .strike-btn:hover{background: rgba(212,168,67,.15)}
  .strike-btn:active{transform: translateY(1px)}
  .spare-btn{
    padding:10px 18px;
    border-radius:12px;
    border:2px solid rgba(168,85,247,.35);
    background: rgba(168,85,247,.08);
    color:var(--accent2);
    font-weight:950;
    font-size:13px;
  }
  .spare-btn:hover{background: rgba(168,85,247,.15)}
  .spare-btn:active{transform: translateY(1px)}
  .shot-btn{
    padding:10px 18px;
    border-radius:12px;
    border:2px solid var(--ring);
    background: rgba(255,255,255,.06);
    color:var(--ink);
    font-weight:950;
    font-size:13px;
  }
  .shot-btn:hover{background: rgba(255,255,255,.10)}
  .shot-btn:active{transform: translateY(1px)}
  .record-btn{
    flex:1;
    padding:10px 16px;
    border-radius:12px;
    background: linear-gradient(135deg, rgba(168,85,247,1), rgba(192,132,252,1));
    color:#0b0f14;
    font-weight:950;
    font-size:13px;
    text-align:center;
  }
  .record-btn:active{transform: translateY(1px)}

  /* Status text */
  .shot-status{
    text-align:center;
    margin-top:10px;
    font-size:13px;
    font-weight:800;
    color:var(--muted);
  }
  .shot-status b{color:var(--ink);}

  /* Game complete */
  .game-complete{
    text-align:center;
    padding:20px;
  }
  .game-complete .final-score{
    font-size:48px;
    font-weight:950;
    color:var(--good);
    margin:10px 0;
  }
  .game-complete .final-label{
    color:var(--muted);
    font-weight:800;
    font-size:13px;
  }
  .done-btn{
    display:inline-flex;
    padding:10px 24px;
    border-radius:12px;
    background: linear-gradient(135deg, rgba(34,197,94,1), rgba(45,212,191,1));
    color:#0b0f14;
    font-weight:950;
    font-size:14px;
    margin-top:12px;
  }
  .done-btn:active{transform: translateY(1px)}

  @media (max-width: 480px){
    .games-grid{gap:6px;}
    .pin{width:42px; height:42px; font-size:13px;}
    .pin-row{gap:8px;}
    .sc-frame-num{font-size:8px;}
    .sc-shot-box{font-size:10px;}
    .sc-cumulative{font-size:11px;}
    .stats-panel{grid-template-columns: repeat(2, 1fr);}
    .stats-panel.compact{grid-template-columns: repeat(2, 1fr);}
  }
  @media (max-width: 360px){
    .pin{width:36px; height:36px; font-size:12px;}
    .pin-row{gap:6px;}
  }
</style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand-group">
        <a href="../main.html" class="brand">Home</a>
        <span class="brand active">ðŸŽ³ Bowling</span>
      </div>
      <div class="nav">
        <span class="pill active">Games</span>
      </div>
    </div>
  </div>

  <main class="wrap">
    <!-- Week navigation -->
    <div class="week-nav">
      <button class="week-nav-btn" id="weekPrev" type="button" title="Previous week">â—€</button>
      <div class="week-nav-label" id="weekLabel">Week</div>
      <button class="week-nav-btn" id="weekNext" type="button" title="Next week">â–¶</button>
    </div>

    <!-- Week summary -->
    <div class="card">
      <div class="card-inner">
        <div class="games-grid" id="gamesGrid"></div>

        <div class="week-avg" id="weekAvg" style="display:none;">
          Avg: <span id="weekAvgVal">â€”</span>
        </div>

        <button class="start-game-btn" id="startGameBtn" type="button">+ Start Game</button>
      </div>
    </div>

    <!-- Stats panel -->
    <div class="card" id="statsCard">
      <div class="card-inner">
        <div class="stats-title" id="statsTitle">Career Stats</div>
        <div id="statsBody"></div>
      </div>
    </div>
  </main>

  <!-- Game logging modal -->
  <div class="modal-overlay" id="gameModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Game 1</div>
        <button class="modal-close" id="modalClose" type="button">âœ•</button>
      </div>

      <!-- Bowling scorecard -->
      <div class="scorecard" id="scorecard"></div>

      <!-- Score + Frame/Ball indicator -->
      <div class="score-indicator">
        <div class="si-score">Score: <b id="siScoreVal">0</b></div>
        <div class="si-frame-ball">Frame <b id="siFrame">1</b> &nbsp; Ball <b id="siBall">1</b></div>
      </div>

      <!-- Shot entry area -->
      <div id="shotArea">
        <div class="input-group">
          <div class="input-col">
            <label>Standing Position</label>
            <input type="number" id="standingPos" min="1" max="39" placeholder="20" />
          </div>
          <div class="input-col">
            <label>Target Board</label>
            <input type="number" id="targetBoard" min="1" max="39" placeholder="15" />
          </div>
        </div>

        <div class="pin-diagram" id="pinDiagram"></div>

        <div class="shot-actions">
          <button class="strike-btn" id="strikeBtn" type="button">Strike</button>
          <button class="spare-btn" id="spareBtn" type="button">Spare</button>
          <button class="shot-btn" id="shotBtn" type="button">Shot</button>
          <button class="record-btn" id="recordBtn" type="button">Record â†’</button>
        </div>

        <div class="shot-status" id="shotStatus"></div>
      </div>

      <!-- Game complete view -->
      <div class="game-complete" id="gameComplete" style="display:none;">
        <div class="final-label">Final Score</div>
        <div class="final-score" id="finalScore">0</div>
        <button class="done-btn" id="doneBtn" type="button">Done</button>
      </div>
    </div>
  </div>

<script>
'use strict';

/* --------------------------------
   Utilities
----------------------------------*/
const $ = (id) => document.getElementById(id);

function safeParse(key){
    try { return JSON.parse(localStorage.getItem(key)); }
    catch { return null; }
}

/* --------------------------------
   ISO Week helpers
----------------------------------*/
function getISOWeek(date){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
}

function weekIdToLabel(weekId){
    const match = weekId.match(/^(\d{4})-W(\d{2})$/);
    if(!match) return weekId;
    const year = parseInt(match[1]);
    const week = parseInt(match[2]);
    const jan4 = new Date(year, 0, 4);
    const dayOfWeek = jan4.getDay() || 7;
    const monday = new Date(year, 0, 4 - dayOfWeek + 1 + (week - 1) * 7);
    const tuesday = new Date(monday);
    tuesday.setDate(monday.getDate() + 1);
    return 'Tue, ' + tuesday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function offsetWeek(weekId, offset){
    const match = weekId.match(/^(\d{4})-W(\d{2})$/);
    if(!match) return weekId;
    const year = parseInt(match[1]);
    const week = parseInt(match[2]);
    const jan4 = new Date(year, 0, 4);
    const dayOfWeek = jan4.getDay() || 7;
    const monday = new Date(year, 0, 4 - dayOfWeek + 1 + (week - 1) * 7);
    monday.setDate(monday.getDate() + offset * 7);
    return getISOWeek(monday);
}

/* --------------------------------
   Data Layer
----------------------------------*/
const STORAGE_PREFIX = 'bowling:week:';

let state = {
    weekId: getISOWeek(new Date()),
    currentGame: null,
    currentFrame: 0,
    currentShot: 0,
    pinsStanding: [],
    lastStandingPos: null,
    lastTargetBoard: null,
};

function storageKey(weekId){ return STORAGE_PREFIX + weekId; }
function loadWeek(weekId){ return safeParse(storageKey(weekId)); }

function saveWeek(weekData){
    localStorage.setItem(storageKey(weekData.weekId), JSON.stringify(weekData));
}

function ensureWeek(weekId){
    let week = loadWeek(weekId);
    if(!week){
        week = {
            weekId,
            weekLabel: weekIdToLabel(weekId),
            games: [],
            created: new Date().toISOString(),
        };
        saveWeek(week);
    }
    return week;
}

function createEmptyGame(gameNumber){
    const frames = [];
    for(let i = 1; i <= 10; i++){
        frames.push({ frameNumber: i, shots: [] });
    }
    return {
        id: 'game_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6),
        gameNumber,
        frames,
        score: null,
        completedDate: null,
    };
}

/* --------------------------------
   All-time data access
----------------------------------*/
function listAllWeekKeys(){
    const keys = [];
    for(let i = 0; i < localStorage.length; i++){
        const k = localStorage.key(i);
        if(k && k.startsWith(STORAGE_PREFIX)) keys.push(k);
    }
    return keys;
}

function getAllCompletedGames(){
    const games = [];
    listAllWeekKeys().forEach(k => {
        const week = safeParse(k);
        if(!week || !Array.isArray(week.games)) return;
        week.games.forEach(g => {
            if(g.score != null) games.push({ ...g, weekId: week.weekId });
        });
    });
    return games;
}

/* --------------------------------
   Stats calculation
----------------------------------*/
function computeStats(games){
    if(!games.length) return null;

    const scores = games.map(g => g.score);
    const total = scores.reduce((s, v) => s + v, 0);
    const avg = Math.round(total / scores.length);
    const high = Math.max(...scores);
    const low = Math.min(...scores);

    // First-ball stats: analyze frame-by-frame
    let totalFirstBalls = 0;
    let strikes = 0;
    let spares = 0;
    let splits = 0;
    let opens = 0;
    let pinCounts = {};  // pinsLeft count after first ball
    let totalPinsFirstBall = 0;

    games.forEach(g => {
        if(!g.frames) return;
        g.frames.forEach((frame, fi) => {
            if(!frame.shots || !frame.shots.length) return;
            const shot1 = frame.shots[0];
            const knocked = 10 - (shot1.pinsLeft ? shot1.pinsLeft.length : 0);
            totalFirstBalls++;
            totalPinsFirstBall += knocked;

            if(knocked === 10){
                strikes++;
            } else {
                const left = shot1.pinsLeft ? shot1.pinsLeft.length : (10 - knocked);
                const key = String(left);
                pinCounts[key] = (pinCounts[key] || 0) + 1;

                // Detect splits: pin 1 (headpin) down + non-adjacent pins remaining
                if(shot1.pinsLeft && !shot1.pinsLeft.includes(1) && shot1.pinsLeft.length >= 2){
                    splits++;
                }

                // Spare or open (check second shot)
                if(frame.shots.length >= 2){
                    const shot2 = frame.shots[1];
                    const knocked2 = 10 - (shot2.pinsLeft ? shot2.pinsLeft.length : 0);
                    if(fi < 9){
                        if(knocked + knocked2 === 10) spares++;
                        else opens++;
                    } else {
                        // 10th frame: first two shots
                        if(knocked + knocked2 >= 10) spares++;
                        else opens++;
                    }
                }
            }
        });
    });

    const strikeRate = totalFirstBalls > 0 ? Math.round((strikes / totalFirstBalls) * 100) : 0;
    const spareRate = (totalFirstBalls - strikes) > 0 ? Math.round((spares / (totalFirstBalls - strikes)) * 100) : 0;
    const avgFirstBall = totalFirstBalls > 0 ? (totalPinsFirstBall / totalFirstBalls).toFixed(1) : '0';
    const splitsPerGame = games.length > 0 ? (splits / games.length).toFixed(1) : '0';

    // 3-game averages (group sequential games into sets of 3)
    let seriesScores = [];
    // Group by week
    const byWeek = {};
    games.forEach(g => {
        const wk = g.weekId || 'unknown';
        if(!byWeek[wk]) byWeek[wk] = [];
        byWeek[wk].push(g.score);
    });
    Object.values(byWeek).forEach(weekScores => {
        if(weekScores.length === 3){
            seriesScores.push(weekScores[0] + weekScores[1] + weekScores[2]);
        }
    });
    const avgSeries = seriesScores.length > 0 ? Math.round(seriesScores.reduce((s, v) => s + v, 0) / seriesScores.length) : null;
    const highSeries = seriesScores.length > 0 ? Math.max(...seriesScores) : null;

    // Pin-leave distribution (top entries)
    const pinLeaves = Object.entries(pinCounts)
        .map(([pins, count]) => ({ pins: parseInt(pins), count }))
        .sort((a, b) => b.count - a.count);

    return {
        games: games.length,
        avg, high, low,
        strikeRate, spareRate,
        avgFirstBall, splitsPerGame,
        avgSeries, highSeries,
        pinLeaves,
        opens,
    };
}

/* --------------------------------
   Scoring
----------------------------------*/
function pinsKnockedInShot(shot){
    return 10 - (shot.pinsLeft ? shot.pinsLeft.length : 0);
}

function calculateGameScore(frames){
    const scores = new Array(10).fill(null);
    const allShots = [];
    frames.forEach(f => {
        f.shots.forEach(s => allShots.push(pinsKnockedInShot(s)));
    });

    let shotIndex = 0;
    let cumulative = 0;

    for(let f = 0; f < 10; f++){
        const frame = frames[f];
        if(!frame.shots.length) break;

        if(f < 9){
            const shot1 = allShots[shotIndex];
            if(shot1 === undefined) break;

            if(shot1 === 10){
                const next1 = allShots[shotIndex + 1];
                const next2 = allShots[shotIndex + 2];
                if(next1 === undefined || next2 === undefined){
                    scores[f] = null;
                    shotIndex += 1;
                    continue;
                }
                cumulative += 10 + next1 + next2;
                scores[f] = cumulative;
                shotIndex += 1;
            } else {
                const shot2 = allShots[shotIndex + 1];
                if(shot2 === undefined) break;

                if(shot1 + shot2 === 10){
                    const next1 = allShots[shotIndex + 2];
                    if(next1 === undefined){
                        scores[f] = null;
                        shotIndex += 2;
                        continue;
                    }
                    cumulative += 10 + next1;
                    scores[f] = cumulative;
                } else {
                    cumulative += shot1 + shot2;
                    scores[f] = cumulative;
                }
                shotIndex += 2;
            }
        } else {
            let frameTotal = 0;
            for(let s = 0; s < frame.shots.length; s++){
                frameTotal += allShots[shotIndex + s] || 0;
            }
            if(isFrameComplete(frame, 9)){
                cumulative += frameTotal;
                scores[f] = cumulative;
            }
            shotIndex += frame.shots.length;
        }
    }
    return scores;
}

function isFrameComplete(frame, frameIndex){
    if(frameIndex < 9){
        if(frame.shots.length === 0) return false;
        if(pinsKnockedInShot(frame.shots[0]) === 10) return true;
        return frame.shots.length >= 2;
    } else {
        if(frame.shots.length < 2) return false;
        const s1 = pinsKnockedInShot(frame.shots[0]);
        const s2 = pinsKnockedInShot(frame.shots[1]);
        if(s1 === 10 || s1 + s2 === 10) return frame.shots.length >= 3;
        return true;
    }
}

function isGameComplete(game){
    return isFrameComplete(game.frames[9], 9);
}

function getFinalScore(game){
    return calculateGameScore(game.frames)[9];
}

function getRunningScore(game){
    const scores = calculateGameScore(game.frames);
    for(let f = 9; f >= 0; f--){
        if(scores[f] != null) return scores[f];
    }
    return 0;
}

/* --------------------------------
   Shot display helpers
----------------------------------*/
function shotDisplay(frame, shotIdx, frameIdx){
    if(!frame.shots[shotIdx]) return '';
    const knocked = pinsKnockedInShot(frame.shots[shotIdx]);

    if(frameIdx < 9){
        if(shotIdx === 0){
            if(knocked === 10) return 'X';
            if(knocked === 0) return '-';
            return String(knocked);
        }
        if(shotIdx === 1){
            const first = pinsKnockedInShot(frame.shots[0]);
            if(first + knocked === 10) return '/';
            if(knocked === 0) return '-';
            return String(knocked);
        }
    } else {
        if(shotIdx === 0){
            if(knocked === 10) return 'X';
            if(knocked === 0) return '-';
            return String(knocked);
        }
        if(shotIdx === 1){
            const s1 = pinsKnockedInShot(frame.shots[0]);
            if(s1 === 10){
                if(knocked === 10) return 'X';
                if(knocked === 0) return '-';
                return String(knocked);
            }
            if(s1 + knocked === 10) return '/';
            if(knocked === 0) return '-';
            return String(knocked);
        }
        if(shotIdx === 2){
            const s1 = pinsKnockedInShot(frame.shots[0]);
            const s2 = pinsKnockedInShot(frame.shots[1]);
            if(s1 === 10 && s2 === 10){
                if(knocked === 10) return 'X';
            } else if(s1 === 10){
                if(s2 + knocked === 10) return '/';
            } else if(s1 + s2 === 10){
                if(knocked === 10) return 'X';
            }
            if(knocked === 0) return '-';
            return String(knocked);
        }
    }
    return '';
}

function shotBoxClass(display){
    if(display === 'X') return 'strike';
    if(display === '/') return 'spare';
    if(display === '-') return 'gutter';
    return '';
}

/* --------------------------------
   Pin Management
----------------------------------*/
function getAllPins(){ return [1,2,3,4,5,6,7,8,9,10]; }

function getAvailablePins(frame, frameIndex){
    if(frame.shots.length === 0) return getAllPins();

    if(frameIndex < 9){
        if(frame.shots.length === 1){
            return frame.shots[0].pinsLeft ? [...frame.shots[0].pinsLeft] : [];
        }
        return [];
    } else {
        const shotCount = frame.shots.length;
        if(shotCount === 0) return getAllPins();

        const s1 = pinsKnockedInShot(frame.shots[0]);

        if(shotCount === 1){
            if(s1 === 10) return getAllPins();
            return frame.shots[0].pinsLeft ? [...frame.shots[0].pinsLeft] : [];
        }

        if(shotCount === 2){
            const s2 = pinsKnockedInShot(frame.shots[1]);
            if(s1 === 10 && s2 === 10) return getAllPins();
            if(s1 === 10){
                if(frame.shots[1].pinsLeft && frame.shots[1].pinsLeft.length === 0) return getAllPins();
                return frame.shots[1].pinsLeft ? [...frame.shots[1].pinsLeft] : [];
            }
            if(s1 + s2 === 10) return getAllPins();
            return [];
        }
        return [];
    }
}

/* --------------------------------
   Rendering â€” Week View
----------------------------------*/
function renderAll(){
    const week = ensureWeek(state.weekId);
    const label = $('weekLabel');
    if(label) label.textContent = weekIdToLabel(state.weekId);
    renderGameSlots(week);
    renderWeekAvg(week);
    renderStartButton(week);
    renderStats(week);
}

function renderGameSlots(week){
    const grid = $('gamesGrid');
    if(!grid) return;

    let html = '';
    for(let i = 0; i < 3; i++){
        const game = week.games[i];
        if(!game){
            html += `<div class="game-slot" data-game="${i}">
                <div class="gs-label">Game ${i + 1}</div>
                <div class="gs-hint">Not started</div>
            </div>`;
        } else if(game.score != null){
            html += `<div class="game-slot complete" data-game="${i}">
                <div class="gs-label">Game ${i + 1}</div>
                <div class="gs-score">${game.score}</div>
            </div>`;
        } else {
            html += `<div class="game-slot active" data-game="${i}">
                <div class="gs-label">Game ${i + 1}</div>
                <div class="gs-score">...</div>
                <div class="gs-hint">In progress</div>
            </div>`;
        }
    }
    grid.innerHTML = html;

    grid.querySelectorAll('.game-slot').forEach(slot => {
        const idx = parseInt(slot.dataset.game);
        if(week.games[idx]){
            slot.addEventListener('click', () => openGameModal(idx));
        }
    });
}

function renderWeekAvg(week){
    const avgEl = $('weekAvg');
    const avgVal = $('weekAvgVal');
    if(!avgEl || !avgVal) return;

    const completed = week.games.filter(g => g.score != null);
    if(!completed.length){
        avgEl.style.display = 'none';
        return;
    }
    const sum = completed.reduce((s, g) => s + g.score, 0);
    avgVal.textContent = Math.round(sum / completed.length);
    avgEl.style.display = 'block';
}

function renderStartButton(week){
    const btn = $('startGameBtn');
    if(!btn) return;
    if(week.games.length >= 3){
        btn.disabled = true;
        btn.textContent = 'All 3 games logged';
    } else {
        btn.disabled = false;
        btn.textContent = '+ Start Game ' + (week.games.length + 1);
    }
}

/* --------------------------------
   Stats rendering
----------------------------------*/
function renderStats(week){
    const body = $('statsBody');
    const title = $('statsTitle');
    if(!body) return;

    const allGames = getAllCompletedGames();
    const hasActiveGame = week.games.some(g => g.score == null && g.frames && g.frames.some(f => f.shots.length > 0));

    if(!allGames.length){
        title.textContent = 'Career Stats';
        body.innerHTML = '<div class="stats-empty">No completed games yet.<br>Start a game to begin tracking your stats.</div>';
        return;
    }

    const stats = computeStats(allGames);
    if(!stats) return;

    if(hasActiveGame){
        // Compact view: just the key numbers
        title.textContent = 'Career';
        body.innerHTML = `
            <div class="stats-panel compact">
                <div class="stat-box highlight"><div class="sv">${stats.avg}</div><div class="sl">Average</div></div>
                <div class="stat-box"><div class="sv">${stats.high}</div><div class="sl">High Game</div></div>
                <div class="stat-box"><div class="sv">${stats.strikeRate}%</div><div class="sl">Strikes</div></div>
                <div class="stat-box"><div class="sv">${stats.spareRate}%</div><div class="sl">Spare Conv.</div></div>
            </div>`;
    } else {
        // Full stats view
        title.textContent = 'Career Stats \u2014 ' + stats.games + ' Game' + (stats.games !== 1 ? 's' : '');
        let html = '<div class="stats-panel">';
        html += `<div class="stat-box highlight"><div class="sv">${stats.avg}</div><div class="sl">Average</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.high}</div><div class="sl">High Game</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.low}</div><div class="sl">Low Game</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.strikeRate}%</div><div class="sl">Strike Rate</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.spareRate}%</div><div class="sl">Spare Conversion</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.avgFirstBall}</div><div class="sl">Avg 1st Ball Pins</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.splitsPerGame}</div><div class="sl">Splits / Game</div></div>`;
        html += `<div class="stat-box"><div class="sv">${stats.opens}</div><div class="sl">Total Opens</div></div>`;

        if(stats.avgSeries != null){
            html += `<div class="stat-box highlight"><div class="sv">${stats.avgSeries}</div><div class="sl">Avg 3-Game Series</div></div>`;
            html += `<div class="stat-box"><div class="sv">${stats.highSeries}</div><div class="sl">High Series</div></div>`;
        }

        // Pin leave distribution (top 3)
        if(stats.pinLeaves.length){
            const top = stats.pinLeaves.slice(0, 2);
            top.forEach(pl => {
                html += `<div class="stat-box"><div class="sv">${pl.count}</div><div class="sl">${pl.pins}-Pin Leaves</div></div>`;
            });
        }

        html += '</div>';
        body.innerHTML = html;
    }
}

/* --------------------------------
   Game Modal
----------------------------------*/
function openGameModal(gameIndex){
    const week = ensureWeek(state.weekId);
    const game = week.games[gameIndex];
    if(!game) return;

    state.currentGame = gameIndex;

    if(isGameComplete(game)){
        state.currentFrame = 9;
        state.currentShot = game.frames[9].shots.length;
    } else {
        for(let f = 0; f < 10; f++){
            if(!isFrameComplete(game.frames[f], f)){
                state.currentFrame = f;
                state.currentShot = game.frames[f].shots.length;
                break;
            }
        }
    }

    state.pinsStanding = getAvailablePins(game.frames[state.currentFrame], state.currentFrame);

    // Load stand/aim defaults from last recorded shot in this game
    state.lastStandingPos = null;
    state.lastTargetBoard = null;
    for(let f = state.currentFrame; f >= 0; f--){
        const shots = game.frames[f].shots;
        if(shots.length > 0){
            const lastShot = shots[shots.length - 1];
            state.lastStandingPos = lastShot.standingPosition;
            state.lastTargetBoard = lastShot.targetBoard;
            break;
        }
    }

    $('gameModal').classList.add('show');
    $('modalTitle').textContent = 'Game ' + game.gameNumber;
    renderModal(game);
}

function closeModal(){
    $('gameModal').classList.remove('show');
    state.currentGame = null;
    state.lastStandingPos = null;
    state.lastTargetBoard = null;
    renderAll();
}

function renderModal(game){
    renderScorecard(game);
    renderScoreIndicator(game);

    if(isGameComplete(game)){
        $('shotArea').style.display = 'none';
        $('gameComplete').style.display = 'block';
        $('finalScore').textContent = getFinalScore(game) || 0;
    } else {
        $('shotArea').style.display = 'block';
        $('gameComplete').style.display = 'none';
        renderShotEntry(game);
    }
}

/* --------------------------------
   Scorecard rendering (traditional)
----------------------------------*/
function renderScorecard(game){
    const el = $('scorecard');
    if(!el) return;

    const scores = calculateGameScore(game.frames);
    let html = '<div class="sc-frames">';

    for(let f = 0; f < 10; f++){
        const frame = game.frames[f];
        const isActive = f === state.currentFrame && !isGameComplete(game);
        const cls = isActive ? 'sc-frame active' : 'sc-frame';
        const tenthCls = f === 9 ? ' tenth' : '';

        html += `<div class="${cls}${tenthCls}">`;
        html += `<div class="sc-frame-num">${f + 1}</div>`;
        html += '<div class="sc-shots-row">';

        if(f < 9){
            const s1 = shotDisplay(frame, 0, f);
            const s2 = shotDisplay(frame, 1, f);
            if(s1 === 'X'){
                html += '<div class="sc-shot-box"></div>';
                html += '<div class="sc-shot-box strike">X</div>';
            } else {
                html += `<div class="sc-shot-box ${shotBoxClass(s1)}">${s1}</div>`;
                html += `<div class="sc-shot-box ${shotBoxClass(s2)}">${s2}</div>`;
            }
        } else {
            const s1 = shotDisplay(frame, 0, f);
            const s2 = shotDisplay(frame, 1, f);
            const s3 = shotDisplay(frame, 2, f);
            html += `<div class="sc-shot-box ${shotBoxClass(s1)}">${s1}</div>`;
            html += `<div class="sc-shot-box ${shotBoxClass(s2)}">${s2}</div>`;
            html += `<div class="sc-shot-box ${shotBoxClass(s3)}">${s3}</div>`;
        }

        html += '</div>';
        html += `<div class="sc-cumulative">${scores[f] != null ? scores[f] : ''}</div>`;
        html += '</div>';
    }

    html += '</div>';
    el.innerHTML = html;
}

function renderScoreIndicator(game){
    const running = getRunningScore(game);
    $('siScoreVal').textContent = running;

    if(isGameComplete(game)){
        $('siFrame').textContent = '10';
        $('siBall').textContent = 'Done';
    } else {
        $('siFrame').textContent = state.currentFrame + 1;
        const frame = game.frames[state.currentFrame];
        $('siBall').textContent = frame.shots.length + 1;
    }
}

/* --------------------------------
   Shot Entry + Pin Diagram
----------------------------------*/
function renderShotEntry(game){
    const frame = game.frames[state.currentFrame];
    state.pinsStanding = getAvailablePins(frame, state.currentFrame);
    renderPinDiagram(state.pinsStanding);

    // Pre-fill with previous shot's values (defaults persist across shots)
    $('standingPos').value = state.lastStandingPos != null ? state.lastStandingPos : '';
    $('targetBoard').value = state.lastTargetBoard != null ? state.lastTargetBoard : '';

    // Strike shows on ball 1 (all 10), Spare shows on ball 2 (fewer pins)
    const allTen = state.pinsStanding.length === 10;
    $('strikeBtn').style.display = allTen ? 'block' : 'none';
    $('spareBtn').style.display = allTen ? 'none' : 'block';
    $('shotBtn').style.display = 'block';

    const ballNum = frame.shots.length + 1;
    if(ballNum === 1){
        $('shotStatus').innerHTML = 'Tap pins that are <b>still standing</b> after your throw';
    } else {
        $('shotStatus').innerHTML = `${state.pinsStanding.length} pin${state.pinsStanding.length !== 1 ? 's' : ''} remaining`;
    }
}

function renderPinDiagram(available){
    const diagram = $('pinDiagram');
    if(!diagram) return;

    const rows = [
        [7, 8, 9, 10],
        [4, 5, 6],
        [2, 3],
        [1],
    ];

    let html = '';
    rows.forEach(row => {
        html += '<div class="pin-row">';
        row.forEach(pin => {
            if(available.includes(pin)){
                const standing = state.pinsStanding.includes(pin);
                html += `<button class="pin ${standing ? 'standing' : ''}" data-pin="${pin}" type="button">${pin}</button>`;
            } else {
                html += `<button class="pin knocked" data-pin="${pin}" type="button" disabled>${pin}</button>`;
            }
        });
        html += '</div>';
    });
    diagram.innerHTML = html;

    diagram.querySelectorAll('.pin:not(.knocked)').forEach(btn => {
        btn.addEventListener('click', () => {
            const pin = parseInt(btn.dataset.pin);
            const idx = state.pinsStanding.indexOf(pin);
            if(idx >= 0){
                state.pinsStanding.splice(idx, 1);
                btn.classList.remove('standing');
            } else {
                state.pinsStanding.push(pin);
                btn.classList.add('standing');
            }
            const totalKnocked = available.length - state.pinsStanding.length;
            $('shotStatus').innerHTML = `<b>${totalKnocked}</b> pin${totalKnocked !== 1 ? 's' : ''} knocked down`;
        });
    });
}

/* --------------------------------
   Recording shots
----------------------------------*/
function recordShot(){
    const week = ensureWeek(state.weekId);
    const game = week.games[state.currentGame];
    if(!game || isGameComplete(game)) return;

    const frame = game.frames[state.currentFrame];
    const standingPos = parseInt($('standingPos').value) || null;
    const targetBoard = parseInt($('targetBoard').value) || null;

    // Persist defaults for next shot pre-fill
    state.lastStandingPos = standingPos;
    state.lastTargetBoard = targetBoard;

    frame.shots.push({
        standingPosition: standingPos,
        targetBoard: targetBoard,
        pinsLeft: [...state.pinsStanding].sort((a, b) => a - b),
    });

    if(isFrameComplete(frame, state.currentFrame)){
        if(state.currentFrame < 9){
            state.currentFrame++;
            state.currentShot = 0;
        } else {
            game.score = getFinalScore(game);
            game.completedDate = new Date().toISOString().slice(0, 10);
        }
    } else {
        state.currentShot = frame.shots.length;
    }

    saveWeek(week);
    renderModal(game);
}

function handleStrike(){
    state.pinsStanding = [];
    recordShot();
}

function handleSpare(){
    state.pinsStanding = [];
    recordShot();
}

function handleShot(){
    const week = ensureWeek(state.weekId);
    const game = week.games[state.currentGame];
    if(!game || isGameComplete(game)) return;

    const frame = game.frames[state.currentFrame];
    const available = getAvailablePins(frame, state.currentFrame);

    // All pins knocked down by default â€” user toggles back the leave
    state.pinsStanding = [];
    renderPinDiagram(available);
    $('shotStatus').innerHTML = 'Tap pins that are <b>still standing</b>';
}

function startNewGame(){
    const week = ensureWeek(state.weekId);
    if(week.games.length >= 3) return;

    const game = createEmptyGame(week.games.length + 1);
    week.games.push(game);
    saveWeek(week);
    openGameModal(week.games.length - 1);
}

/* --------------------------------
   Event Bindings
----------------------------------*/
function bindEvents(){
    $('weekPrev').onclick = function(){
        state.weekId = offsetWeek(state.weekId, -1);
        renderAll();
    };
    $('weekNext').onclick = function(){
        state.weekId = offsetWeek(state.weekId, 1);
        renderAll();
    };

    $('startGameBtn').onclick = startNewGame;
    $('modalClose').onclick = closeModal;
    $('gameModal').onclick = function(e){
        if(e.target === $('gameModal')) closeModal();
    };
    $('recordBtn').onclick = recordShot;
    $('strikeBtn').onclick = handleStrike;
    $('spareBtn').onclick = handleSpare;
    $('shotBtn').onclick = handleShot;
    $('doneBtn').onclick = closeModal;
}

/* --------------------------------
   Init
----------------------------------*/
(function init(){
    bindEvents();
    renderAll();
})();
</script>
</body>
</html>
