<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finances Dashboard</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7; --accent:#4CAF50; --accent-2:#2dd4bf;
      --ring:#2a3543; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 50% -200px, rgba(76,175,80,.20), transparent 55%),
                  radial-gradient(900px 700px at 10% 0%, rgba(45,212,191,.12), transparent 60%),
                  var(--bg);
      color:var(--ink);
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1120px; margin:0 auto; padding:16px}
    .topbar{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.72));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(42,53,67,.55);
    }
    .topbar-inner{max-width:1120px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px}
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px;
      padding:8px 12px; border-radius:999px; border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      box-shadow: var(--shadow);
    }
    .nav{
      margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      color:var(--muted);
      font-weight:600;
    }
    .pill.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    .grid{
      margin-top:16px;
      display:grid; gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width:860px){
      .grid{grid-template-columns: 1.35fr .85fr}
    }

    .card{
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(42,53,67,.55);
    }
    .card-h h3{
      margin:0; font-size:14px; letter-spacing:.2px; color:var(--muted);
      display:flex; align-items:center; gap:8px;
      text-transform:none;
    }
    .card-b{padding:14px 16px}

    .stats{
      display:grid; gap:12px; grid-template-columns: repeat(2, 1fr);
    }
    @media(min-width:860px){
      .stats{grid-template-columns: repeat(4, 1fr)}
    }
    .stat{
      padding:12px 14px;
      background: rgba(11,15,20,.35);
      border:1px solid rgba(42,53,67,.55);
      border-radius: 14px;
      text-align:center;
    }
    .stat .v{font-size:26px; font-weight:900; color:var(--good); line-height:1.1}
    .stat .k{font-size:12px; color:var(--muted); margin-top:4px; font-weight:600}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
      color:#0b0f14;
    }

    .donut-wrap{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    @media(min-width:860px){
      .donut-wrap{grid-template-columns: 1fr}
    }

    .donut-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .donut-sub{
      color:var(--muted); font-size:12px; font-weight:600;
    }
    canvas{max-width:100%; width:100%}

    .legend{
      margin-top:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .legend-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      cursor:pointer;
      user-select:none;
    }
    .legend-left{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: #888;
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .legend-name{font-weight:800}
    .legend-meta{font-size:12px; color:var(--muted); font-weight:700}
    .legend-right{text-align:right}
    .legend-amt{font-weight:900; color:var(--good)}
    .legend-row.selected{
      outline: 2px solid rgba(76,175,80,.55);
      background: rgba(76,175,80,.08);
    }

    .recent{
      display:flex; flex-direction:column; gap:10px;
    }
    .recent-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      gap:10px;
    }
    .recent-left{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .recent-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .recent-sub{font-size:12px; color:var(--muted); font-weight:700}

    .empty{
      color:var(--muted);
      display:flex; align-items:center; justify-content:center;
      padding:26px 10px;
      gap:10px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">üè† <span>Finances</span></div>
      <div class="nav">
        <a class="pill active" href="index.html">Dashboard</a>
        <a class="pill" href="food.html">Food</a>
        <a class="pill" href="search.html">Search</a>
        <a class="pill" href="receipts.html">Receipts</a>
        <a class="pill" href="analytics.html">Analytics</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" style="margin-top:14px;">
      <div class="card-b">
        <div class="stats" id="statsRow">
          <div class="stat"><div class="v" id="statTotal">$0.00</div><div class="k">Total Spent</div></div>
          <div class="stat"><div class="v" id="statMonth">$0.00</div><div class="k">This Month</div></div>
          <div class="stat"><div class="v" id="statWeek">$0.00</div><div class="k">This Week</div></div>
          <div class="stat"><div class="v" id="statAvg">$0.00</div><div class="k">Avg Purchase</div></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <h3>üßæ Spending by Category</h3>
          <div class="actions">
            <a class="btn primary" href="addReceipt.html">üßæ Add Receipt</a>
            <a class="btn" href="food.html">üçé Food Tracking</a>
            <a class="btn" href="search.html">üîé Price Lookup</a>
            <a class="btn" href="budget.html">üí∞ Budgets</a>
          </div>
        </div>
        <div class="card-b">
          <div class="donut-top">
            <div class="donut-sub">Tap a slice or a category row to highlight</div>
            <div class="actions" style="gap:8px;">
              <button class="btn" id="donutResetBtn" type="button">Reset</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <canvas id="donutCanvas" width="620" height="360" aria-label="Spending Donut Chart"></canvas>
          </div>

          <div class="legend" id="donutLegend"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h3>üß† Budget Status</h3>
        </div>
        <div class="card-b">
          <div class="empty">
            üéØ Set up budgets to track your spending goals.
          </div>
          <div style="display:flex; justify-content:center;">
            <a class="btn primary" href="budget.html">Set Budgets</a>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="card-h">
        <h3>üõí Recent Purchases</h3>
      </div>
      <div class="card-b">
        <div class="recent" id="recentPurchases"></div>
      </div>
    </div>
  </div>

  <script src="dataLoader.js"></script>
  <script>
    // ---------- helpers ----------
    const fmtMoney = (n) => `$${(Number(n)||0).toFixed(2)}`;
    const toDate = (d) => (d instanceof Date ? d : new Date(d));
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    function startOfWeekSunday(date){
      const dt = new Date(date);
      dt.setHours(0,0,0,0);
      const day = dt.getDay(); // 0=Sun
      dt.setDate(dt.getDate() - day);
      return dt;
    }

    function endOfWeekSaturday(date){
      const s = startOfWeekSunday(date);
      const e = new Date(s);
      e.setDate(e.getDate()+6);
      e.setHours(23,59,59,999);
      return e;
    }

    function inRange(dt, start, end){
      const t = dt.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    // ---------- donut drawing ----------
    function drawDonut(canvas, categories, opts={}){
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;

      ctx.clearRect(0,0,w,h);

      const total = categories.reduce((a,c)=>a + (c.total||0), 0) || 0;

      const centerX = w/2;
      const centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      // background glow
      ctx.save();
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius*1.35, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(76,175,80,0.06)';
      ctx.fill();
      ctx.restore();

      // draw slices
      let currentAngle = -Math.PI/2;
      categories.forEach((cat, i) => {
        const sliceAngle = total === 0 ? 0 : (cat.total / total) * 2 * Math.PI;
        const isSelected = (opts.selectedIndex === i);

        const outerR = isSelected ? radius * 1.08 : radius;

        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();

        ctx.fillStyle = cat.color;
        ctx.fill();

        // subtle separator
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.stroke();

        currentAngle += sliceAngle;
      });

      // center text
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.65)';
      ctx.shadowBlur = 8;

      ctx.fillStyle = '#e8eef6';
      ctx.font = '900 40px system-ui';
      ctx.fillText(total ? `$${Math.round(total)}` : '$0', centerX, centerY - 6);

      ctx.fillStyle = 'rgba(159,176,199,0.95)';
      ctx.font = '700 14px system-ui';
      ctx.fillText('Total', centerX, centerY + 28);

      // Selected label (above donut)
      if (opts.selectedIndex != null && categories[opts.selectedIndex]) {
        const c = categories[opts.selectedIndex];
        ctx.fillStyle = '#e8eef6';
        ctx.font = '800 18px system-ui';
        ctx.fillText(`${c.name}: ${fmtMoney(c.total)}`, centerX, centerY - (radius + 36));
      }

      ctx.restore();
    }

    function getSliceAtPoint(canvas, categories, x, y){
      const w = canvas.width, h = canvas.height;
      const centerX = w/2, centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      const dx = x - centerX;
      const dy = y - centerY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < innerRadius || dist > radius*1.12) return null;

      let ang = Math.atan2(dy, dx);
      // normalize to start at -pi/2
      ang = ang - (-Math.PI/2);
      if (ang < 0) ang += Math.PI*2;

      const total = categories.reduce((a,c)=>a+(c.total||0),0) || 0;
      let acc = 0;
      for (let i=0;i<categories.length;i++){
        const slice = total === 0 ? 0 : (categories[i].total/total) * Math.PI*2;
        if (ang >= acc && ang < acc + slice) return i;
        acc += slice;
      }
      return null;
    }

    function buildLegend(container, categories, selectedIndex, onPick){
      container.innerHTML = '';
      categories.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'legend-row' + (selectedIndex === idx ? ' selected' : '');

        const left = document.createElement('div');
        left.className = 'legend-left';

        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.background = c.color;

        const nameWrap = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'legend-name';
        name.textContent = c.name;

        const meta = document.createElement('div');
        meta.className = 'legend-meta';
        meta.textContent = `${c.itemsCount} items`;

        nameWrap.appendChild(name);
        nameWrap.appendChild(meta);

        left.appendChild(dot);
        left.appendChild(nameWrap);

        const right = document.createElement('div');
        right.className = 'legend-right';

        const amt = document.createElement('div');
        amt.className = 'legend-amt';
        amt.textContent = fmtMoney(c.total);

        right.appendChild(amt);

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener('click', () => onPick(idx));
        container.appendChild(row);
      });
    }

    // ---------- compute + render ----------
    async function main(){
      // dataLoader.js should provide a loader function; fall back to direct fetch
      let data = null;
      try{
        if (window.loadAllData) {
          data = await window.loadAllData();
        } else if (window.loadReceiptsData) {
          data = await window.loadReceiptsData();
        }
      }catch(e){}

      if (!data) {
        // best effort direct fetch if loader is unavailable
        const r = await fetch('receiptsData.json', {cache:'no-store'});
        data = await r.json();
      }

      const receipts = Array.isArray(data) ? data : (data.receipts || []);
      const now = new Date();

      // totals for stats
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);
      const weekStart = startOfWeekSunday(now);
      const weekEnd = endOfWeekSaturday(now);

      const totalSpent = receipts.reduce((a,r)=>a+(Number(r.total)||0),0);
      const monthSpent = receipts.filter(r => inRange(toDate(r.date), monthStart, monthEnd))
                                .reduce((a,r)=>a+(Number(r.total)||0),0);
      const weekSpent = receipts.filter(r => inRange(toDate(r.date), weekStart, weekEnd))
                               .reduce((a,r)=>a+(Number(r.total)||0),0);
      const avgPurchase = receipts.length ? (totalSpent / receipts.length) : 0;

      document.getElementById('statTotal').textContent = fmtMoney(totalSpent);
      document.getElementById('statMonth').textContent = fmtMoney(monthSpent);
      document.getElementById('statWeek').textContent = fmtMoney(weekSpent);
      document.getElementById('statAvg').textContent = fmtMoney(avgPurchase);

      // category totals (top-level categories on receipts)
      const catMap = new Map();
      receipts.forEach(r => {
        const cat = (r.category || 'Other').trim();
        const prev = catMap.get(cat) || {name:cat, total:0, itemsCount:0};
        prev.total += Number(r.total)||0;
        prev.itemsCount += Array.isArray(r.items) ? r.items.length : (Number(r.itemsCount)||0);
        catMap.set(cat, prev);
      });

      // stable colors
      const palette = [
        '#4CAF50','#22c55e','#2dd4bf','#60a5fa','#a78bfa','#f59e0b','#fb7185','#f97316','#14b8a6','#94a3b8'
      ];
      const cats = Array.from(catMap.values())
        .sort((a,b)=>b.total-a.total)
        .map((c, idx)=>({ ...c, color: palette[idx % palette.length] }));

      // donut setup
      const canvas = document.getElementById('donutCanvas');
      const legend = document.getElementById('donutLegend');

      // ensure crisp on high DPI
      const dpr = Math.max(1, Math.round(window.devicePixelRatio || 1));
      const cssW = canvas.clientWidth || 620;
      const cssH = 360;
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      canvas.style.height = cssH + 'px';
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);

      let selectedIndex = null;

      function redraw(){
        // draw on logical CSS pixels (we scale context)
        const tmp = document.createElement('canvas');
        tmp.width = Math.round(cssW);
        tmp.height = Math.round(cssH);

        // draw into a tmp canvas at CSS pixel size, then drawImage scaled by DPR
        // but since we already scaled the context, just draw using a fake canvas wrapper
        // easiest: temporarily swap width/height usage inside drawDonut by using a proxy
        const proxy = {
          width: Math.round(cssW),
          height: Math.round(cssH),
          getContext: () => ctx
        };
        ctx.clearRect(0,0,cssW,cssH);
        drawDonut(proxy, cats, { selectedIndex });
        buildLegend(legend, cats, selectedIndex, (idx)=>{
          selectedIndex = (selectedIndex === idx) ? null : idx;
          redraw();
        });
      }

      canvas.addEventListener('click', (ev) => {
        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const y = ev.clientY - rect.top;
        const idx = getSliceAtPoint({width:cssW, height:cssH}, cats, x, y);
        if (idx == null) {
          selectedIndex = null;
        } else {
          selectedIndex = (selectedIndex === idx) ? null : idx;
        }
        redraw();
      });

      document.getElementById('donutResetBtn').addEventListener('click', ()=>{
        selectedIndex = null;
        redraw();
      });

      redraw();

      // recent purchases (last 2 weeks)
      const recentWrap = document.getElementById('recentPurchases');
      const twoWeeksAgo = new Date(now);
      twoWeeksAgo.setDate(now.getDate() - 14);

      const recent = receipts
        .filter(r => toDate(r.date) >= twoWeeksAgo)
        .sort((a,b)=> toDate(b.date) - toDate(a.date))
        .slice(0, 12);

      recentWrap.innerHTML = '';
      if (!recent.length){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No purchases in the last 2 weeks.';
        recentWrap.appendChild(empty);
      } else {
        recent.forEach(r=>{
          const row = document.createElement('div');
          row.className = 'recent-item';

          const left = document.createElement('div');
          left.className = 'recent-left';

          const title = document.createElement('div');
          title.className = 'recent-title';
          title.textContent = `${r.store || 'Unknown Store'}`;

          const sub = document.createElement('div');
          sub.className = 'recent-sub';
          const d = toDate(r.date);
          const ds = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
          const count = Array.isArray(r.items) ? r.items.length : (Number(r.itemsCount)||0);
          sub.textContent = `${ds} ‚Ä¢ ${count} items`;

          left.appendChild(title);
          left.appendChild(sub);

          const right = document.createElement('div');
          right.style.fontWeight = '900';
          right.style.color = 'var(--good)';
          right.textContent = fmtMoney(r.total);

          row.appendChild(left);
          row.appendChild(right);

          // click to view receipt page (simple)
          row.addEventListener('click', ()=>{
            try{
              localStorage.setItem('selectedReceiptId', r.id || '');
            }catch(e){}
            window.location.href = 'receipts.html';
          });

          recentWrap.appendChild(row);
        });
      }
    }

    main().catch(err=>{
      console.error(err);
    });
  </script>
</body>
</html>