<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Receipt</title>
  <style>
    :root {
      --bg: #080c11; --panel: #0d131a; --ink: #e8eef6; --muted: #9fb0c7;
      --ring: #1c2a37; --accent: #4CAF50; --accent-2: #2dd4bf; --danger: #ef4444;
      --warn: #f59e0b; --card-bg: #0e141b; --hover-bg: #1a1f26;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      background: linear-gradient(180deg, #070b10 0%, #0a1016 100%); color: var(--ink);
      min-height: 100vh;
    }
    header {
      background: #0b1118; border-bottom: 1px solid var(--ring); padding: 12px 16px;
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
    }
    .home-btn {
      all: unset; cursor: pointer; border: 1px solid var(--ring); padding: .4rem .7rem;
      border-radius: .6rem; font-size: .9rem; color: var(--muted); transition: background 0.2s;
    }
    .home-btn:hover { background: var(--hover-bg); }
    h1 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    .wrap {
      width: min(800px, 100%); margin: 0 auto; padding: 16px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .card {
      background: var(--panel); border: 1px solid var(--ring); border-radius: 14px;
      padding: 20px; box-shadow: 0 8px 30px rgba(0, 0, 0, .25);
    }
    .card h3 { margin: 0 0 16px; font-size: 1rem; color: var(--muted); font-weight: 600; }
    .form-group { margin-bottom: 20px; }
    .form-label {
      display: block; font-weight: 600; color: var(--ink); margin-bottom: 8px; font-size: .9rem;
    }
    .form-input {
      width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--ring);
      border-radius: 10px; color: var(--ink); font-size: 1rem; transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--accent); }
    .form-textarea {
      width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--ring);
      border-radius: 10px; color: var(--ink); font-size: .9rem; font-family: monospace;
      min-height: 200px; resize: vertical;
    }
    .form-textarea:focus { outline: none; border-color: var(--accent); }
    .form-row {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }
    .btn {
      all: unset; cursor: pointer; padding: .8rem 1.2rem; border-radius: 10px;
      font-weight: 600; font-size: 1rem; text-align: center; transition: all 0.2s;
      display: inline-block;
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #22c55e);
      color: #04130a; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); width: 100%;
    }
    .btn-secondary {
      background: var(--card-bg); border: 1px solid var(--ring);
      color: var(--muted); width: 100%;
    }
    .btn:hover { transform: translateY(-2px); }
    .btn-group { display: flex; gap: 12px; margin-top: 20px; }
    .help-text {
      font-size: .85rem; color: var(--muted); margin-top: 6px; line-height: 1.4;
    }
    .example-box {
      background: var(--card-bg); border: 1px solid var(--ring); border-radius: 8px;
      padding: 12px; margin-top: 12px; font-family: monospace; font-size: .85rem;
      color: var(--accent-2); white-space: pre-wrap;
    }
    .alert {
      padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: .9rem;
    }
    .alert-success {
      background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);
      color: var(--accent);
    }
    .alert-error {
      background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }
    @media (max-width: 768px) {
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
  <script src="dataLoader.js"></script>
</head>
<body>
  <header>
    <button class="home-btn" onclick="location.href='index.html'">‚üµ Dashboard</button>
    <h1>Add Receipt</h1>
  </header>

  <main class="wrap">
    <div id="alertContainer"></div>

    <div class="card">
      <h3>üìù Receipt Information</h3>
      
      <form id="receiptForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Store Name</label>
            <input type="text" class="form-input" id="storeName" placeholder="Walmart" required>
          </div>
          <div class="form-group">
            <label class="form-label">Purchase Date</label>
            <input type="date" class="form-input" id="purchaseDate" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Subtotal</label>
            <input type="number" step="0.01" class="form-input" id="subtotal" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">Total</label>
            <input type="number" step="0.01" class="form-input" id="total" placeholder="0.00" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Receipt Text (paste from Walmart app or receipt)</label>
          <textarea class="form-textarea" id="receiptText" placeholder="Paste receipt text here..."></textarea>
          <div class="help-text">
            üí° Paste receipt text and the app will try to match items from the database.
            Or leave blank and manually add items below.
          </div>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-primary" onclick="parseReceipt()">Parse Receipt</button>
          <button type="button" class="btn btn-secondary" onclick="manualEntry()">Manual Entry</button>
        </div>
      </form>
    </div>

    <div class="card" id="itemsSection" style="display: none;">
      <h3>üõí Items</h3>
      <div id="itemsList"></div>
      <button type="button" class="btn btn-secondary" onclick="addItemRow()" style="margin-top: 12px;">+ Add Item</button>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveReceipt()">üíæ Save Receipt</button>
      <button class="btn btn-secondary" onclick="location.href='index.html'">Cancel</button>
    </div>

    <div class="card">
      <h3>‚ÑπÔ∏è How to Add Receipts</h3>
      <div class="help-text">
        <strong>Option 1: Paste Receipt Text</strong><br>
        Copy text from Walmart app or typed receipt and paste above. The app will try to match known items.
      </div>
      <div class="example-box">Example:
BANANAS       000000004011 F      1.49
SF YOGURT     005215900001 F      4.74
STRAWBERRIE   085487700700 F      5.74</div>
      
      <div class="help-text" style="margin-top: 16px;">
        <strong>Option 2: Manual Entry</strong><br>
        Click "Manual Entry" to add items one by one with their prices and categories.
      </div>
    </div>
  </main>

  <script>
    // Set today's date as default
    document.getElementById('purchaseDate').valueAsDate = new Date();

    let currentItems = [];

    function parseReceipt() {
      const text = document.getElementById('receiptText').value;
      if (!text.trim()) {
        showAlert('Please paste receipt text first', 'error');
        return;
      }

      // Simple parsing - extract lines with prices
      const lines = text.split('\n');
      const items = [];
      
      lines.forEach(line => {
        // Look for patterns like: ITEM_NAME   ITEM_CODE   PRICE
        const priceMatch = line.match(/\$?(\d+\.\d{2})\s*$/);
        if (priceMatch) {
          const price = parseFloat(priceMatch[1]);
          const itemText = line.substring(0, line.lastIndexOf(priceMatch[0])).trim();
          
          if (itemText && price > 0) {
            // Try to extract item code
            const codeMatch = itemText.match(/\b(\d{12,14})\b/);
            const itemCode = codeMatch ? codeMatch[1] : '';
            
            // Get item name (everything before code or price)
            let itemName = codeMatch 
              ? itemText.substring(0, itemText.indexOf(codeMatch[0])).trim()
              : itemText;
            
            items.push({
              name: itemName || 'Unknown Item',
              code: itemCode,
              price: price,
              category: 'Groceries',
              matched: false
            });
          }
        }
      });

      if (items.length === 0) {
        showAlert('No items found in receipt text. Try manual entry.', 'error');
        return;
      }

      // Match against database
      const database = getItemDatabase();
      items.forEach(item => {
        const match = matchItem(item, database);
        if (match) {
          item.name = match.name;
          item.category = match.category;
          item.matched = true;
        }
      });

      currentItems = items;
      renderItems();
      showAlert(`Found ${items.length} items (${items.filter(i => i.matched).length} matched from database)`, 'success');
    }

    function matchItem(item, database) {
      // Try to match by item code first
      if (item.code) {
        const match = database.find(db => db.code === item.code);
        if (match) return match;
      }

      // Try to match by name
      const nameLower = item.name.toLowerCase();
      const match = database.find(db => {
        const dbName = db.name.toLowerCase();
        return dbName.includes(nameLower) || nameLower.includes(dbName);
      });

      return match;
    }

    function getItemDatabase() {
      // This will be populated with your item database
      // For now, return empty array
      try {
        const items = JSON.parse(localStorage.getItem('finances:items') || '[]');
        return items;
      } catch (e) {
        return [];
      }
    }

    function manualEntry() {
      currentItems = [];
      addItemRow();
      renderItems();
    }

    function addItemRow() {
      currentItems.push({
        name: '',
        price: 0,
        category: 'Groceries'
      });
      renderItems();
    }

    function renderItems() {
      const section = document.getElementById('itemsSection');
      const list = document.getElementById('itemsList');
      
      section.style.display = 'block';
      list.innerHTML = '';

      currentItems.forEach((item, index) => {
        const row = document.createElement('div');
        row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 12px; margin-bottom: 12px; align-items: center;';
        
        row.innerHTML = `
          <input type="text" class="form-input" placeholder="Item name" value="${item.name}" 
                 onchange="currentItems[${index}].name = this.value" required>
          <input type="number" step="0.01" class="form-input" placeholder="Price" value="${item.price || ''}"
                 onchange="currentItems[${index}].price = parseFloat(this.value)" required>
          <select class="form-input" onchange="currentItems[${index}].category = this.value">
            <option value="Groceries" ${item.category === 'Groceries' ? 'selected' : ''}>üõí Groceries</option>
            <option value="Restaurants" ${item.category === 'Restaurants' ? 'selected' : ''}>üçΩÔ∏è Restaurants</option>
            <option value="Medical" ${item.category === 'Medical' ? 'selected' : ''}>üíä Medical</option>
            <option value="Home" ${item.category === 'Home' ? 'selected' : ''}>üè† Home</option>
            <option value="Rental Property" ${item.category === 'Rental Property' ? 'selected' : ''}>üèòÔ∏è Rental Property</option>
            <option value="Transportation" ${item.category === 'Transportation' ? 'selected' : ''}>üöó Transportation</option>
            <option value="Utilities" ${item.category === 'Utilities' ? 'selected' : ''}>üí° Utilities</option>
            <option value="Other" ${item.category === 'Other' ? 'selected' : ''}>üì¶ Other</option>
          </select>
          <button type="button" class="home-btn" onclick="removeItem(${index})" style="padding: .6rem;">‚úï</button>
        `;
        
        list.appendChild(row);
      });
    }

    function removeItem(index) {
      currentItems.splice(index, 1);
      renderItems();
    }

    function saveReceipt() {
      const store = document.getElementById('storeName').value;
      const date = document.getElementById('purchaseDate').value;
      const total = parseFloat(document.getElementById('total').value);

      if (!store || !date || !total) {
        showAlert('Please fill in store, date, and total', 'error');
        return;
      }

      if (currentItems.length === 0) {
        showAlert('Please add at least one item', 'error');
        return;
      }

      const receipt = {
        id: 'receipt_' + Date.now(),
        store,
        date,
        subtotal: parseFloat(document.getElementById('subtotal').value) || total,
        total,
        items: currentItems.map(item => ({
          name: item.name,
          price: item.price,
          category: item.category
        })),
        createdAt: new Date().toISOString()
      };

      // Save to localStorage
      try {
        const receipts = JSON.parse(localStorage.getItem('finances:receipts') || '[]');
        receipts.push(receipt);
        localStorage.setItem('finances:receipts', JSON.stringify(receipts));

        showAlert('Receipt saved successfully!', 'success');
        
        setTimeout(() => {
          location.href = 'index.html';
        }, 1500);
      } catch (e) {
        showAlert('Error saving receipt: ' + e.message, 'error');
      }
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;

      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>