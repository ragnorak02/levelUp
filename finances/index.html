<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finances</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7;
      --accent:#4CAF50; --accent2:#2dd4bf;
      --ring:#2a3543; --good:#22c55e; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -200px, rgba(76,175,80,.20), transparent 55%),
        radial-gradient(900px 700px at 10% 0%, rgba(45,212,191,.12), transparent 60%),
        var(--bg);
      color:var(--ink);
    }
    a{color:inherit; text-decoration:none}

    /* ---- top nav: single line ---- */
    .topbar{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.72));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(42,53,67,.55);
    }
    .topbar-inner{
      max-width:1120px; margin:0 auto;
      padding:10px 12px;
      display:flex; align-items:center; gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      white-space:nowrap;
    }
    .nav{
      margin-left:auto;
      display:flex; gap:8px;
      align-items:center;
      flex:1 1 auto;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      white-space:nowrap;
      padding-bottom:2px;
    }
    .nav::-webkit-scrollbar{height:6px}
    .nav::-webkit-scrollbar-thumb{background:rgba(42,53,67,.6); border-radius:999px}
    .pill{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    .wrap{max-width:1120px; margin:0 auto; padding:12px}

    .card{
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Month nav above the 2 stats */
    .monthbar{
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 12px 0 12px;
    }
    .monthbtn{
      width:40px; height:38px;
      border-radius:12px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:900;
      cursor:pointer;
    }
    .monthlabel{
      font-weight:950;
      color:var(--ink);
      letter-spacing:.2px;
      min-width: 160px;
      text-align:center;
    }

    .stats{
      display:grid; gap:12px; grid-template-columns: repeat(2, 1fr);
      padding:12px;
    }
    .stat{
      padding:12px 14px;
      background: rgba(11,15,20,.35);
      border:1px solid rgba(42,53,67,.55);
      border-radius: 14px;
      text-align:center;
    }
    .stat .v{font-size:24px; font-weight:900; color:var(--good); line-height:1.1}
    .stat .k{font-size:12px; color:var(--muted); margin-top:4px; font-weight:800}

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
      margin-top:14px;
    }
    @media(min-width:860px){
      .grid{grid-template-columns: 1.35fr .85fr}
    }

    .card-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(42,53,67,.55);
      gap:12px;
      flex-wrap:wrap;
    }
    .card-h h3{
      margin:0; font-size:14px; color:var(--muted);
      display:flex; align-items:center; gap:8px;
      letter-spacing:.2px;
    }
    .card-b{padding:14px 16px}

    .btn{
      padding:10px 14px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color:var(--ink);
      font-weight:900;
      display:inline-flex; align-items:center; gap:8px;
      cursor:pointer;
    }

    .donut-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(11,15,20,.35);
      color:var(--muted);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    canvas{max-width:100%; width:100%}

    .legend{margin-top:12px; display:flex; flex-direction:column; gap:8px;}
    .legend-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      cursor:pointer;
      user-select:none;
    }
    .legend-left{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:#888;
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .legend-name{font-weight:900}
    .legend-meta{font-size:12px; color:var(--muted); font-weight:800}
    .legend-right{text-align:right}
    .legend-amt{font-weight:900; color:var(--good)}
    .legend-row.selected{
      outline: 2px solid rgba(76,175,80,.55);
      background: rgba(76,175,80,.08);
    }

    .empty{
      color:var(--muted);
      display:flex; align-items:center; justify-content:center;
      padding:26px 10px;
      gap:10px;
      text-align:center;
    }

    .recent{display:flex; flex-direction:column; gap:10px;}
    .recent-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(42,53,67,.55);
      background: rgba(11,15,20,.35);
      gap:10px;
      cursor:pointer;
    }
    .recent-left{display:flex; flex-direction:column; gap:2px; min-width:0}
    .recent-title{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .recent-sub{font-size:12px; color:var(--muted); font-weight:800}
    .recent-toggle{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .chev{
      width:100%;
      justify-content:center;
      gap:8px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">üè† <span>Finances</span></div>
      <div class="nav">
        <a class="pill active" href="index.html">Home</a>
        <a class="pill" href="food.html">Food</a>
        <a class="pill" href="search.html">Search</a>
        <a class="pill" href="receipts.html">Receipts</a>
        <a class="pill" href="analytics.html">Analytics</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card" style="margin-top:12px;">
      <div class="monthbar">
        <button class="monthbtn" id="monthPrev" type="button">‚óÄ</button>
        <div class="monthlabel" id="monthLabel">Month</div>
        <button class="monthbtn" id="monthNext" type="button">‚ñ∂</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="v" id="statMonth">$0.00</div>
          <div class="k">Month Total</div>
        </div>
        <div class="stat">
          <div class="v" id="statWeek">$0.00</div>
          <div class="k">This Week</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <h3>üìä Spending by Category</h3>
          <div>
            <button class="btn" id="donutResetBtn" type="button">Reset</button>
          </div>
        </div>

        <div class="card-b">
          <div class="donut-top">
            <div class="tabs">
              <div class="tab active" id="tabAll">All</div>
              <div class="tab" id="tabGroceries">Groceries</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="donutCanvas" width="620" height="360"></canvas>
          </div>

          <div class="legend" id="donutLegend"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h3>üß† Budget Status</h3>
        </div>
        <div class="card-b">
          <div class="empty">üéØ Set up budgets to track your spending goals.</div>
          <div style="display:flex; justify-content:center;">
            <a class="btn" href="budget.html">Set Budgets</a>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="card-h">
        <h3>üõí Recent Purchases</h3>
      </div>
      <div class="card-b">
        <div class="recent" id="recentPurchases"></div>
        <div class="recent-toggle" id="recentToggleWrap" style="display:none;">
          <button class="btn chev" id="recentToggleBtn" type="button">Show more ‚ñº</button>
        </div>
      </div>
    </div>
  </div>

  <script src="dataLoader.js"></script>
  <script>
    const fmtMoney = (n) => `$${(Number(n)||0).toFixed(2)}`;
    const toDate = (d) => (d instanceof Date ? d : new Date(d));

    function startOfWeekSunday(date){
      const dt = new Date(date);
      dt.setHours(0,0,0,0);
      const day = dt.getDay(); // 0=Sun
      dt.setDate(dt.getDate() - day);
      return dt;
    }
    function endOfWeekSaturday(date){
      const s = startOfWeekSunday(date);
      const e = new Date(s);
      e.setDate(e.getDate()+6);
      e.setHours(23,59,59,999);
      return e;
    }
    function inRange(dt, start, end){
      const t = dt.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    // ---- stable color mapping by category NAME ----
    const FIXED_COLORS = {
      // top-level
      "Groceries":"#4CAF50",
      "Cafe":"#f59e0b",
      "Restaurants":"#fb7185",
      "Home":"#60a5fa",
      "Rental Property":"#a78bfa",
      "Transportation":"#14b8a6",
      "Utilities":"#f97316",
      "Medical":"#f472b6",
      "Other":"#94a3b8",

      // grocery breakdown
      "Meat/Fish":"#2dd4bf",
      "Dairy":"#60a5fa",
      "Produce":"#22c55e",
      "Snacks":"#fb7185",
      "Pantry":"#a78bfa",
      "Bakery":"#f59e0b",
      "Drinks":"#14b8a6",
      "Grains":"#f97316",
      "Unknown":"#94a3b8"
    };

    function hashColor(str){
      let h = 2166136261;
      for (let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const hue = Math.abs(h) % 360;
      return `hsl(${hue} 70% 55%)`;
    }
    function getColor(name){
      const key = (name || "Unknown").trim();
      return FIXED_COLORS[key] || hashColor(key);
    }

    // ---------- donut drawing ----------
    function drawDonut(ctx, w, h, categories, selectedIndex){
      ctx.clearRect(0,0,w,h);
      const total = categories.reduce((a,c)=>a + (c.total||0), 0) || 0;

      const centerX = w/2;
      const centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      ctx.save();
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius*1.35, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(76,175,80,0.06)';
      ctx.fill();
      ctx.restore();

      let currentAngle = -Math.PI/2;

      categories.forEach((cat, i) => {
        const sliceAngle = total === 0 ? 0 : (cat.total / total) * 2 * Math.PI;
        const isSelected = (selectedIndex === i);
        const outerR = isSelected ? radius * 1.08 : radius;

        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();

        ctx.fillStyle = cat.color;
        ctx.fill();

        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.stroke();

        currentAngle += sliceAngle;
      });

      // center text
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.65)';
      ctx.shadowBlur = 8;

      ctx.fillStyle = '#e8eef6';
      ctx.font = '900 40px system-ui';
      ctx.fillText(total ? `$${Math.round(total)}` : '$0', centerX, centerY - 6);

      ctx.fillStyle = 'rgba(159,176,199,0.95)';
      ctx.font = '800 14px system-ui';
      ctx.fillText('Total', centerX, centerY + 28);

      // selected label ABOVE donut
      if (selectedIndex != null && categories[selectedIndex]) {
        const c = categories[selectedIndex];
        ctx.fillStyle = '#e8eef6';
        ctx.font = '900 18px system-ui';
        ctx.fillText(`${c.name}: ${fmtMoney(c.total)}`, centerX, centerY - (radius + 36));
      }
      ctx.restore();
    }

    function getSliceAtPoint(w, h, categories, x, y){
      const centerX = w/2, centerY = h/2;
      const radius = Math.min(w,h) * 0.34;
      const innerRadius = radius * 0.62;

      const dx = x - centerX;
      const dy = y - centerY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < innerRadius || dist > radius*1.12) return null;

      let ang = Math.atan2(dy, dx);
      ang = ang - (-Math.PI/2);
      if (ang < 0) ang += Math.PI*2;

      const total = categories.reduce((a,c)=>a+(c.total||0),0) || 0;
      let acc = 0;
      for (let i=0;i<categories.length;i++){
        const slice = total === 0 ? 0 : (categories[i].total/total) * Math.PI*2;
        if (ang >= acc && ang < acc + slice) return i;
        acc += slice;
      }
      return null;
    }

    function buildLegend(container, categories, selectedIndex, onPick){
      container.innerHTML = '';
      categories.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'legend-row' + (selectedIndex === idx ? ' selected' : '');

        const left = document.createElement('div');
        left.className = 'legend-left';

        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.background = c.color;

        const nameWrap = document.createElement('div');

        const name = document.createElement('div');
        name.className = 'legend-name';
        name.textContent = c.name;

        const meta = document.createElement('div');
        meta.className = 'legend-meta';
        meta.textContent = `${c.itemsCount} items`;

        nameWrap.appendChild(name);
        nameWrap.appendChild(meta);

        left.appendChild(dot);
        left.appendChild(nameWrap);

        const right = document.createElement('div');
        right.className = 'legend-right';

        const amt = document.createElement('div');
        amt.className = 'legend-amt';
        amt.textContent = fmtMoney(c.total);

        right.appendChild(amt);

        row.appendChild(left);
        row.appendChild(right);

        row.addEventListener('click', () => onPick(idx));
        container.appendChild(row);
      });
    }

    // ---- OPTIONAL items DB load (safe if file missing) ----
    async function loadItemsDb(){
      try{
        const r = await fetch('itemsDatabase.json', {cache:'no-store'});
        if (!r.ok) return null;
        return await r.json();
      }catch(e){
        return null;
      }
    }

    function norm(s){
      return String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
    }

    function lookupFoodCategoryFromItemsDb(itemsDb, itemName){
      if (!itemsDb) return null;

      if (itemsDb.map && typeof itemsDb.map === 'object'){
        const n = norm(itemName);
        for (const k of Object.keys(itemsDb.map)){
          if (n.includes(norm(k))) return itemsDb.map[k];
        }
      }

      if (Array.isArray(itemsDb.items)){
        const n = norm(itemName);
        for (const it of itemsDb.items){
          if (!it) continue;
          const key = norm(it.name || it.item || it.title);
          if (key && n.includes(key)) return it.category || it.foodCategory || null;
        }
      }

      return null;
    }

    function guessFoodCategory(itemName){
      const n = norm(itemName);
      const has = (...words) => words.some(w => n.includes(w));

      if (has('beef','steak','chicken','pork','turkey','lamb','salmon','tuna','shrimp','fish','meat','teres','teres major')) return 'Meat/Fish';
      if (has('milk','yogurt','cheese','butter','cream','oatly','half and half','egg','eggs')) return 'Dairy';
      if (has('banana','apple','avocado','berries','strawberry','blueberry','raspberry','pepper','spinach','lettuce','tomato','onion','cucumber','carrot','produce')) return 'Produce';
      if (has('bread','bagel','bun','muffin','croissant','bakery')) return 'Bakery';
      if (has('rice','oats','oat','pasta','noodle','quinoa','grain','grains')) return 'Grains';
      if (has('chips','cookie','cookies','chocolate','candy','snack','snacks','ice cream')) return 'Snacks';
      if (has('soda','juice','water','coffee','tea','drink','drinks')) return 'Drinks';
      if (has('sauce','spice','salt','pepper','oil','vinegar','pantry')) return 'Pantry';

      return 'Other';
    }

    function sumReceiptItemsCount(r){
      return Array.isArray(r.items) ? r.items.length : (Number(r.itemsCount)||0);
    }

    // ---------- category builders ----------
    function aggregateByReceiptCategory(receipts){
      const map = new Map();
      receipts.forEach(r => {
        const name = (r.category || 'Other').trim();
        const prev = map.get(name) || { name, total:0, itemsCount:0 };
        prev.total += Number(r.total)||0;
        prev.itemsCount += sumReceiptItemsCount(r);
        map.set(name, prev);
      });

      return Array.from(map.values())
        .sort((a,b)=>b.total-a.total)
        .map(c => ({ ...c, color: getColor(c.name) }));
    }

    async function aggregateGroceriesBreakdown(receipts){
      const itemsDb = await loadItemsDb();

      const groceryReceipts = receipts.filter(r => {
        const cat = (r.category||'').trim();
        return ['Groceries','Meat/Fish','Dairy','Produce','Snacks','Pantry','Bakery','Drinks','Grains'].includes(cat);
      });

      const map = new Map();

      groceryReceipts.forEach(r=>{
        const cat = (r.category||'Other').trim();

        const directFood = ['Meat/Fish','Dairy','Produce','Snacks','Pantry','Bakery','Drinks','Grains'];
        if (directFood.includes(cat)){
          const prev = map.get(cat) || { name:cat, total:0, itemsCount:0 };
          prev.total += Number(r.total)||0;
          prev.itemsCount += sumReceiptItemsCount(r);
          map.set(cat, prev);
          return;
        }

        if (cat === 'Groceries' && Array.isArray(r.items) && r.items.length){
          r.items.forEach(it=>{
            const itemName = (it.name || it.item || it.title || it.description || '').trim();
            const qty = Number(it.qty ?? it.quantity ?? 1) || 1;
            const price = Number(it.total ?? it.price ?? it.amount ?? 0) || 0;

            const fromDb = lookupFoodCategoryFromItemsDb(itemsDb, itemName);
            const bucket = (fromDb || guessFoodCategory(itemName) || 'Other').trim();

            const prev = map.get(bucket) || { name:bucket, total:0, itemsCount:0 };
            prev.total += price;
            prev.itemsCount += qty;
            map.set(bucket, prev);
          });
          return;
        }

        const prev = map.get('Other') || { name:'Other', total:0, itemsCount:0 };
        prev.total += Number(r.total)||0;
        prev.itemsCount += sumReceiptItemsCount(r);
        map.set('Other', prev);
      });

      return Array.from(map.values())
        .sort((a,b)=>b.total-a.total)
        .map(c => ({ ...c, color: getColor(c.name) }));
    }

    function monthKey(date){
      const d = new Date(date.getFullYear(), date.getMonth(), 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function getMonthRangeFromBase(now, offset){
      const base = new Date(now.getFullYear(), now.getMonth() + offset, 1);
      const start = new Date(base.getFullYear(), base.getMonth(), 1, 0,0,0,0);
      const end = new Date(base.getFullYear(), base.getMonth()+1, 0, 23,59,59,999);
      return { start, end, labelDate: base };
    }

    function formatMonthLabel(d, now){
      const sameYear = d.getFullYear() === now.getFullYear();
      const m = d.toLocaleString('en-US', { month:'long' });
      return sameYear ? m : `${m} ${d.getFullYear()}`;
    }

    async function main(){
      let data = null;
      try{
        if (window.loadAllData) data = await window.loadAllData();
        else if (window.loadReceiptsData) data = await window.loadReceiptsData();
      }catch(e){}

      if (!data) {
        const r = await fetch('receiptsData.json', {cache:'no-store'});
        data = await r.json();
      }
      const allReceipts = Array.isArray(data) ? data : (data.receipts || []);
      const now = new Date();

      // ---- month selection state ----
      let monthOffset = 0; // 0=current month, -1 previous, etc.
      let tab = 'all';     // 'all' | 'groceries'
      let selectedIndex = null;
      let activeCategories = [];

      const monthLabelEl = document.getElementById('monthLabel');
      const monthPrevEl = document.getElementById('monthPrev');
      const monthNextEl = document.getElementById('monthNext');

      const statMonthEl = document.getElementById('statMonth');
      const statWeekEl = document.getElementById('statWeek');

      const tabAllEl = document.getElementById('tabAll');
      const tabGroEl = document.getElementById('tabGroceries');

      const canvas = document.getElementById('donutCanvas');
      const legend = document.getElementById('donutLegend');
      const ctx = canvas.getContext('2d');

      // crisp on mobile
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = canvas.clientWidth || 620;
      const cssH = 360;
      canvas.style.height = cssH + 'px';
      canvas.width = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      function getReceiptsForSelectedMonth(){
        const { start, end } = getMonthRangeFromBase(now, monthOffset);
        return allReceipts.filter(r => inRange(toDate(r.date), start, end));
      }

      function updateTopStats(){
        const { start: mStart, end: mEnd, labelDate } = getMonthRangeFromBase(now, monthOffset);
        monthLabelEl.textContent = formatMonthLabel(labelDate, now);

        const monthReceipts = allReceipts.filter(r => inRange(toDate(r.date), mStart, mEnd));
        const monthSpent = monthReceipts.reduce((a,r)=>a+(Number(r.total)||0),0);

        const weekStart = startOfWeekSunday(now);
        const weekEnd = endOfWeekSaturday(now);
        const weekSpent = allReceipts
          .filter(r => inRange(toDate(r.date), weekStart, weekEnd))
          .reduce((a,r)=>a+(Number(r.total)||0),0);

        statMonthEl.textContent = fmtMoney(monthSpent);
        statWeekEl.textContent = fmtMoney(weekSpent);
      }

      async function computeCategories(){
        const monthReceipts = getReceiptsForSelectedMonth();
        if (tab === 'groceries'){
          activeCategories = await aggregateGroceriesBreakdown(monthReceipts);
        } else {
          activeCategories = aggregateByReceiptCategory(monthReceipts);
        }
      }

      function redraw(){
        drawDonut(ctx, cssW, cssH, activeCategories, selectedIndex);
        buildLegend(legend, activeCategories, selectedIndex, (idx)=>{
          selectedIndex = (selectedIndex === idx) ? null : idx;
          redraw();
        });
      }

      async function refreshAll(){
        updateTopStats();
        selectedIndex = null;
        await computeCategories();
        redraw();
      }

      async function setTab(newTab){
        tab = newTab;
        selectedIndex = null;
        tabAllEl.classList.toggle('active', tab === 'all');
        tabGroEl.classList.toggle('active', tab === 'groceries');
        await computeCategories();
        redraw();
      }

      tabAllEl.addEventListener('click', ()=>setTab('all'));
      tabGroEl.addEventListener('click', ()=>setTab('groceries'));

      canvas.addEventListener('click', (ev) => {
        const rect = canvas.getBoundingClientRect();
        const x = ev.clientX - rect.left;
        const y = ev.clientY - rect.top;
        const idx = getSliceAtPoint(cssW, cssH, activeCategories, x, y);
        if (idx == null) selectedIndex = null;
        else selectedIndex = (selectedIndex === idx) ? null : idx;
        redraw();
      });

      document.getElementById('donutResetBtn').addEventListener('click', ()=>{
        selectedIndex = null;
        redraw();
      });

      monthPrevEl.addEventListener('click', async ()=>{
        monthOffset -= 1;
        await refreshAll();
      });
      monthNextEl.addEventListener('click', async ()=>{
        monthOffset += 1;
        await refreshAll();
      });

      // ---- recent purchases: show 3 by default with expand ----
      const recentWrap = document.getElementById('recentPurchases');
      const recentToggleWrap = document.getElementById('recentToggleWrap');
      const recentToggleBtn = document.getElementById('recentToggleBtn');
      let recentExpanded = false;

      function renderRecent(){
        const sorted = [...allReceipts]
          .sort((a,b)=> toDate(b.date) - toDate(a.date));

        const maxCollapsed = 3;
        const maxExpanded = 12;

        const toShow = recentExpanded ? sorted.slice(0, maxExpanded) : sorted.slice(0, maxCollapsed);

        recentWrap.innerHTML = '';
        if (!toShow.length){
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No purchases yet.';
          recentWrap.appendChild(empty);
          recentToggleWrap.style.display = 'none';
          return;
        }

        toShow.forEach(r=>{
          const row = document.createElement('div');
          row.className = 'recent-item';

          const left = document.createElement('div');
          left.className = 'recent-left';

          const title = document.createElement('div');
          title.className = 'recent-title';
          title.textContent = r.store || 'Unknown Store';

          const sub = document.createElement('div');
          sub.className = 'recent-sub';
          const d = toDate(r.date);
          const ds = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
          const count = sumReceiptItemsCount(r);
          sub.textContent = `${ds} ‚Ä¢ ${count} items`;

          left.appendChild(title);
          left.appendChild(sub);

          const right = document.createElement('div');
          right.style.fontWeight = '900';
          right.style.color = 'var(--good)';
          right.textContent = fmtMoney(r.total);

          row.appendChild(left);
          row.appendChild(right);

          row.addEventListener('click', ()=>{
            try{ localStorage.setItem('selectedReceiptId', r.id || ''); }catch(e){}
            window.location.href = 'receipts.html';
          });

          recentWrap.appendChild(row);
        });

        // show toggle only if there are more than 3 receipts total
        if (sorted.length > maxCollapsed){
          recentToggleWrap.style.display = 'flex';
          recentToggleBtn.textContent = recentExpanded ? 'Show less ‚ñ≤' : 'Show more ‚ñº';
        } else {
          recentToggleWrap.style.display = 'none';
        }
      }

      recentToggleBtn.addEventListener('click', ()=>{
        recentExpanded = !recentExpanded;
        renderRecent();
      });

      // initial paint
      await refreshAll();
      renderRecent();
    }

    main().catch(console.error);
  </script>
</body>
</html>