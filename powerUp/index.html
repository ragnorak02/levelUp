<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Power Up!</title>
<style>
  :root{
    --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7; --accent:#4CAF50; --accent-2:#2dd4bf;
    --ring:#2a3543; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
    --cal-gap:4px; --cal-radius:10px; --cal-font:.9rem; --cal-count:.8rem;
    --mg-chest: rgba(255, 59, 48, .72); /* bright red */
    --mg-back: rgba(0, 122, 255, .72); /* strong blue */
    --mg-legs: rgba(52, 199, 89, .72); /* vibrant green */
    --mg-shoulders: rgba(175, 82, 222, .72); /* rich purple */
}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#0a0e13 0%, #0d131a 100%); color:var(--ink);
    display:flex; flex-direction:column;
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:.6rem .9rem; border-bottom:1px solid var(--ring); background:#0e141b;
  }
  header h1{margin:0; font-size:1.05rem; letter-spacing:.2px}
  header .home{all:unset; cursor:pointer; padding:.35rem .6rem; border-radius:.6rem; border:1px solid var(--ring)}
  header .home:focus-visible{outline:2px solid var(--accent-2)}

  .wrap{width:min(1100px, 100%); margin-inline:auto; padding:8px 12px 12px; flex:1; display:flex; flex-direction:column; gap:8px}

  .grid{display:grid; gap:10px; grid-template-columns: repeat(12, 1fr)}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:14px;
    padding:10px; box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:.1rem 0 .45rem; font-size:.95rem; color:var(--muted); font-weight:600}

  /* top cards */
  #powerCard{grid-column: span 3}
  #lastWorkoutCard{grid-column: span 9; display:grid; grid-template-columns: 1.15fr 1fr; gap:12px}
  .val{display:flex; align-items:baseline; gap:8px; font-size:1.6rem; font-weight:700}
  .trend{font-size:.8rem; color:var(--muted)}
  .spark{width:100%; height:45px; display:block}
  .meta{display:flex; gap:10px; flex-wrap:wrap}
.badge{background:#0f1720; border:1px solid var(--ring); color:var(--muted); padding:.3rem .55rem; border-radius:999px; font-size:.82rem}

/* Today's Workout tiles (compact, square-ish) */
.meta-tiles{display:flex; gap:8px; flex-wrap:wrap; align-items:stretch; margin-top:6px}
.tile{
  background:#0f1720;
  border:1px solid var(--ring);
  border-radius:12px;
  padding:8px 10px;
  min-width:84px;
  display:flex;
  flex-direction:column;
  gap:4px;
  justify-content:center;
  text-align:center;
  color:var(--muted);
  font-size:.82rem;
}
.tile b{color:var(--ink); font-size:1rem}
.tile .t-label{font-size:.72rem; letter-spacing:.02em}
.tile.tile-date{min-width:120px; text-align:left; justify-content:center}
  .ex-list{display:grid; gap:6px}
  .ex{display:flex; justify-content:space-between; background:#0f141b; border:1px dashed #213043; border-radius:10px; padding:6px 8px; font-size:.95rem}
  .ex b{font-weight:700}
  .cta-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .cta{
    all:unset; cursor:pointer; background:linear-gradient(90deg, var(--accent), #22c55e);
    color:#04130a; padding:.65rem .9rem; border-radius:10px; font-weight:700; box-shadow:0 6px 20px rgba(34,197,94,.25)
  }
  .cta:active{transform:translateY(1px)}
  .ghost{all:unset; cursor:pointer; color:var(--muted); padding:.5rem .7rem; border-radius:9px; border:1px solid var(--ring)}
  .small-btn{all:unset; cursor:pointer; color:var(--muted); padding:.4rem .6rem; border-radius:8px; border:1px solid var(--ring); font-size:.85rem}


  /* Compact power card spacing */
  #powerCard{padding:10px}
  #powerCard h3{margin:0 0 .35rem; font-size:.9rem}
  #powerCard .val{font-size:1.35rem; gap:6px}
  .power-level{font-size:1.35rem}
  .trend{font-size:.78rem}
  .level-progress{height:7px; margin:6px 0}
  /* Inline power row (Title + Level + Progress + Weight) */
.power-inline{display:flex; align-items:center; gap:10px}
.power-title{margin:0; font-size:.88rem; color:var(--muted); font-weight:650; white-space:nowrap}
.power-level-wrap{display:flex; align-items:baseline; gap:6px; white-space:nowrap}
.level-progress.inline{flex:1; margin:0; height:8px; min-width:70px}
.weight-pill{
  all:unset; cursor:pointer;
  padding:.35rem .6rem;
  border-radius:999px;
  border:1px solid var(--ring);
  background:#0f1720;
  color:var(--ink);
  font-weight:750;
  white-space:nowrap;
}
.weight-pill:hover{background:#15202c}

  /* Power level styling */
  .power-level{
    font-size:1.35rem; 
    font-weight:800; 
    background:linear-gradient(45deg, #fbbf24, #f59e0b, #d97706);
    -webkit-background-clip:text;
    background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow:0 2px 4px rgba(0,0,0,0.3);
  }
  .level-progress{
    width:100%; 
    height:8px; 
    background:#1a2332; 
    border-radius:4px; 
    overflow:hidden;
    margin:8px 0;
  }
  .level-bar{
    height:100%; 
    background:linear-gradient(90deg, #fbbf24, #f59e0b); 
    border-radius:4px;
    transition:width 0.3s ease;
  }

  /* Workout navigation */
  .workout-nav{
    display:flex; 
    align-items:center; 
    gap:8px; 
    margin-bottom:8px;
  }
  .nav-btn{
    all:unset; 
    cursor:pointer; 
    padding:.3rem .5rem; 
    border:1px solid var(--ring); 
    border-radius:8px; 
    font-size:.9rem;
    color:var(--muted);
  }
  .nav-btn:hover{background:rgba(255,255,255,0.05)}
  .nav-btn:disabled{opacity:0.4; cursor:not-allowed}

  /* calendar (compact + half width on desktop) */
  .calendar{grid-column: span 6}
  .calendar h3{margin:0; font-size:1rem; color:var(--muted)}
  .legend{display:flex; gap:10px; color:var(--muted); font-size:.85rem}
  .legend .swatch{width:10px; height:10px; border-radius:4px; display:inline-block; border:1px solid #233446}
  .cal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .cal-nav{display:flex; align-items:center; gap:8px}
  .cal-nav button{all:unset; cursor:pointer; padding:.3rem .5rem; border:1px solid var(--ring); border-radius:8px; font-size:.9rem; color:var(--muted)}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:var(--cal-gap); margin-top:6px}
  .dow{font-size:.78rem; color:var(--muted); text-align:center; padding:3px 0}
  .day{
    aspect-ratio:1/1; border:1px solid var(--ring); border-radius:var(--cal-radius);
    position:relative; background:#0f141b; cursor:pointer;
  }
  .day:hover{background:#1a1f26}
  .day.muted{opacity:.45; cursor:default}
  .day.muted:hover{background:#0f141b}
  .day.done{ background:#16a34a }
  .day.today{outline:2px solid var(--accent-2)}
  /* FIX #1: Change .selected to use blue highlight instead of today */
  .day.selected{outline:2px solid #3b82f6; outline-offset:-2px; background:#1a2f4a}
  .num{ position:absolute; top:6px; left:7px; font-size:var(--cal-font); line-height:1; color:var(--ink) }
  .count{ position:absolute; bottom:6px; right:7px; font-size:var(--cal-count); color:var(--muted) }


  /* Calendar muscle labels */
  .day.hasWorkout{ background:#0f141b; }
  .muscles{
    position:absolute;
    left:7px;
    right:7px;
    bottom:6px;
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:.72rem;
    line-height:1.05;
    color:#e8eef6;
    opacity:.95;
    pointer-events:none;
    text-shadow:0 1px 2px rgba(0,0,0,.55);
  }
  .muscle-line{
    display:block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .legend.legend-muscle{flex-wrap:wrap; gap:8px 10px}
  .legend.legend-muscle .swatch{border-radius:4px}


  /* responsive (fit on one mobile screen) */
  @media (max-width: 980px){
    #powerCard{grid-column:span 12}
    #lastWorkoutCard{grid-column:span 12}
    .calendar{grid-column:span 12}
    #lastWorkoutCard{grid-template-columns:1fr}
  }
  @media (max-width: 480px){
    .wrap{gap:8px; padding:8px 8px 12px}
    .card{padding:10px; border-radius:12px}
    .val{font-size:1.4rem}
    .spark{height:40px}
    .badge{font-size:.78rem; padding:.25rem .5rem}
    .ex{padding:6px 7px; font-size:.92rem}
    .legend{font-size:.8rem}
    .calendar .card{padding:8px}
    .day{border-radius:8px}
    :root{ --cal-font:.85rem; --cal-count:.7rem }
  }

  /* Grouped exercise list (no reps) */
  .group-chip {
    display:flex;
    align-items:flex-start;
    flex-wrap:wrap;
    gap:8px 10px;
    padding:8px 10px;
    border:1px dashed #223143;
    border-radius:10px;
    background:#0f141b;
    margin-bottom:6px;
  }

  .group-chip h4{
    margin:0;
    font-size:.95rem;
    color:#e8eef6;
    flex:0 0 auto;
  }

  .group-chip .names{
    flex:1 1 100%;
    color:#9fb0c7;
    font-size:.9rem;
    white-space:normal;
    overflow:visible;
    word-break:break-word;
  }

  .group-chip .count{
    margin-left:auto;
    font-size:.8rem;
    color:#9fb0c7;
    border:1px solid #213043;
    border-radius:999px;
    padding:2px 8px;
    background:#0c1117;
  }

  #lastWorkoutCard { overflow-x: hidden; }


/* Weight history modal */
.modal{position:fixed; inset:0; display:none; z-index:50}
.modal.open{display:block}
.modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55)}
.modal-card{
  position:relative;
  max-width:760px;
  margin:10vh auto;
  background:linear-gradient(180deg,#101823 0%, #0e151f 100%);
  border:1px solid var(--ring);
  border-radius:16px;
  padding:12px;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
}
.modal-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.modal-title{font-weight:800; letter-spacing:.02em}
.modal-close{
  all:unset; cursor:pointer; padding:.35rem .55rem;
  border-radius:10px; border:1px solid var(--ring); color:var(--muted)
}
.modal-close:hover{background:#142033}
#weightChart{width:100%; height:220px; display:block; background:#0b121a; border:1px solid #203041; border-radius:12px}
.modal-actions{display:flex; gap:8px; align-items:center; margin:10px 0}
.cta.small{padding:.5rem .75rem; font-size:.9rem}
.weight-list{max-height:180px; overflow:auto; border:1px dashed #213043; border-radius:12px; padding:8px; background:#0b121a}
.weight-item{display:flex; justify-content:space-between; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:.9rem}
.weight-item:last-child{border-bottom:0}
.weight-item b{color:var(--ink)}

</style>
</head>
<body>
  <header>
    <button class="home" onclick="location.href='../main.html'">⟵ Home</button>
    <h1>Power Up!</h1>
    <div style="width:60px"></div>
  </header>

  <div class="wrap">
    <section class="grid">
      <article class="card" id="powerCard">
<div class="power-inline">
  <h3 class="power-title">Power Level</h3>
  <div class="power-level-wrap">
    <span class="power-level" id="powerLevel">Lv 1</span>
    <span class="trend" id="powerTrend">Novice</span>
  </div>
  <div class="level-progress inline" aria-label="Level progress">
    <div class="level-bar" id="levelBar" style="width: 0%"></div>
  </div>
  <button class="weight-pill" id="currentWeightBtn" type="button" title="View weight history">—</button>
</div>
        </article>

      <article class="card" id="lastWorkoutCard">
        <div>
          <div class="workout-nav">
            <button class="nav-btn" id="prevWorkout">←</button>
            <h3 id="workoutPanelTitle">Today's Workout</h3>
            <button class="nav-btn" id="nextWorkout">→</button>
          </div>
          <div class="meta-tiles">
  <div class="tile tile-date" id="lastDate">—</div>
  <div class="tile"><div class="t-label">Total</div><b id="lastVolume">—</b></div>
  <div class="tile"><div class="t-label">Exercises</div><b id="lastMoves">—</b></div>
  <div class="tile"><div class="t-label">Sets</div><b id="lastSets">—</b></div>
  <div class="tile" id="setsLeftTile" style="display:none;"><div class="t-label">Left</div><b id="setsLeft">—</b></div>
</div>
<div class="ex-list" id="exList"></div>
 id="exList"></div>
        </div>
        <div class="cta-row">
          <button class="cta" id="startToday">Start Today's Workout</button>
          <button class="ghost" id="analytics">Analytics</button>
        </div>
      </article>

      <!-- Calendar -->
      <section class="card calendar" id="calendar">
        <div class="cal-header">
          <h3 id="calTitle">—</h3>
          <div class="cal-nav">
            <button id="calPrev">←</button>
            <button id="calNext">→</button>
          </div>
        </div>

        <div class="legend legend-muscle">
          <span><i class="swatch" style="background:var(--mg-chest)"></i> Chest</span>
          <span><i class="swatch" style="background:var(--mg-back)"></i> Back</span>
          <span><i class="swatch" style="background:var(--mg-legs)"></i> Legs</span>
          <span><i class="swatch" style="background:var(--mg-shoulders)"></i> Shoulders</span>
</div>
        <div class="cal-grid" id="calDOW"></div>
        <div class="cal-grid" id="calGrid"></div>
      </section>
    </section>
  </div>

<script>
/* ========= Load data ========= */
const today = new Date();
const todayISO = today.toISOString().slice(0,10);
const fmt = (d)=>new Date(d+'T00:00:00');

// Calendar navigation state
let currentCalendarMonth = new Date(today.getFullYear(), today.getMonth(), 1);

// Selected workout date (defaults to today)
let selectedWorkoutDate = todayISO;

function readLocalDays(){
  const out = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!/^powerUp:\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    try{
      const day = JSON.parse(localStorage.getItem(k));
      if(!day?.date) continue;
      const converted = {
        date: day.date,
        bodyWeight: day.bodyWeight ?? undefined,
        exercises: (day.exercises||[]).map(ex=>({
          name: ex.name || ex.exercise || 'Exercise',
          bodyPart: ex.bodyPart || ex.muscle || ex.group || 'Other',
          sets: (ex.sets||[]).map(s=>({
            reps: Number(s.reps)||0,
            weight: Number(s.weight)||0,
            completed: !!s.done
          }))
        }))
      };
      out.push(converted);
    }catch(e){}
  }
  return out.sort((a,b)=> fmt(a.date)-fmt(b.date));
}

/* Fallback demo data */
const demoWorkouts = [
  { date:'2025-08-12', bodyWeight:184.2, exercises:[
    {name:'OHP', bodyPart:'Shoulders', sets:[{reps:6,weight:95,completed:true},{reps:6,weight:95,completed:true},{reps:5,weight:100,completed:true}]},
  ]},
];

/* Merge: prefer local; else demo */
const workouts = (readLocalDays().length ? readLocalDays() : demoWorkouts);

const byDateAsc = (a,b)=> fmt(a.date) - fmt(b.date);
const shortDate = (d)=> {
  const date = new Date(d + 'T12:00:00'); // Use noon to avoid timezone issues
  return date.toLocaleDateString(undefined, {month:'short', day:'numeric', weekday:'short'});
};
const totalVolume = (wo)=> wo.exercises.reduce((sum, ex)=> sum + ex.sets.reduce((s, st)=> s + (st.weight||0)*(st.reps||0), 0), 0);
const totalSets = (wo)=> wo.exercises.reduce((s,ex)=> s + ex.sets.length, 0);
const completedSets = (wo)=> wo.exercises.reduce((s,ex)=> s + ex.sets.filter(st=>st.completed).length, 0);

/* Power Level Calculation */
function calculatePowerLevel() {
  const totalVol = workouts.reduce((sum, w) => sum + totalVolume(w), 0);
  const maxWeight = Math.max(...workouts.flatMap(w => w.exercises.flatMap(e => e.sets.map(s => s.weight || 0))));
  const totalWorkouts = workouts.filter(w => w.exercises.length > 0).length;
  
  const powerScore = (totalVol * 0.6) + (maxWeight * 100) + (totalWorkouts * 200);
  
  const levels = [
    { threshold: 0, level: 1, title: "Novice", next: 5000 },
    { threshold: 5000, level: 2, title: "Apprentice", next: 12000 },
    { threshold: 12000, level: 3, title: "Warrior", next: 25000 },
    { threshold: 25000, level: 4, title: "Knight", next: 45000 },
    { threshold: 45000, level: 5, title: "Champion", next: 75000 },
    { threshold: 75000, level: 6, title: "Master", next: 120000 },
    { threshold: 120000, level: 7, title: "Grandmaster", next: 180000 },
    { threshold: 180000, level: 8, title: "Legend", next: 250000 },
    { threshold: 250000, level: 9, title: "Mythic", next: 350000 },
    { threshold: 350000, level: 10, title: "Godlike", next: 500000 }
  ];
  
  let currentLevel = levels[0];
  for (let i = 0; i < levels.length; i++) {
    if (powerScore >= levels[i].threshold) {
      currentLevel = levels[i];
    } else {
      break;
    }
  }
  
  const progress = currentLevel.next ? 
    Math.min(((powerScore - currentLevel.threshold) / (currentLevel.next - currentLevel.threshold)) * 100, 100) : 100;
  
  return {
    level: currentLevel.level,
    title: currentLevel.title,
    progress: progress,
    score: Math.round(powerScore)
  };
}

/* Sparkline */
function drawSpark(id, points){
  const c = document.getElementById(id);
  const w = c.clientWidth, h=c.clientHeight;
  c.width = Math.max(260,w); c.height = Math.max(52,h);
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(!points || points.length<2) return;

  const xs = points.map(p=>p.x.getTime());
  const ys = points.map(p=>p.y);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const pad = 8;
  const xScale = (t)=> pad + ((t-minX)/(maxX-minX||1))*(c.width-2*pad);
  const yScale = (v)=> c.height - pad - ((v-minY)/(maxY-minY||1))*(c.height-2*pad);

  ctx.strokeStyle = '#233446'; ctx.lineWidth=1; ctx.setLineDash([2,3]);
  ctx.beginPath(); ctx.moveTo(pad, yScale(minY)); ctx.lineTo(c.width-pad, yScale(minY)); ctx.stroke();
  ctx.setLineDash([]);

  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-2') || '#2dd4bf';
  ctx.lineWidth = 2; ctx.beginPath();
  points.forEach((p,i)=>{ const x=xScale(p.x.getTime()), y=yScale(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();

  const lp = points[points.length-1]; const lx=xScale(lp.x.getTime()), ly=yScale(lp.y);
  ctx.fillStyle = '#e8eef6'; ctx.beginPath(); ctx.arc(lx,ly,3,0,Math.PI*2); ctx.fill();
}

/* Power Level card */
function renderPowerLevel(){
  const power = calculatePowerLevel();
  document.getElementById('powerLevel').textContent = `Lv ${power.level}`;
  document.getElementById('powerTrend').textContent = power.title;
  document.getElementById('levelBar').style.width = `${power.progress}%`;
  
  const sorted = [...workouts].sort(byDateAsc);
  const lastWeight = sorted
    .filter(w=>typeof w.bodyWeight==='number' && !isNaN(w.bodyWeight))
    .at(-1);
  
  const weightEl = document.getElementById('currentWeight');
  if(lastWeight){
    weightEl.textContent = `${lastWeight.bodyWeight.toFixed(1)} lb`;
  } else {
    weightEl.textContent = '—';
  }
}

/* Workout panel - shows selected date */
function renderWorkoutPanel(){
  const workout = workouts.find(w => w.date === selectedWorkoutDate) || { date: selectedWorkoutDate, exercises: [], bodyWeight: undefined };
  
  const isToday = selectedWorkoutDate === todayISO;
  const inProgress = isToday && isTodayInProgress(workout);
  
  // Update navigation buttons
  const allDates = [...new Set([todayISO, ...workouts.map(w => w.date)])].sort().reverse();
  const currentIndex = allDates.indexOf(selectedWorkoutDate);
  
  document.getElementById('prevWorkout').disabled = currentIndex >= allDates.length - 1;
  document.getElementById('nextWorkout').disabled = currentIndex <= 0;
  
  // Update button text
  const startBtn = document.getElementById('startToday');
  if (isToday) {
    startBtn.textContent = inProgress ? 'Continue Workout' : 'Start Today\'s Workout';
  } else if (workout.exercises.length > 0) {
    startBtn.textContent = 'View Workout';
  } else {
    startBtn.textContent = 'Add Workout';
  }

  const title = document.getElementById('workoutPanelTitle');
  title.textContent = isToday ? 'Today\'s Workout' : shortDate(selectedWorkoutDate);

  document.getElementById('lastDate').textContent = shortDate(selectedWorkoutDate);
  document.getElementById('lastVolume').textContent = totalVolume(workout).toLocaleString()+' lb';
  document.getElementById('lastMoves').textContent = workout.exercises.length;
  document.getElementById('lastSets').textContent = totalSets(workout);

  const setsLeftWrap = document.getElementById('setsLeftTile');
  if(isToday && workout.exercises.length > 0){
    const left = totalSets(workout) - completedSets(workout);
    setsLeftWrap.style.display = 'inline-flex';
    document.getElementById('setsLeft').textContent = left;
  } else {
    setsLeftWrap.style.display = 'none';
  }

  // Grouped list
  const exList = document.getElementById('exList');
  exList.innerHTML = '';
  const groups = new Map();
  workout.exercises.forEach(ex=>{
    const bp = ex.bodyPart || 'Other';
    const name = ex.name || 'Exercise';
    if(!groups.has(bp)) groups.set(bp, new Set());
    groups.get(bp).add(name);
  });
  [...groups.entries()].forEach(([bp, nameSet])=>{
    const names = [...nameSet];
    const row = document.createElement('div');
    row.className = 'group-chip';
    row.innerHTML = `<h4>${bp}</h4><div class="names" title="${names.join(', ')}">${names.join(', ')}</div><span class="count">${names.length}</span>`;
    exList.appendChild(row);
  });
}

/* FIX #1: Calendar - muscle-group view + properly highlight selected date */
function renderCalendar(){
  const calTitle = document.getElementById('calTitle');
  const calGrid  = document.getElementById('calGrid');
  const calDOW   = document.getElementById('calDOW');

  // DOW header
  calDOW.innerHTML = '';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
    const e = document.createElement('div');
    e.className='dow'; e.textContent = d; calDOW.appendChild(e);
  });

  const year = currentCalendarMonth.getFullYear();
  const month = currentCalendarMonth.getMonth();
  const monthStart = new Date(year, month, 1);
  const monthEnd   = new Date(year, month+1, 0);
  calTitle.textContent = monthStart.toLocaleDateString(undefined, {month:'long', year:'numeric'});

  // --- Muscle mapping ---
  const muscleKey = (raw)=>{
  const s = String(raw||'').toLowerCase();
  if(s.includes('chest') || s.includes('pec')) return 'Chest';
  if(s.includes('back') || s.includes('lat') || s.includes('row')) return 'Back';
  if(s.includes('leg') || s.includes('quad') || s.includes('ham') || s.includes('glute') || s.includes('calf')) return 'Legs';
  if(s.includes('shoulder') || s.includes('delt')) return 'Shoulders';
  return null; // ignore Arms/Other (per new spec)
};


  const muscleBg = (key)=>{
  switch(key){
    case 'Chest': return 'var(--mg-chest)';
    case 'Back': return 'var(--mg-back)';
    case 'Legs': return 'var(--mg-legs)';
    case 'Shoulders': return 'var(--mg-shoulders)';
    default: return '';
  }
};


  // day -> { hasWorkout:boolean, vols: Map(muscle->volume) }
  const byDay = new Map();

  workouts.forEach(w=>{
    const d = fmt(w.date);
    if(d.getFullYear()!==year || d.getMonth()!==month) return;

    const dayNum = d.getDate();
    if(!byDay.has(dayNum)){
      byDay.set(dayNum, { hasWorkout:false, vols:new Map() });
    }
    const info = byDay.get(dayNum);

    // Completion: at least one set with any meaningful values OR any exercises exist
    let anyLogged = false;

    (w.exercises||[]).forEach(ex=>{
      const mk = muscleKey(ex.bodyPart);
      if(!mk) return;
      (ex.sets||[]).forEach(st=>{
        const reps = Number(st.reps)||0;
        const weight = Number(st.weight)||0;
        if(reps>0 || weight>0) anyLogged = true;

        const vol = reps>0 && weight>0 ? (reps*weight) : 0;
        if(vol>0){
          info.vols.set(mk, (info.vols.get(mk)||0) + vol);
        }
      });
    });

    if((w.exercises||[]).length>0) anyLogged = true;
    if(anyLogged) info.hasWorkout = true;
  });

  // Build grid
  calGrid.innerHTML = '';
  const leadingBlanks = monthStart.getDay();

  // Previous month dates (muted)
  for(let i = leadingBlanks - 1; i >= 0; i--){
    const prevDate = new Date(year, month, -i);
    const cell = document.createElement('div');
    cell.className = 'day muted';
    const num = document.createElement('div');
    num.className = 'num';
    num.textContent = prevDate.getDate();
    cell.appendChild(num);
    calGrid.appendChild(cell);
  }

  // Current month dates
  for(let day=1; day<=monthEnd.getDate(); day++){
    const cell = document.createElement('div');

    const cellDate = new Date(year, month, day);
    const cellDateStr = cellDate.toISOString().slice(0,10);

    const info = byDay.get(day) || { hasWorkout:false, vols:new Map() };

    // Determine top 2 muscle groups by volume
    const top = [...info.vols.entries()]
      .sort((a,b)=> (b[1]||0) - (a[1]||0))
      .filter(([k,v])=> (v||0) > 0)
      .slice(0,2)
      .map(([k])=>k);

    // Classes (selected/today)
    let state = info.hasWorkout ? 'hasWorkout' : '';
    if(cellDateStr === selectedWorkoutDate) state += ' selected';
    if(day===today.getDate() && month===today.getMonth() && year===today.getFullYear() && cellDateStr !== selectedWorkoutDate) state += ' today';

    cell.className = `day ${state}`.trim();

    // Background tint based on PRIMARY muscle group (solid color)
if(info.hasWorkout && top.length){
  cell.style.background = muscleBg(top[0]);
} else {
  cell.style.background = '';
}


    // Click behavior (same as before)
    cell.addEventListener('click', () => {
      selectedWorkoutDate = cellDateStr;
      renderWorkoutPanel();
      renderCalendar();
    });

    // Day number
    const num = document.createElement('div');
    num.className='num';
    num.textContent = day;
    cell.appendChild(num);

    // Muscle labels (max 2 lines)
    if(info.hasWorkout && top.length){
      const wrap = document.createElement('div');
      wrap.className = 'muscles';
      top.forEach(k=>{
        const line = document.createElement('div');
        line.className = 'muscle-line';
        line.textContent = k;
        wrap.appendChild(line);
      });
      cell.appendChild(wrap);
    }

    calGrid.appendChild(cell);
  }
}


/* In-progress detection */
function isTodayInProgress(todayW){
  if(!todayW || !todayW.exercises){
    return localStorage.getItem('workoutInProgress') === todayISO;
  }
  const hasSets = totalSets(todayW) > 0;
  const allDone = completedSets(todayW) === totalSets(todayW);
  return hasSets && !allDone;
}

/* Event Listeners */
document.getElementById('startToday').addEventListener('click', ()=>{
  if(selectedWorkoutDate === todayISO) {
    localStorage.setItem('workoutInProgress', todayISO);
    window.location.href = 'workout.html?start=today';
  } else {
    // Navigate to the selected date
    window.location.href = `workout.html?date=${selectedWorkoutDate}`;
  }
});

document.getElementById('analytics').addEventListener('click', ()=>{
  window.location.href = 'analytics.html';
});


// Workout navigation
document.getElementById('prevWorkout').addEventListener('click', () => {
  const allDates = [...new Set([todayISO, ...workouts.map(w => w.date)])].sort().reverse();
  const currentIndex = allDates.indexOf(selectedWorkoutDate);
  
  if (currentIndex < allDates.length - 1) {
    selectedWorkoutDate = allDates[currentIndex + 1];
    renderWorkoutPanel();
    renderCalendar();
  }
});

document.getElementById('nextWorkout').addEventListener('click', () => {
  const allDates = [...new Set([todayISO, ...workouts.map(w => w.date)])].sort().reverse();
  const currentIndex = allDates.indexOf(selectedWorkoutDate);
  
  if (currentIndex > 0) {
    selectedWorkoutDate = allDates[currentIndex - 1];
    renderWorkoutPanel();
    renderCalendar();
  }
});

// Calendar navigation
document.getElementById('calPrev').addEventListener('click', () => {
  currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() - 1, 1);
  renderCalendar();
});

document.getElementById('calNext').addEventListener('click', () => {
  currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 1);
  renderCalendar();
});

/* Init */
function renderAll(){
  renderPowerLevel();
  renderWorkoutPanel();
  renderCalendar();
}
renderAll();


/* ---------------- Weight History (stored historically) ---------------- */
const WEIGHT_KEY = 'powerUp:weights';

function getWeightHistory(){
  try{
    const raw = localStorage.getItem(WEIGHT_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}

function setWeightHistory(arr){
  localStorage.setItem(WEIGHT_KEY, JSON.stringify(arr));
}

function upsertWeightEntry(dateISO, weight){
  const arr = getWeightHistory();
  const idx = arr.findIndex(x => x && x.date === dateISO);
  if(idx >= 0){
    arr[idx].weight = weight;
  }else{
    arr.push({ date: dateISO, weight });
  }
  arr.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
  setWeightHistory(arr);

  // Keep backward compatibility: also store in today's workout object if it exists
  const k = `powerUp:${dateISO}`;
  const existing = localStorage.getItem(k);
  if(existing){
    const d = JSON.parse(existing);
    d.bodyWeight = weight;
    localStorage.setItem(k, JSON.stringify(d));
  }
  return arr;
}

function latestWeight(){
  const arr = getWeightHistory();
  if(arr.length){
    const last = arr[arr.length-1];
    return Number(last.weight) || null;
  }
  // fallback: try today's record
  const k = `powerUp:${todayISO}`;
  const existing = localStorage.getItem(k);
  if(existing){
    try{
      const d = JSON.parse(existing);
      if(d && d.bodyWeight) return Number(d.bodyWeight) || null;
    }catch(e){}
  }
  return null;
}

function openWeightModal(){
  const m = document.getElementById('weightModal');
  m.classList.add('open');
  m.setAttribute('aria-hidden','false');
  renderWeightModal();
}

function closeWeightModal(){
  const m = document.getElementById('weightModal');
  m.classList.remove('open');
  m.setAttribute('aria-hidden','true');
}

function renderWeightModal(){
  const list = document.getElementById('weightList');
  const hist = getWeightHistory();
  list.innerHTML = '';

  // Newest first
  [...hist].reverse().forEach(item=>{
    const row = document.createElement('div');
    row.className = 'weight-item';
    const d = new Date(item.date + 'T00:00:00');
    row.innerHTML = `<span>${d.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'})}</span><b>${Number(item.weight).toFixed(1)} lb</b>`;
    list.appendChild(row);
  });

  drawWeightChart(hist);
}

function drawWeightChart(hist){
  const canvas = document.getElementById('weightChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  // handle device pixel ratio
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 760;
  const cssH = canvas.clientHeight || 220;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.scale(dpr, dpr);

  // clear
  ctx.clearRect(0,0,cssW,cssH);

  const pad = {l:44, r:14, t:14, b:34};
  const w = cssW - pad.l - pad.r;
  const h = cssH - pad.t - pad.b;

  const points = (hist||[])
    .filter(x=>x && x.date && isFinite(Number(x.weight)))
    .sort((a,b)=> String(a.date).localeCompare(String(b.date)))
    .map(x=>({ date:x.date, weight:Number(x.weight) }));

  // background grid
  ctx.strokeStyle = 'rgba(255,255,255,.08)';
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad.t + (h*i/4);
    ctx.beginPath();
    ctx.moveTo(pad.l, y);
    ctx.lineTo(pad.l+w, y);
    ctx.stroke();
  }

  if(points.length < 2){
    ctx.fillStyle = 'rgba(255,255,255,.5)';
    ctx.font = '12px system-ui';
    ctx.fillText(points.length ? 'Add one more weigh-in to see a chart.' : 'No weigh-ins yet.', pad.l, pad.t + 18);
    return;
  }

  const minW = Math.min(...points.map(p=>p.weight));
  const maxW = Math.max(...points.map(p=>p.weight));
  const range = Math.max(1, maxW - minW);

  const xFor = (i)=> pad.l + (w * (i/(points.length-1)));
  const yFor = (val)=> pad.t + h - (h * ((val - minW)/range));

  // line
  ctx.strokeStyle = '#22c55e';
  ctx.lineWidth = 2;
  ctx.beginPath();
  points.forEach((p,i)=>{
    const x = xFor(i);
    const y = yFor(p.weight);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // points
  ctx.fillStyle = '#22c55e';
  points.forEach((p,i)=>{
    const x = xFor(i);
    const y = yFor(p.weight);
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  // y-axis labels (min/max)
  ctx.fillStyle = 'rgba(255,255,255,.65)';
  ctx.font = '12px system-ui';
  ctx.fillText(`${minW.toFixed(1)}`, 8, yFor(minW)+4);
  ctx.fillText(`${maxW.toFixed(1)}`, 8, yFor(maxW)+4);

  // x-axis labels (first/last)
  const firstD = new Date(points[0].date+'T00:00:00');
  const lastD = new Date(points[points.length-1].date+'T00:00:00');
  ctx.fillText(firstD.toLocaleDateString(undefined,{month:'short', day:'numeric'}), pad.l, pad.t+h+24);
  const lastLabel = lastD.toLocaleDateString(undefined,{month:'short', day:'numeric'});
  const lw = ctx.measureText(lastLabel).width;
  ctx.fillText(lastLabel, pad.l+w-lw, pad.t+h+24);
}

/* Wire up weight button + modal */
(function(){
  const btn = document.getElementById('currentWeightBtn');
  if(btn){
    const w = latestWeight();
    btn.textContent = (w!=null) ? `${w.toFixed(1)} lb` : '—';
    btn.addEventListener('click', openWeightModal);
  }

  const modal = document.getElementById('weightModal');
  if(modal){
    modal.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.getAttribute && t.getAttribute('data-close')) closeWeightModal();
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modal.classList.contains('open')) closeWeightModal();
    });
  }

  const addBtn = document.getElementById('addWeightBtn');
  if(addBtn){
    addBtn.addEventListener('click', ()=>{
      const raw = prompt("Enter today's weight (lb):");
      if(!raw) return;
      const val = Number(raw);
      if(!isFinite(val) || val<=0) return alert('Please enter a valid weight.');
      upsertWeightEntry(todayISO, val);
      // update pill text
      const btn2 = document.getElementById('currentWeightBtn');
      if(btn2) btn2.textContent = `${val.toFixed(1)} lb`;
      renderWeightModal();
    });
  }
})();

</script>

<!-- Weight History Modal -->
<div class="modal" id="weightModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-label="Weight history">
    <div class="modal-head">
      <div class="modal-title">Weight History</div>
      <button class="modal-close" type="button" data-close="1">✕</button>
    </div>
    <canvas id="weightChart" width="760" height="220"></canvas>
    <div class="modal-actions">
      <button class="cta small" id="addWeightBtn" type="button">Add weigh-in</button>
    </div>
    <div class="weight-list" id="weightList"></div>
  </div>
</div>

</body>
</html>