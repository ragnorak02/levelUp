<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Power Up! ‚Äî Today</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121a23; --ink:#e8eef6; --muted:#9fb0c7; --ring:#263341;
    --accent:#4CAF50; --danger:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    background:linear-gradient(180deg,#0a0e13 0%, #0d131a 100%); color:var(--ink);
    display:flex; flex-direction:column;
  }
  header{
    background:#0e141b; border-bottom:1px solid var(--ring);
    color:var(--ink); padding:10px;
  }
  .bar{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .home{all:unset; cursor:pointer; border:1px solid var(--ring); padding:.35rem .6rem; border-radius:.6rem}
  h1{margin:0; font-size:1rem}
  .date-nav{display:flex; align-items:center; gap:10px}
  .date-nav button{all:unset; cursor:pointer; padding:.3rem .5rem; border:1px solid var(--ring); border-radius:.5rem}
  .date-str{min-width:9.5ch; text-align:center}
  .icons{display:flex; gap:8px}

  .wrap{width:min(900px,100%); margin-inline:auto; padding:10px; display:flex; flex-direction:column; gap:10px; flex:1}
  .totals{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:10px;
    font-size:.95rem;
  }
  .chip{background:#0f1720; border:1px solid var(--ring); padding:.35rem .6rem; border-radius:999px; color:var(--muted)}
  .chip b{color:var(--ink)}

  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    all:unset; cursor:pointer; padding:.7rem 1rem; border-radius:12px; font-weight:700;
    background:linear-gradient(90deg,#4CAF50,#22c55e); color:#04130a; box-shadow:0 6px 20px rgba(34,197,94,.25)
  }
  .btn-ghost{all:unset; cursor:pointer; padding:.6rem .9rem; border:1px solid var(--ring); border-radius:10px; color:var(--muted)}
  .btn-danger{all:unset; cursor:pointer; padding:.45rem .6rem; border:1px solid #3a2227; border-radius:8px; color:#fecaca; background:#2a0f12}
  .btn-small{padding:.35rem .55rem; font-size:.85rem}

  .group{background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:10px; margin-top:6px}
  .group h3{margin:.1rem 0 .4rem; font-size:1rem; color:var(--muted)}
  .ex{border:1px dashed var(--ring); border-radius:12px; padding:10px; margin:8px 0; display:grid; gap:8px}
  .ex-header{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .ex-name{font-weight:700}
  .set-row{display:grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap:6px; align-items:center}
  .set-row input{width:100%; padding:.55rem .6rem; border:1px solid var(--ring); border-radius:8px; background:#0f141b; color:var(--ink)}
  .set-row .done{display:flex; align-items:center; gap:6px; color:var(--muted); font-size:.9rem}
  .set-row .tools{display:flex; gap:6px}
  .tag{font-size:.85rem; color:var(--muted)}
  .sum{font-size:.9rem; color:var(--muted)}
  .flex{display:flex; gap:6px; flex-wrap:wrap}
  .hidden{display:none!important}

  /* Popups */
  .popup{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:10px}
  .sheet{width:min(650px, 96%); max-height:85vh; overflow:auto; background:#0f141b; border:1px solid var(--ring); border-radius:14px; padding:12px}
  .sheet h2{margin:6px 0 10px; font-size:1rem; color:var(--muted)}
  .x{all:unset; cursor:pointer; float:right; border:1px solid var(--ring); padding:.25rem .5rem; border-radius:8px; color:var(--muted)}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
  .opt{border:1px solid var(--ring); padding:10px; border-radius:10px; cursor:pointer; background:#111922}
  .opt:hover{outline:1px solid #2b3a4a}
  .search{width:100%; padding:.6rem .7rem; border:1px solid var(--ring); border-radius:10px; background:#0f141b; color:var(--ink); margin-bottom:8px}

  /* Calendar */
  .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
  .cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin:4px 0; color:var(--muted); font-size:.85rem}
  .cal-cell{border:1px solid var(--ring); border-radius:8px; padding:8px; text-align:center; background:#0f141b}
  .cal-cell.workout{background:#0e1a12}
  .cal-nav{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px}
  .cal-nav button{all:unset; cursor:pointer; border:1px solid var(--ring); padding:.3rem .6rem; border-radius:8px}

  /* Mobile bottom space to avoid overlap with nav bars */
  .spacer{height:70px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <button class="home" onclick="location.href='summary.html'">‚üµ Home</button>
    <h1>Power Up! ‚Äî Today‚Äôs Workout</h1>
    <div class="icons">
      <button class="home" id="openCalendar">üìÖ</button>
    </div>
  </div>
  <div class="bar" style="margin-top:6px">
    <div class="date-nav">
      <button id="prevDay">‚Üê</button>
      <div class="date-str" id="dateStr">‚Äî</div>
      <button id="nextDay">‚Üí</button>
    </div>
    <div class="actions">
      <button class="btn" id="addExercise">Add Exercise</button>
      <button class="btn-ghost" id="saveBtn">Save</button>
      <button class="btn-ghost" id="clearBtn">Clear Day</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="totals" id="totalsBar">
    <span class="chip">Sets: <b id="tSets">0</b></span>
    <span class="chip">Volume: <b id="tVol">0 lb</b></span>
    <span class="chip">Exercises: <b id="tEx">0</b></span>
    <span class="chip">Status: <b id="tStatus">Not started</b></span>
  </section>

  <div id="log"></div>

  <div class="spacer"></div>
</main>

<!-- Body Part sheet -->
<div class="popup" id="bpPopup">
  <div class="sheet">
    <button class="x" data-close="#bpPopup">‚úï</button>
    <h2>Select Body Part</h2>
    <div class="grid" id="bpGrid"></div>
  </div>
</div>

<!-- Exercise sheet -->
<div class="popup" id="exPopup">
  <div class="sheet">
    <button class="x" data-close="#exPopup">‚úï</button>
    <h2 id="exTitle">Choose Exercise</h2>
    <input class="search" id="exSearch" placeholder="Search exercise‚Ä¶" />
    <div class="grid" id="exGrid"></div>
  </div>
</div>

<!-- Calendar sheet -->
<div class="popup" id="calPopup">
  <div class="sheet">
    <button class="x" data-close="#calPopup">‚úï</button>
    <div class="cal-nav">
      <button id="calPrev">‚Üê</button>
      <div id="calMonth">‚Äî</div>
      <button id="calNext">‚Üí</button>
    </div>
    <div class="cal-head">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="calendar" id="calGrid"></div>
  </div>
</div>

<script>
/* ------------------ Demo exercise catalog ------------------ */
const exerciseOptions = {
  Chest: ['Bench Press','Incline Bench Press','Dumbbell Press','Dumbbell Flyes','Cable Fly','Chest Dips'],
  Back: ['Deadlift','Bent Over Row','Seated Cable Row','Lat Pulldown','One-arm DB Row','Chest-supported Row'],
  Biceps: ['Barbell Curl','DB Curl','Hammer Curl','Incline DB Curl','Cable Curl','Concentration Curl'],
  Triceps: ['Close-grip Bench','Skull Crushers','Cable Pushdown','Overhead Extension','Dips'],
  Shoulders: ['Overhead Press','Lateral Raise','Front Raise','Rear Delt Fly','Arnold Press','Upright Row','Shrug'],
  Legs: ['Back Squat','Front Squat','Leg Press','RDL','Lunge','Leg Extension','Ham Curl','Calf Raise'],
  Lats: ['Pull-up','Chin-up','Close Grip Pulldown','Pullover Machine']
};
const bodyParts = Object.keys(exerciseOptions);

/* ------------------ State & storage ------------------ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayISO = () => new Date().toISOString().slice(0,10);
let current = new Date(); // navigable
const keyFor = (d)=>`powerUp:${d.toISOString().slice(0,10)}`;

function blankDay(date){
  return { date: date.toISOString().slice(0,10), totalWeight:0, totalSets:0, exercises:[] };
}
function loadDay(date){
  const raw = localStorage.getItem(keyFor(date));
  return raw ? JSON.parse(raw) : blankDay(date);
}
function saveDay(day){
  localStorage.setItem(`powerUp:${day.date}`, JSON.stringify(day));
}

/* ------------------ Rendering ------------------ */
function render(){
  // header date
  $('#dateStr').textContent = new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'numeric'}).format(current);

  const day = loadDay(current);
  const log = $('#log');
  log.innerHTML = '';

  // groups by body part
  const groups = groupBy(day.exercises, 'bodyPart'); // {Chest:[...]}
  Object.entries(groups).forEach(([bp, list])=>{
    const g = document.createElement('div');
    g.className = 'group';
    g.dataset.bodypart = bp;
    g.innerHTML = `<h3>${bp}</h3>`;
    list.forEach(ex=> g.appendChild(renderExercise(ex)));
    log.appendChild(g);
  });

  // totals
  const {sets, vol} = calcTotals(day);
  $('#tSets').textContent = sets;
  $('#tVol').textContent = Math.round(vol) + ' lb';
  $('#tEx').textContent = day.exercises.length;
  $('#tStatus').textContent = sets === 0 ? 'Not started' : (areAllSetsDone(day) ? 'Completed' : 'In progress');

  // refresh calendar if open
  if ($('#calPopup').style.display === 'flex') buildCalendar(current);
}

function renderExercise(ex){
  const node = document.createElement('div');
  node.className = 'ex';
  node.dataset.id = ex.id;

  const sum = ex.sets.map(s=> (s.weight||0)*(s.reps||0)).reduce((a,b)=>a+b,0);
  node.innerHTML = `
    <div class="ex-header">
      <div>
        <div class="ex-name">${ex.name}</div>
        <div class="tag">${ex.sets.length} set(s) ‚Ä¢ ${Math.round(sum)} lb</div>
      </div>
      <div class="flex">
        <button class="btn-ghost btn-small" data-act="addSet">+ Set</button>
        <button class="btn-ghost btn-small" data-act="dupLast">Duplicate Last</button>
        <button class="btn-danger btn-small" data-act="delEx">Delete</button>
      </div>
    </div>
    <div class="sets"></div>
  `;
  const setsWrap = node.querySelector('.sets');
  ex.sets.forEach((s, i)=> setsWrap.appendChild(renderSet(ex.id, s, i)));
  return node;
}

function renderSet(exId, s, idx){
  const row = document.createElement('div');
  row.className = 'set-row';
  row.dataset.exId = exId;
  row.dataset.idx = idx;

  row.innerHTML = `
    <input inputmode="decimal" pattern="[0-9.]*" placeholder="Weight" value="${s.weight ?? ''}" data-field="weight" />
    <input inputmode="numeric" pattern="[0-9]*" placeholder="Reps" value="${s.reps ?? ''}" data-field="reps" />
    <input inputmode="decimal" pattern="[0-9.]*" placeholder="RPE (opt)" value="${s.rpe ?? ''}" data-field="rpe" />
    <label class="done"><input type="checkbox" ${s.done?'checked':''} data-field="done" /> Done</label>
    <div class="tools">
      <button class="btn-ghost btn-small" data-act="incW">+5</button>
      <button class="btn-ghost btn-small" data-act="decW">-5</button>
      <button class="btn-danger btn-small" data-act="delSet">‚úï</button>
    </div>
  `;
  return row;
}

/* ------------------ Helpers ------------------ */
function groupBy(arr, key){ return arr.reduce((m,o)=>((m[o[key]]??=[]).push(o),m),{}); }
function uid(){ return Math.random().toString(36).slice(2,9); }
function calcTotals(day){
  let sets=0, vol=0;
  day.exercises.forEach(ex=> ex.sets.forEach(s=>{ sets++; vol += (Number(s.weight)||0)*(Number(s.reps)||0); }));
  return {sets, vol};
}
function areAllSetsDone(day){
  const all = day.exercises.flatMap(ex=> ex.sets);
  return all.length>0 && all.every(s=> !!s.done);
}

/* ------------------ Popups ------------------ */
function openPopup(id){ $(id).style.display='flex'; }
function closePopup(id){ $(id).style.display='none'; }
$$('.x').forEach(btn=> btn.addEventListener('click', e=> closePopup(e.target.dataset.close)));

/* Body part -> exercise flow */
$('#addExercise').addEventListener('click', ()=>{
  const grid = $('#bpGrid'); grid.innerHTML = '';
  bodyParts.forEach(bp=>{
    const div = document.createElement('div');
    div.className = 'opt'; div.textContent = bp; div.dataset.bp = bp;
    grid.appendChild(div);
  });
  openPopup('#bpPopup');
});

$('#bpGrid').addEventListener('click', (e)=>{
  const bp = e.target.closest('.opt')?.dataset.bp; if(!bp) return;
  closePopup('#bpPopup');
  // populate ex list
  $('#exTitle').textContent = `Exercises ‚Äî ${bp}`;
  const grid = $('#exGrid'); grid.innerHTML = '';
  const list = exerciseOptions[bp];
  list.forEach(name=>{
    const div = document.createElement('div'); div.className='opt'; div.textContent = name; div.dataset.name = name; div.dataset.bp = bp;
    grid.appendChild(div);
  });
  $('#exSearch').value='';
  openPopup('#exPopup');
});

$('#exSearch').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  $$('#exGrid .opt').forEach(x=>{
    x.style.display = x.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});

$('#exGrid').addEventListener('click', (e)=>{
  const opt = e.target.closest('.opt'); if(!opt) return;
  const name = opt.dataset.name; const bp = opt.dataset.bp;
  closePopup('#exPopup');

  // add exercise with a first empty set
  const day = loadDay(current);
  const ex = { id: uid(), bodyPart: bp, name, sets:[{weight:'', reps:'', rpe:'', done:false}] };
  day.exercises.push(ex); saveDay(day); render();
});

/* ------------------ Exercise / Set interactions ------------------ */
$('#log').addEventListener('click', (e)=>{
  const act = e.target.dataset.act;
  if(!act) return;

  const day = loadDay(current);

  if(act==='delEx'){
    const exId = e.target.closest('.ex').dataset.id;
    day.exercises = day.exercises.filter(x=>x.id!==exId);
    saveDay(day); render(); return;
  }
  if(act==='addSet'){
    const exId = e.target.closest('.ex').dataset.id;
    const ex = day.exercises.find(x=>x.id===exId);
    ex.sets.push({weight:'', reps:'', rpe:'', done:false});
    saveDay(day); render(); return;
  }
  if(act==='dupLast'){
    const exId = e.target.closest('.ex').dataset.id;
    const ex = day.exercises.find(x=>x.id===exId);
    const last = ex.sets[ex.sets.length-1] || {weight:'', reps:'', rpe:''};
    ex.sets.push({weight:last.weight, reps:last.reps, rpe:last.rpe, done:false});
    saveDay(day); render(); return;
  }
  if(act==='delSet' || act==='incW' || act==='decW'){
    const row = e.target.closest('.set-row');
    const ex = day.exercises.find(x=>x.id===row.dataset.exId);
    const idx = Number(row.dataset.idx);
    if(act==='delSet'){
      ex.sets.splice(idx,1);
      if(ex.sets.length===0){
        // remove empty exercise
        day.exercises = day.exercises.filter(x=>x.id!==ex.id);
      }
    }else{
      const delta = act==='incW' ? 5 : -5;
      const w = Number(ex.sets[idx].weight||0);
      ex.sets[idx].weight = Math.max(0, w + delta);
    }
    saveDay(day); render(); return;
  }
});

/* inputs & checkbox autosave */
$('#log').addEventListener('input', (e)=>{
  const row = e.target.closest('.set-row'); if(!row) return;
  const day = loadDay(current);
  const ex = day.exercises.find(x=>x.id===row.dataset.exId);
  const idx = Number(row.dataset.idx);
  const f = e.target.dataset.field;
  let val = e.target.value;
  if(f==='weight' || f==='reps' || f==='rpe'){ val = val.replace(/[^\d.]/g,''); }
  if(f==='weight' || f==='rpe') ex.sets[idx][f] = val;
  if(f==='reps') ex.sets[idx][f] = val;
  saveDay(day);
  // Update small summary under exercise name without full re-render
  const sum = ex.sets.map(s=>(Number(s.weight)||0)*(Number(s.reps)||0)).reduce((a,b)=>a+b,0);
  row.closest('.ex').querySelector('.tag').textContent = `${ex.sets.length} set(s) ‚Ä¢ ${Math.round(sum)} lb`;
  // Update totals bar
  const {sets, vol} = calcTotals(day);
  $('#tSets').textContent = sets; $('#tVol').textContent = Math.round(vol)+' lb';
});

$('#log').addEventListener('change', (e)=>{
  if(e.target.dataset.field !== 'done') return;
  const row = e.target.closest('.set-row');
  const day = loadDay(current);
  const ex = day.exercises.find(x=>x.id===row.dataset.exId);
  const idx = Number(row.dataset.idx);
  ex.sets[idx].done = e.target.checked;
  saveDay(day);
  $('#tStatus').textContent = areAllSetsDone(day) ? 'Completed' : 'In progress';
});

/* ------------------ Save / Clear ------------------ */
$('#saveBtn').addEventListener('click', ()=>{
  const day = loadDay(current);
  saveDay(day);
  $('#saveBtn').textContent = 'Saved ‚úî';
  setTimeout(()=> $('#saveBtn').textContent='Save', 1200);
});
$('#clearBtn').addEventListener('click', ()=>{
  if(!confirm('Clear all exercises for this day?')) return;
  saveDay(blankDay(current)); render();
});

/* ------------------ Date nav & calendar ------------------ */
$('#prevDay').addEventListener('click', ()=>{ current.setDate(current.getDate()-1); render(); });
$('#nextDay').addEventListener('click', ()=>{ current.setDate(current.getDate()+1); render(); });

$('#openCalendar').addEventListener('click', ()=>{ openPopup('#calPopup'); buildCalendar(current); });
$('#calPrev').addEventListener('click', ()=>{ shiftCalendar(-1); });
$('#calNext').addEventListener('click', ()=>{ shiftCalendar(1); });

function shiftCalendar(delta){
  const d = new Date($('#calMonth').dataset.anchor);
  d.setMonth(d.getMonth()+delta);
  buildCalendar(d);
}

function buildCalendar(anchorDate){
  const y = anchorDate.getFullYear(), m = anchorDate.getMonth();
  $('#calMonth').textContent = new Intl.DateTimeFormat(undefined,{month:'long',year:'numeric'}).format(anchorDate);
  $('#calMonth').dataset.anchor = new Date(y,m,1).toISOString();

  const grid = $('#calGrid'); grid.innerHTML='';
  const first = new Date(y,m,1).getDay();
  const last = new Date(y,m+1,0).getDate();

  for(let i=0;i<first;i++){ const c=document.createElement('div'); c.className='cal-cell'; c.style.visibility='hidden'; grid.appendChild(c); }
  for(let d=1; d<=last; d++){
    const c = document.createElement('div'); c.className='cal-cell'; c.textContent = d;
    const dateISO = new Date(y,m,d).toISOString().slice(0,10);
    if(localStorage.getItem(`powerUp:${dateISO}`)){
      const day = JSON.parse(localStorage.getItem(`powerUp:${dateISO}`));
      if(day.exercises?.length) c.classList.add('workout');
    }
    c.addEventListener('click', ()=>{
      current = new Date(y,m,d);
      closePopup('#calPopup');
      render();
    });
    grid.appendChild(c);
  }
}

/* ------------------ Boot ------------------ */
(function init(){
  // if landing today and there's a previous save under old key 'powerUp', migrate
  const legacy = localStorage.getItem('powerUp');
  if(legacy){
    try{
      const data = JSON.parse(legacy);
      if(data?.date){ localStorage.setItem(`powerUp:${data.date}`, legacy); }
    }catch{}
  }
  // Start at today
  current = new Date(); render();
})();
</script>
</body>
</html>
