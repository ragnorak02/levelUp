<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Receipts</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7;
      --accent:#4CAF50; --accent2:#2dd4bf;
      --ring:#2a3543; --good:#22c55e; --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 50% -200px, rgba(245,158,11,.10), transparent 55%),
        radial-gradient(900px 700px at 10% 0%, rgba(34,197,94,.06), transparent 60%),
        var(--bg);
      color:var(--ink);
      min-height:100vh;
      padding-bottom: 80px;
    }
    a{color:inherit; text-decoration:none}

    /* --- TOPBAR (copied from index.html) --- */
    .topbar{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.72));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(42,53,67,.55);
    }
    .topbar-inner{
      max-width:1120px; margin:0 auto;
      padding:6px 10px;
      display:flex; align-items:center; gap:10px;
      flex-wrap:nowrap;
    }
    .brand-group{display:flex; align-items:center; gap:8px; flex:0 0 auto;}
    .brand{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      box-shadow: var(--shadow);
      flex:0 0 auto;
      white-space:nowrap;
    }
    .brand-group .brand.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }
    .nav{
      margin-left:auto;
      display:flex; gap:8px;
      align-items:center;
      flex:1 1 auto;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      white-space:nowrap;
      padding-bottom:2px;
    }
    .nav::-webkit-scrollbar{height:6px}
    .nav::-webkit-scrollbar-thumb{background:rgba(42,53,67,.6); border-radius:999px}
    .pill{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(42,53,67,.75);
      background: rgba(19,26,34,.55);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }
    .pill.active{
      color:#0b0f14;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      border-color: transparent;
    }

    .wrap{ max-width:1120px; margin:0 auto; padding: 16px; }

    /* Filter Bar */
    .filter-bar{
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .filter-row{
      display:flex; gap:10px; margin-bottom: 10px;
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
    }
    .filter-row::-webkit-scrollbar{display:none}
    .filter-btn{
      all:unset; cursor:pointer;
      padding:8px 12px;
      border-radius: 999px;
      font-size: 13px; font-weight: 900;
      border:1px solid rgba(42,53,67,.70);
      background: rgba(11,15,20,.35);
      color: var(--muted);
      white-space:nowrap;
      min-height: 38px;
      display:flex; align-items:center; gap:8px;
    }
    .filter-btn.active{
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      color:#0b0f14;
      border-color: transparent;
    }

    /* Stats Bar */
    .stats-bar{
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: 16px;
      padding: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      display:flex; justify-content:space-around; text-align:center;
    }
    .stat{ flex:1; }
    .stat-value{ font-size: 22px; font-weight: 950; color: var(--good); }
    .stat-label{ font-size: 12px; color: var(--muted); font-weight: 800; margin-top: 2px; }

    /* Compact rows */
    .receipt-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      background: rgba(19,26,34,.72);
      border:1px solid rgba(42,53,67,.70);
      border-radius: 16px;
      padding: 10px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .receipt-main{
      all:unset; cursor:pointer;
      display:flex; align-items:center; gap:12px;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(11,15,20,.35);
      border:1px solid rgba(42,53,67,.55);
      min-height: 56px;
    }
    .receipt-left{ flex:1; min-width:0; }
    .receipt-store{
      font-weight: 950;
      font-size: 16px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .receipt-sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .receipt-right{ display:flex; align-items:center; gap:10px; flex-shrink:0; }
    .receipt-amount{ font-weight: 950; font-size: 16px; color: var(--good); }
    .receipt-chevron{
      width: 28px; height: 28px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 999px;
      border:1px solid rgba(42,53,67,.70);
      color: var(--muted);
      background: rgba(11,15,20,.35);
      font-weight: 950;
    }
    .receipt-delete{
      all:unset; cursor:pointer;
      width: 40px; height: 40px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      color: var(--danger);
      font-size: 16px;
      font-weight: 950;
    }
    .receipt-details{
      grid-column: 1 / -1;
      display:none;
      padding: 6px 10px 10px;
      border-top: 1px solid rgba(42,53,67,.45);
      margin-top: 2px;
    }
    .receipt-details.show{ display:block; }
    .item-row{
      display:flex; justify-content:space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(42,53,67,.35);
      font-size: 14px;
    }
    .item-row:last-child{ border-bottom:none; }
    .item-name{ flex:1; color: var(--ink); }
    .item-price{ font-weight: 900; color: rgba(45,212,191,.95); margin-left: 12px; }

    .receipt-cat-badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.25);
      color:var(--good);
      margin-left:8px;
      vertical-align:middle;
    }
    .empty-state{
      text-align:center; padding: 50px 16px; color: var(--muted);
      background: rgba(19,26,34,.40);
      border:1px dashed rgba(42,53,67,.70);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .empty-icon{ font-size: 44px; margin-bottom: 10px; opacity:.7; }
    .empty-title{ font-size: 18px; font-weight: 950; color: var(--ink); margin-bottom: 8px; }

    .add-btn{
      all:unset; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(76,175,80,1), rgba(45,212,191,1));
      color:#0b0f14;
      border-radius: 14px;
      font-weight: 950;
      margin-top: 14px;
    }
  </style>
  <script src="dataLoader.js"></script>
</head>
<body>
  <!-- TOPBAR (standardized) -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand-group" role="navigation" aria-label="Home and Finances">
        <a class="brand brand-home" href="https://ragnorak02.github.io/levelUp/main.html" title="Back to LevelUp Home">üè† <span>Home</span></a>
        <a class="brand brand-fin active" href="index.html" title="Finances dashboard">üí∞</a>
      </div>
      <div class="nav">
        <a class="pill" href="index.html">Finances</a>
        <a class="pill" href="food.html">Food</a>
        <a class="pill" href="search.html">Search</a>
        <a class="pill active" href="receipts.html">Receipts</a>
      </div>
    </div>
  </div>

  <main class="wrap">
    <div class="filter-bar">
      <div class="filter-row" id="storeFilters">
        <button class="filter-btn active" data-store="all">All Stores</button>
      </div>
      <div class="filter-row" id="dateFilters">
        <button class="filter-btn active" data-period="all">All Time</button>
        <button class="filter-btn" data-period="month">This Month</button>
        <button class="filter-btn" data-period="week">This Week</button>
      </div>
    </div>

    <div class="stats-bar" id="statsBar">
      <div class="stat">
        <div class="stat-value" id="totalReceipts">0</div>
        <div class="stat-label">Receipts</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="totalSpent">$0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="avgReceipt">$0</div>
        <div class="stat-label">Average</div>
      </div>
    </div>

    <div id="receiptsList"></div>
  </main>

  <script>
    const STORAGE_KEY = 'finances:receipts';

    function loadReceipts() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch (e) { console.error('Error loading receipts:', e); return []; }
    }

    let allReceipts = [];
    let filteredReceipts = [];
    let activeStore = 'all';
    let activePeriod = 'all';

    // Read ?month=YYYY-MM from query params (passed from dashboard/finance page)
    const urlParams = new URLSearchParams(window.location.search);
    const queryMonth = urlParams.get('month'); // e.g. "2026-02"

    // If month param is present, default to month filter
    if (queryMonth && /^\d{4}-\d{2}$/.test(queryMonth)) {
      activePeriod = 'month';
    }

    (async function initReceiptsPage() {
      await (window.FinancesDataLoader?.ready || Promise.resolve());
      allReceipts = loadReceipts();

      // Activate the month filter button if query param present
      if (activePeriod === 'month') {
        document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
        const monthBtn = document.querySelector('[data-period="month"]');
        if (monthBtn) monthBtn.classList.add('active');
      }

      applyFilters();
      render();
    })();

    function applyFilters() {
      const now = new Date();
      let out = [...allReceipts];

      if (activeStore !== 'all') {
        const norm = activeStore.trim().toLowerCase();
        out = out.filter(r => (r.store || '').trim().toLowerCase() === norm);
      }

      if (activePeriod === 'month') {
        // Use query param month if available, otherwise current month
        let filterYear, filterMonth;
        if (queryMonth && /^\d{4}-\d{2}$/.test(queryMonth)) {
          const [y, m] = queryMonth.split('-').map(Number);
          filterYear = y;
          filterMonth = m - 1; // 0-indexed
        } else {
          filterYear = now.getFullYear();
          filterMonth = now.getMonth();
        }
        out = out.filter(r => {
          const d = new Date(r.date);
          return d.getMonth() === filterMonth && d.getFullYear() === filterYear;
        });
      } else if (activePeriod === 'week') {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        out = out.filter(r => new Date(r.date) >= weekAgo);
      }

      filteredReceipts = out;
    }

    function render() {
      if (allReceipts.length === 0) {
        showEmptyState();
        return;
      }
      renderStoreFilters();
      renderReceipts();
      updateStats();
    }

    function showEmptyState() {
      document.getElementById('receiptsList').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üßæ</div>
          <div class="empty-title">No Receipts Yet</div>
          <p>Start tracking your spending by adding your first receipt</p>
          <button class="add-btn" onclick="location.href='addReceipt.html'">üìù Add Receipt</button>
        </div>
      `;
      document.getElementById('statsBar').style.display = 'none';
      document.querySelector('.filter-bar').style.display = 'none';
    }

    function renderStoreFilters() {
      // Deduplicate stores by normalized key, keep first casing
      const seen = new Map();
      allReceipts.forEach(r => {
        const norm = (r.store || '').trim().toLowerCase();
        if (!seen.has(norm)) seen.set(norm, (r.store || '').trim());
      });
      const stores = [...seen.values()];
      const container = document.getElementById('storeFilters');

      container.innerHTML = `<button class="filter-btn ${activeStore==='all' ? 'active' : ''}" data-store="all">All Stores</button>`;
      container.querySelector('[data-store="all"]').addEventListener('click', (e) => onStoreSelected('all', e));

      stores.forEach(store => {
        const isActive = activeStore !== 'all' && store.trim().toLowerCase() === activeStore.trim().toLowerCase();
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (isActive ? ' active' : '');
        btn.dataset.store = store;
        btn.textContent = store;
        btn.addEventListener('click', (e) => onStoreSelected(store, e));
        container.appendChild(btn);
      });
    }

    function onStoreSelected(store, e) {
      activeStore = store;
      document.querySelectorAll('[data-store]').forEach(btn => btn.classList.remove('active'));
      e.currentTarget.classList.add('active');
      applyFilters();
      renderReceipts();
      updateStats();
    }

    document.querySelectorAll('[data-period]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        activePeriod = btn.dataset.period;
        applyFilters();
        renderReceipts();
        updateStats();
      });
    });

    function renderReceipts() {
      const container = document.getElementById('receiptsList');
      container.innerHTML = '';

      const sorted = [...filteredReceipts].sort((a, b) => new Date(b.date) - new Date(a.date));

      if (sorted.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <div class="empty-title">No Receipts Found</div>
            <p>No receipts match your current filters. Try changing the store or date range.</p>
          </div>
        `;
        return;
      }

      sorted.forEach((receipt, index) => container.appendChild(createReceiptRow(receipt, index)));
    }

    function createReceiptRow(receipt, index) {
      const row = document.createElement('div');
      row.className = 'receipt-row';

      const id = `r${index}`;

      const dateStr = new Date(receipt.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      row.innerHTML = `
        <button class="receipt-main" type="button" onclick="toggleReceiptDetails('${id}')" aria-expanded="false" aria-controls="details_${id}">
          <div class="receipt-left">
            <div class="receipt-store">${receipt.store}${receipt.category ? `<span class="receipt-cat-badge">${receipt.category}</span>` : ''}</div>
            <div class="receipt-sub">${dateStr} ‚Ä¢ ${(receipt.items||[]).length} items</div>
          </div>
          <div class="receipt-right">
            <div class="receipt-amount">$${parseFloat(receipt.total || 0).toFixed(2)}</div>
            <div class="receipt-chevron" id="chev_${id}">‚ñæ</div>
          </div>
        </button>
        <button class="receipt-delete" type="button" onclick="deleteReceiptById('${receipt.id || ''}')" aria-label="Delete receipt">üóëÔ∏è</button>
        <div class="receipt-details" id="details_${id}">
          ${(receipt.items||[]).map(item => `
            <div class="item-row">
              <span class="item-name">${item.name}</span>
              <span class="item-price">$${parseFloat(item.price || 0).toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
      `;

      return row;
    }

    function toggleReceiptDetails(safeId) {
      const details = document.getElementById(`details_${safeId}`);
      const chev = document.getElementById(`chev_${safeId}`);
      if (!details) return;
      details.classList.toggle('show');
      const expanded = details.classList.contains('show');
      chev.textContent = expanded ? '‚ñ¥' : '‚ñæ';
    }

    function deleteReceiptById(receiptId) {
      if (!confirm('Delete this receipt?')) return;
      if (!receiptId) { alert('This receipt is missing an id and cannot be safely deleted.'); return; }

      const idx = allReceipts.findIndex(r => r.id === receiptId);
      if (idx === -1) return;

      allReceipts.splice(idx, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allReceipts));

      applyFilters();
      render();
    }

    function updateStats() {
      const statsBar = document.getElementById('statsBar');
      if (filteredReceipts.length === 0) {
        if (statsBar) statsBar.style.display = 'none';
        return;
      }
      if (statsBar) statsBar.style.display = '';

      const total = filteredReceipts.reduce((sum, r) => sum + parseFloat(r.total || 0), 0);
      const avg = filteredReceipts.length > 0 ? total / filteredReceipts.length : 0;

      document.getElementById('totalReceipts').textContent = filteredReceipts.length;
      document.getElementById('totalSpent').textContent = '$' + total.toFixed(2);
      document.getElementById('avgReceipt').textContent = '$' + avg.toFixed(2);
    }
  </script>
</body>
</html>
