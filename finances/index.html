<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finances - Dashboard</title>
  <style>
    :root {
      --bg: #080c11;
      --panel: #0d131a;
      --ink: #e8eef6;
      --muted: #9fb0c7;
      --ring: #1c2a37;
      --accent: #4CAF50;
      --accent-2: #2dd4bf;
      --danger: #ef4444;
      --warn: #f59e0b;
      --card-bg: #0e141b;
      --hover-bg: #1a1f26;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      background: linear-gradient(180deg, #070b10 0%, #0a1016 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    header {
      background: #0b1118;
      border-bottom: 1px solid var(--ring);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .home-btn {
      all: unset;
      cursor: pointer;
      border: 1px solid var(--ring);
      padding: .4rem .7rem;
      border-radius: .6rem;
      font-size: .9rem;
      color: var(--muted);
      transition: background 0.2s;
    }

    .home-btn:hover { background: var(--hover-bg); }

    h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .nav-pills {
      display: flex;
      gap: 6px;
      background: var(--panel);
      padding: 4px;
      border-radius: 10px;
      border: 1px solid var(--ring);
      flex-wrap: wrap;
    }

    .nav-pill {
      all: unset;
      cursor: pointer;
      padding: .4rem .8rem;
      border-radius: 8px;
      font-size: .85rem;
      color: var(--muted);
      transition: all .2s;
      white-space: nowrap;
    }

    .nav-pill.active {
      background: linear-gradient(90deg, var(--accent), #22c55e);
      color: #04130a;
      font-weight: 600;
    }

    .wrap {
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .25);
    }

    .card h3 {
      margin: 0 0 12px;
      font-size: 1rem;
      color: var(--muted);
      font-weight: 600;
    }

    /* Search Bar */
    .search-bar { position: relative; margin-bottom: 20px; }
    .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: var(--card-bg);
      border: 1px solid var(--ring);
      border-radius: 10px;
      color: var(--ink);
      font-size: 1rem;
    }
    .search-input:focus { outline: none; border-color: var(--accent); }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      color: var(--muted);
    }

    /* Category Filters */
    .category-filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .filter-btn {
      all: unset;
      cursor: pointer;
      padding: .6rem .9rem;
      border-radius: 10px;
      font-size: .9rem;
      font-weight: 600;
      border: 2px solid var(--ring);
      background: var(--card-bg);
      color: var(--muted);
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .filter-btn:hover { background: var(--hover-bg); border-color: var(--accent); }
    .filter-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #04130a;
      border-color: var(--accent);
    }
    .filter-btn:not(.active) { opacity: 0.5; }
    .filter-btn-small { padding: .4rem .7rem; font-size: .85rem; border: 1px solid var(--ring); }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--ring);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: .85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .stat-trend { font-size: .8rem; margin-top: 4px; }
    .trend-up { color: var(--danger); }
    .trend-down { color: var(--accent); }

    /* Charts */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 12px 0 8px;
      display: grid;
      place-items: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    canvas { max-width: 100%; max-height: 100%; }

    /* Donut selection label (above chart) */
    .donut-selection {
      text-align: center;
      margin: 2px 0 6px;
      min-height: 22px;
      font-weight: 800;
      color: var(--ink);
    }
    .donut-selection .sub {
      display: block;
      margin-top: 2px;
      font-weight: 600;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* Click hint */
    .chart-hint {
      position: absolute;
      bottom: 8px;
      left: 10px;
      font-size: .8rem;
      color: var(--muted);
      opacity: 0.9;
      pointer-events: none;
    }

    /* Category List */
    .category-list { display: flex; flex-direction: column; gap: 12px; }
    .category-item {
      background: var(--card-bg);
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .category-item:hover { background: var(--hover-bg); border-color: var(--accent); }
    .category-info { display: flex; align-items: center; gap: 12px; }
    .category-icon { font-size: 1.5rem; }
    .category-name { font-weight: 600; color: var(--ink); }
    .category-count { font-size: .85rem; color: var(--muted); }
    .category-amount { font-size: 1.1rem; font-weight: 700; color: var(--accent); }

    /* Color swatch indicator (matches donut slice color) */
    .color-swatch {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
      flex: 0 0 auto;
    }

    /* Budget Progress */
    .budget-item { margin-bottom: 16px; }
    .budget-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .budget-name { font-weight: 600; color: var(--ink); }
    .budget-amounts { font-size: .9rem; color: var(--muted); }
    .budget-bar {
      width: 100%;
      height: 12px;
      background: var(--ring);
      border-radius: 6px;
      overflow: hidden;
    }
    .budget-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 6px;
      transition: width 0.3s ease;
    }
    .budget-progress.over-budget { background: linear-gradient(90deg, var(--danger), #dc2626); }

    /* Action Buttons */
    .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
    .btn {
      all: unset;
      cursor: pointer;
      padding: .7rem 1rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: .9rem;
      text-align: center;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: linear-gradient(90deg, var(--accent), #22c55e);
      color: #04130a;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    .btn-secondary {
      background: var(--card-bg);
      border: 1px solid var(--ring);
      color: var(--muted);
    }
    .btn:hover { transform: translateY(-2px); }

    /* Grid Layout */
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 16px;
    }

    /* Recent Items */
    .recent-list { display: flex; flex-direction: column; gap: 8px; }
    .recent-item {
      background: var(--card-bg);
      border: 1px solid var(--ring);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .9rem;
    }
    .recent-date { color: var(--muted); font-size: .8rem; }
    .recent-store { color: var(--accent-2); font-weight: 600; }
    .recent-amount { font-weight: 700; color: var(--ink); }

    /* Empty State */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2col { grid-template-columns: 1fr; }
      .nav-pills { width: 100%; justify-content: center; }
    }
    @media (max-width: 480px) {
      .wrap { padding: 12px; gap: 12px; }
      .card { padding: 12px; }
      .stat-value { font-size: 1.4rem; }
    }
  </style>
  <script src="dataLoader.js"></script>
</head>
<body>
  <header>
    <button class="home-btn" onclick="location.href='../main.html'">‚üµ Home</button>
    <h1>Finances</h1>
    <nav class="nav-pills">
      <button class="nav-pill active">Dashboard</button>
      <button class="nav-pill" onclick="location.href='food.html'">Food</button>
      <button class="nav-pill" onclick="location.href='search.html'">Search</button>
      <button class="nav-pill" onclick="location.href='receipts.html'">Receipts</button>
      <button class="nav-pill" onclick="location.href='analytics.html'">Analytics</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- Search Bar -->
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="Search items, stores, or categories...">
      <span class="search-icon">üîç</span>
    </div>

    <!-- Category Filters -->
    <div class="card" style="padding: 16px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0;">üìä Category Filters</h3>
        <button class="filter-btn filter-btn-small" id="toggleAll" onclick="toggleAllFilters()">Toggle All</button>
      </div>
      <div class="category-filters" id="categoryFilters"></div>
      <div style="margin-top: 12px; font-size: .85rem; color: var(--muted);">
        üí° Toggle categories OFF to exclude from spending calculations
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalSpent">$0</div>
        <div class="stat-label">Total Spent</div>
        <div class="stat-trend trend-up" id="spentTrend">+12% vs last month</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="thisMonth">$0</div>
        <div class="stat-label">This Month</div>
        <div class="stat-trend" id="monthTrend">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="thisWeek">$0</div>
        <div class="stat-label">This Week</div>
        <div class="stat-trend" id="weekTrend">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avgPurchase">$0</div>
        <div class="stat-label">Avg Purchase</div>
        <div class="stat-trend" id="avgTrend">‚Äî</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <a href="addReceipt.html" class="btn btn-primary">üìù Add Receipt</a>
      <a href="food.html" class="btn btn-primary">üçé Food Tracking</a>
      <a href="search.html" class="btn btn-secondary">üîç Price Lookup</a>
      <a href="budget.html" class="btn btn-secondary">üí∞ Budgets</a>
    </div>

    <!-- Main Content Grid -->
    <div class="grid-2col">
      <!-- Spending by Category -->
      <div class="card">
        <h3>üìä Spending by Category</h3>

        <!-- Selection text above donut (no slice labels) -->
        <div class="donut-selection" id="donutSelection">
          <span class="sub">Tap a slice to highlight</span>
        </div>

        <div class="chart-container" id="categoryChartContainer">
          <canvas id="categoryChart"></canvas>
          <div class="chart-hint">Tap a slice to ‚Äúpop‚Äù it. Tap center/outside to reset.</div>
        </div>

        <div class="category-list" id="categoryList">
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <p>No receipts yet. Add your first receipt to see spending breakdown!</p>
          </div>
        </div>
      </div>

      <!-- Budget Tracker -->
      <div class="card">
        <h3>üí∞ Budget Status</h3>
        <div id="budgetList">
          <div class="empty-state">
            <div class="empty-icon">üéØ</div>
            <p>Set up budgets to track your spending goals</p>
            <a href="budget.html" class="btn btn-primary" style="margin-top: 12px;">Set Budgets</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Purchases -->
    <div class="card">
      <h3>üõí Recent Purchases</h3>
      <div class="recent-list" id="recentList">
        <div class="empty-state">
          <div class="empty-icon">üßæ</div>
          <p>No purchases yet. Add receipts to track your spending!</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // LocalStorage Keys
    const STORAGE_KEYS = {
      RECEIPTS: 'finances:receipts',
      ITEMS: 'finances:items',
      BUDGETS: 'finances:budgets',
      CATEGORIES: 'finances:categories',
      FILTERS: 'finances:categoryFilters'
    };

    // Major Expense Categories
    const MAJOR_CATEGORIES = [
      { name: 'Groceries', icon: 'üõí', color: '#4CAF50' },
      { name: 'Restaurants', icon: 'üçΩÔ∏è', color: '#FF9800' },
      { name: 'Medical', icon: 'üíä', color: '#EF4444' },
      { name: 'Home', icon: 'üè†', color: '#3B82F6' },
      { name: 'Rental Property', icon: 'üèòÔ∏è', color: '#8B5CF6' },
      { name: 'Transportation', icon: 'üöó', color: '#10B981' },
      { name: 'Utilities', icon: 'üí°', color: '#F59E0B' },
      { name: 'Other', icon: 'üì¶', color: '#6B7280' }
    ];

    // Donut colors (rotates if more categories than colors)
    const DONUT_COLORS = [
      '#4CAF50', '#2dd4bf', '#f59e0b', '#ef4444',
      '#8b5cf6', '#3b82f6', '#ec4899', '#14b8a6',
      '#a3e635', '#fb7185', '#f97316', '#60a5fa'
    ];

    // Donut state (in-page only)
    let lastCategoryOrder = [];  // [{name, total, count, color}]
    let lastDonutTotal = 0;
    let selectedSliceIndex = -1;

    // Get Active Filters from Storage
    function getActiveFilters() {
      try {
        const filters = localStorage.getItem(STORAGE_KEYS.FILTERS);
        if (filters) return JSON.parse(filters);
      } catch (e) {
        console.error('Error loading filters:', e);
      }
      const defaultFilters = {};
      MAJOR_CATEGORIES.forEach(cat => defaultFilters[cat.name] = true);
      return defaultFilters;
    }

    function saveActiveFilters(filters) {
      localStorage.setItem(STORAGE_KEYS.FILTERS, JSON.stringify(filters));
    }

    function initializeCategoryFilters() {
      const filters = getActiveFilters();
      const container = document.getElementById('categoryFilters');
      container.innerHTML = '';

      MAJOR_CATEGORIES.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (filters[cat.name] ? ' active' : '');
        btn.dataset.category = cat.name;
        btn.innerHTML = `<span>${cat.icon}</span><span>${cat.name}</span>`;
        
        btn.addEventListener('click', () => {
          filters[cat.name] = !filters[cat.name];
          btn.classList.toggle('active');
          saveActiveFilters(filters);
          loadDashboard();
        });
        
        container.appendChild(btn);
      });
    }

    function toggleAllFilters() {
      const filters = getActiveFilters();
      const allActive = Object.values(filters).every(v => v);
      MAJOR_CATEGORIES.forEach(cat => filters[cat.name] = !allActive);
      saveActiveFilters(filters);
      initializeCategoryFilters();
      loadDashboard();
    }

    function filterReceiptsByCategory(receipts) {
      const activeFilters = getActiveFilters();
      return receipts.map(receipt => {
        const filteredItems = receipt.items.filter(item => {
          const category = item.category || 'Other';
          return activeFilters[category] !== false;
        });
        return {
          ...receipt,
          items: filteredItems,
          total: filteredItems.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0)
        };
      }).filter(receipt => receipt.items.length > 0);
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeCategoryFilters();
      loadDashboard();
      setupSearch();
      setupDonutInteractions();
    });

    function loadDashboard() {
      const receipts = getReceipts();
      if (receipts.length === 0) { showEmptyState(); return; }

      const filteredReceipts = filterReceiptsByCategory(receipts);
      updateStats(filteredReceipts);
      renderCategoryBreakdown(filteredReceipts);
      renderBudgets(filteredReceipts);
      renderRecentPurchases(filteredReceipts);
    }

    function getReceipts() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.RECEIPTS) || '[]'); }
      catch (e) { console.error('Error loading receipts:', e); return []; }
    }

    function updateStats(receipts) {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();
      const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

      let totalSpent = 0, monthSpent = 0, weekSpent = 0;

      receipts.forEach(receipt => {
        const date = new Date(receipt.date);
        const amount = parseFloat(receipt.total) || 0;
        totalSpent += amount;
        if (date.getMonth() === thisMonth && date.getFullYear() === thisYear) monthSpent += amount;
        if (date >= weekAgo) weekSpent += amount;
      });

      const avgPurchase = receipts.length > 0 ? totalSpent / receipts.length : 0;

      document.getElementById('totalSpent').textContent = '$' + totalSpent.toFixed(2);
      document.getElementById('thisMonth').textContent = '$' + monthSpent.toFixed(2);
      document.getElementById('thisWeek').textContent = '$' + weekSpent.toFixed(2);
      document.getElementById('avgPurchase').textContent = '$' + avgPurchase.toFixed(2);
    }

    function renderCategoryBreakdown(receipts) {
      const categories = {};
      receipts.forEach(receipt => {
        receipt.items.forEach(item => {
          const category = item.category || 'Other';
          const price = parseFloat(item.price) || 0;
          if (!categories[category]) categories[category] = { total: 0, count: 0 };
          categories[category].total += price;
          categories[category].count++;
        });
      });

      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '';

      const categoryIcons = {
        'Food': 'üçé',
        'Produce': 'ü•¨',
        'Dairy': 'ü•õ',
        'Meat': 'ü•©',
        'Meat/Fish': 'ü•©',
        'Snacks': 'üç™',
        'Drinks': 'ü•§',
        'Household': 'üßπ',
        'Kids': 'üë∂',
        'Health': 'üíä',
        'Cafe': '‚òï',
        'Other': 'üì¶'
      };

      // Stable order for color mapping: sort by spend desc
      const ordered = Object.entries(categories)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([name, data], idx) => ({
          name,
          total: data.total,
          count: data.count,
          color: DONUT_COLORS[idx % DONUT_COLORS.length]
        }));

      lastCategoryOrder = ordered;
      lastDonutTotal = ordered.reduce((s, c) => s + c.total, 0);

      // If selection is now out of range (category count changed), clear it
      if (selectedSliceIndex >= lastCategoryOrder.length) selectedSliceIndex = -1;

      ordered.forEach((cat) => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.onclick = () => filterByCategory(cat.name);
        
        item.innerHTML = `
          <div class="category-info">
            <span class="color-swatch" style="background:${cat.color}"></span>
            <span class="category-icon">${categoryIcons[cat.name] || 'üì¶'}</span>
            <div>
              <div class="category-name">${cat.name}</div>
              <div class="category-count">${cat.count} items</div>
            </div>
          </div>
          <div class="category-amount">$${cat.total.toFixed(2)}</div>
        `;
        categoryList.appendChild(item);
      });

      updateDonutSelectionLabel();
      drawDonutChartSmall();
    }

    function drawDonutChartSmall() {
      const canvas = document.getElementById('categoryChart');
      const ctx = canvas.getContext('2d');

      const size = Math.min(canvas.parentElement.clientWidth, 300);
      canvas.width = size;
      canvas.height = size;

      drawDonut(ctx, size, size, {
        selectedIndex: selectedSliceIndex
      });
    }

    function drawDonut(ctx, width, height, opts) {
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) * 0.36;
      const innerRadius = radius * 0.62;

      ctx.clearRect(0, 0, width, height);

      const total = lastDonutTotal;
      if (!total || total <= 0 || lastCategoryOrder.length === 0) return;

      let currentAngle = -Math.PI / 2;

      // Draw slices (NO labels on slices)
      lastCategoryOrder.forEach((cat, i) => {
        const sliceAngle = (cat.total / total) * 2 * Math.PI;
        const isSelected = (opts.selectedIndex === i);
        const hasSelection = (opts.selectedIndex !== -1);

        const outerR = isSelected ? radius * 1.08 : radius;

        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();

        // Dim non-selected slices when selection exists
        ctx.save();
        if (hasSelection && !isSelected) ctx.globalAlpha = 0.28;
        ctx.fillStyle = cat.color;
        ctx.fill();
        ctx.restore();

        // subtle separator
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.stroke();

        currentAngle += sliceAngle;
      });

      // Center total
      ctx.fillStyle = '#e8eef6';
      ctx.font = '800 26px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('$' + total.toFixed(0), centerX, centerY);

      ctx.font = '12px system-ui';
      ctx.fillStyle = '#9fb0c7';
      ctx.fillText('Total', centerX, centerY + 22);
    }

    function updateDonutSelectionLabel() {
      const el = document.getElementById('donutSelection');
      if (!el) return;

      if (selectedSliceIndex === -1 || !lastCategoryOrder[selectedSliceIndex]) {
        el.innerHTML = `<span class="sub">Tap a slice to highlight</span>`;
        return;
      }

      const cat = lastCategoryOrder[selectedSliceIndex];
      el.innerHTML = `
        ${cat.name} ‚Ä¢ $${cat.total.toFixed(2)}
        <span class="sub">Tap center/outside to reset</span>
      `;
    }

    function setupDonutInteractions() {
      const canvas = document.getElementById('categoryChart');
      if (!canvas) return;

      // Keep canvas crisp on resize
      window.addEventListener('resize', () => {
        drawDonutChartSmall();
      });

      canvas.addEventListener('click', (e) => {
        if (!lastDonutTotal || lastCategoryOrder.length === 0) return;

        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);

        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        const dx = x - cx;
        const dy = y - cy;
        const dist = Math.sqrt(dx*dx + dy*dy);

        const radius = Math.min(canvas.width, canvas.height) * 0.36;
        const innerRadius = radius * 0.62;

        // If tap in hole or outside ring, clear
        if (dist < innerRadius || dist > radius * 1.12) {
          if (selectedSliceIndex !== -1) {
            selectedSliceIndex = -1;
            updateDonutSelectionLabel();
            drawDonutChartSmall();
          }
          return;
        }

        // Convert point to angle and map to slice
        let angle = Math.atan2(dy, dx); // -PI..PI
        if (angle < -Math.PI/2) angle += 2*Math.PI;
        const normalized = angle + Math.PI/2; // align to start at top

        let acc = 0;
        let found = -1;

        for (let i = 0; i < lastCategoryOrder.length; i++) {
          const slice = (lastCategoryOrder[i].total / lastDonutTotal) * 2*Math.PI;
          if (normalized >= acc && normalized < acc + slice) { found = i; break; }
          acc += slice;
        }

        if (found === -1) return;

        // Toggle selection
        selectedSliceIndex = (selectedSliceIndex === found) ? -1 : found;
        updateDonutSelectionLabel();
        drawDonutChartSmall();
      }, { passive: true });
    }

    // Render Budgets
    function renderBudgets(receipts) {
      const budgets = getBudgets();
      const budgetList = document.getElementById('budgetList');
      if (budgets.length === 0) return;

      budgetList.innerHTML = '';

      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      const spending = {};
      receipts.forEach(receipt => {
        const date = new Date(receipt.date);
        if (date.getMonth() === thisMonth && date.getFullYear() === thisYear) {
          receipt.items.forEach(item => {
            const category = item.category || 'Other';
            spending[category] = (spending[category] || 0) + (parseFloat(item.price) || 0);
          });
        }
      });

      budgets.forEach(budget => {
       a
        const spent = spending[budget.category] || 0;
        const percent = (spent / budget.amount) * 100;
        const isOver = spent > budget.amount;

        const item = document.createElement('div');
        item.className = 'budget-item';
        item.innerHTML = `
          <div class="budget-header">
            <span class="budget-name">${budget.category}</span>
            <span class="budget-amounts">$${spent.toFixed(2)} / $${budget.amount.toFixed(2)}</span>
          </div>
          <div class="budget-bar">
            <div class="budget-progress ${isOver ? 'over-budget' : ''}" style="width: ${Math.min(percent, 100)}%"></div>
          </div>
        `;
        budgetList.appendChild(item);
      });
    }

    function getBudgets() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.BUDGETS) || '[]'); }
      catch (e) { return []; }
    }

    // Render Recent Purchases
    function renderRecentPurchases(receipts) {
      const recentList = document.getElementById('recentList');
      recentList.innerHTML = '';

      const sorted = receipts
        .slice()
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);

      sorted.forEach(receipt => {
        const item = document.createElement('div');
        item.className = 'recent-item';
        item.onclick = () => viewReceipt(receipt.id);

        const date = new Date(receipt.date);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        item.innerHTML = `
          <div>
            <div class="recent-store">${receipt.store || 'Store'}</div>
            <div class="recent-date">${dateStr} ‚Ä¢ ${receipt.items.length} items</div>
          </div>
          <div class="recent-amount">$${parseFloat(receipt.total || 0).toFixed(2)}</div>
        `;
        recentList.appendChild(item);
      });
    }

    // Setup Search
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');

      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query.length > 2) performSearch(query);
      });

      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const query = e.target.value;
          location.href = `search.html?q=${encodeURIComponent(query)}`;
        }
      });
    }

    function performSearch(query) {
      if (query.length > 0) location.href = `search.html?q=${encodeURIComponent(query)}`;
    }

    function viewReceipt(id) {
      location.href = `receipts.html?id=${id}`;
    }

    function filterByCategory(category) {
      location.href = `receipts.html?category=${encodeURIComponent(category)}`;
    }

    function showEmptyState() {
      // Empty states are already in HTML
    }
  </script>
</body>
</html>
