<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Power Up! — Summary</title>
<style>
  :root{
    --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7; --accent:#4CAF50; --accent-2:#2dd4bf;
    --ring:#2a3543; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
    --cal-gap:4px; --cal-radius:10px; --cal-font:.9rem; --cal-count:.8rem;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#0a0e13 0%, #0d131a 100%); color:var(--ink);
    display:flex; flex-direction:column;
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:.6rem .9rem; border-bottom:1px solid var(--ring); background:#0e141b;
  }
  header h1{margin:0; font-size:1.05rem; letter-spacing:.2px}
  header .home{all:unset; cursor:pointer; padding:.35rem .6rem; border-radius:.6rem; border:1px solid var(--ring)}
  header .home:focus-visible{outline:2px solid var(--accent-2)}

  .wrap{width:min(1100px, 100%); margin-inline:auto; padding:10px 12px 18px; flex:1; display:flex; flex-direction:column; gap:10px}

  .grid{display:grid; gap:10px; grid-template-columns: repeat(12, 1fr)}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:14px;
    padding:12px; box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:.1rem 0 .45rem; font-size:.95rem; color:var(--muted); font-weight:600}

  /* top cards */
  #weightCard{grid-column: span 4}
  #lastWorkoutCard{grid-column: span 8; display:grid; grid-template-columns: 1.15fr 1fr; gap:12px}
  .val{display:flex; align-items:baseline; gap:8px; font-size:1.9rem; font-weight:700}
  .trend{font-size:.9rem; color:var(--muted)}
  .spark{width:100%; height:60px; display:block}
  .meta{display:flex; gap:10px; flex-wrap:wrap}
  .badge{background:#0f1720; border:1px solid var(--ring); color:var(--muted); padding:.3rem .55rem; border-radius:999px; font-size:.82rem}
  .ex-list{display:grid; gap:6px}
  .ex{display:flex; justify-content:space-between; background:#0f141b; border:1px dashed #213043; border-radius:10px; padding:6px 8px; font-size:.95rem}
  .ex b{font-weight:700}
  .cta-row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .cta{
    all:unset; cursor:pointer; background:linear-gradient(90deg, var(--accent), #22c55e);
    color:#04130a; padding:.65rem .9rem; border-radius:10px; font-weight:700; box-shadow:0 6px 20px rgba(34,197,94,.25)
  }
  .cta:active{transform:translateY(1px)}
  .ghost{all:unset; cursor:pointer; color:var(--muted); padding:.5rem .7rem; border-radius:9px; border:1px solid var(--ring)}

  /* calendar (compact + half width on desktop) */
  .calendar{grid-column: span 6}
  .calendar h3{margin:0; font-size:1rem; color:var(--muted)}
  .legend{display:flex; gap:10px; color:var(--muted); font-size:.85rem}
  .legend .swatch{width:10px; height:10px; border-radius:4px; display:inline-block; border:1px solid #233446}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:var(--cal-gap); margin-top:6px}
  .dow{font-size:.78rem; color:var(--muted); text-align:center; padding:3px 0}
  .day{
    aspect-ratio:1/1; border:1px solid var(--ring); border-radius:var(--cal-radius);
    position:relative; background:#0f141b;
  }
  .day.muted{opacity:.45}
  .day.partial{ background:#1a1e10 }
  .day.done{ background:#0e1a12 }
  .day.today{outline:2px solid var(--accent-2)}
  .num{
    position:absolute; top:6px; left:7px; font-size:var(--cal-font); line-height:1; color:var(--ink);
  }
  .count{
    position:absolute; bottom:6px; right:7px; font-size:var(--cal-count); color:var(--muted);
  }

  /* responsive (fit on one mobile screen) */
  @media (max-width: 980px){
    #weightCard{grid-column:span 12}
    #lastWorkoutCard{grid-column:span 12}
    .calendar{grid-column:span 12}
    #lastWorkoutCard{grid-template-columns:1fr}
  }
  @media (max-width: 480px){
    .wrap{gap:8px; padding:8px 8px 12px}
    .card{padding:10px; border-radius:12px}
    .val{font-size:1.6rem}
    .spark{height:52px}
    .badge{font-size:.78rem; padding:.25rem .5rem}
    .ex{padding:6px 7px; font-size:.92rem}
    .legend{font-size:.8rem}
    .calendar .card{padding:8px}
    .day{border-radius:8px}
    :root{ --cal-font:.85rem; --cal-count:.7rem }
  }
</style>
</head>
<body>
  <header>
    <button class="home" onclick="location.href='../main.html'">⟵ Home</button>
    <h1>Power Up! — Summary</h1>
    <div style="width:60px"></div>
  </header>

  <div class="wrap">
    <section class="grid">
      <article class="card" id="weightCard">
        <h3>Latest Weight</h3>
        <div class="val"><span id="latestWeight">—</span><span class="trend" id="weightTrend"></span></div>
        <canvas class="spark" id="weightSpark"></canvas>
      </article>

      <article class="card" id="lastWorkoutCard">
        <div>
          <h3 id="workoutPanelTitle">Previous Workout</h3>
          <div class="meta">
            <span class="badge" id="lastDate">—</span>
            <span class="badge">Total Volume: <b id="lastVolume">—</b></span>
            <span class="badge">Exercises: <b id="lastMoves">—</b></span>
            <span class="badge">Sets: <b id="lastSets">—</b></span>
            <span class="badge" id="setsLeftBadge" style="display:none;">Sets Left: <b id="setsLeft">—</b></span>
          </div>
          <div class="ex-list" id="exList"></div>
        </div>
        <div class="cta-row">
          <button class="cta" id="startToday">Start Today’s Workout</button>
          <button class="ghost" id="viewAll">View All Workouts</button>
          <button class="ghost" id="logWeight">Log Weight</button>
        </div>
      </article>

      <!-- Calendar -->
      <section class="card calendar" id="calendar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
          <h3 id="calTitle">—</h3>
          <div class="legend">
            <span><i class="swatch" style="background:#0f141b"></i> None</span>
            <span><i class="swatch" style="background:#1a1e10"></i> Light</span>
            <span><i class="swatch" style="background:#0e1a12"></i> Completed</span>
          </div>
        </div>
        <div class="cal-grid" id="calDOW"></div>
        <div class="cal-grid" id="calGrid"></div>
      </section>
    </section>
  </div>

<script>
/* ========= Load data =========
 * Reads your saved days from localStorage (keys powerUp:YYYY-MM-DD, written by workout.html)
 * Converts them to the format this page uses.
 */
const today = new Date();
const todayISO = today.toISOString().slice(0,10);
const fmt = (d)=>new Date(d+'T00:00:00');

function readLocalDays(){
  const out = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!/^powerUp:\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    try{
      const day = JSON.parse(localStorage.getItem(k));
      if(!day?.date) continue;
      // Convert to this page's "workout" shape
      const converted = {
        date: day.date,
        bodyWeight: day.bodyWeight ?? undefined,
        exercises: (day.exercises||[]).map(ex=>({
          name: ex.name || ex.exercise || 'Exercise',
          sets: (ex.sets||[]).map(s=>({
            reps: Number(s.reps)||0,
            weight: Number(s.weight)||0,
            completed: !!s.done
          }))
        }))
      };
      out.push(converted);
    }catch(e){}
  }
  return out.sort((a,b)=> fmt(a.date)-fmt(b.date));
}

/* Fallback demo data if local is empty (kept tiny) */
const demoWorkouts = [
  { date:'2025-08-12', bodyWeight:184.2, exercises:[
    {name:'OHP', sets:[{reps:6,weight:95,completed:true},{reps:6,weight:95,completed:true},{reps:5,weight:100,completed:true}]},
  ]},
];

/* Merge: prefer local; else demo */
const workouts = (readLocalDays().length ? readLocalDays() : demoWorkouts);

const byDateAsc = (a,b)=> fmt(a.date) - fmt(b.date);
const shortDate = (d)=> new Date(d).toLocaleDateString(undefined, {month:'short', day:'numeric', weekday:'short'});
const totalVolume = (wo)=> wo.exercises.reduce((sum, ex)=> sum + ex.sets.reduce((s, st)=> s + (st.weight||0)*(st.reps||0), 0), 0);
const totalSets = (wo)=> wo.exercises.reduce((s,ex)=> s + ex.sets.length, 0);
const completedSets = (wo)=> wo.exercises.reduce((s,ex)=> s + ex.sets.filter(st=>st.completed).length, 0);

/* Sparkline */
function drawSpark(id, points){
  const c = document.getElementById(id);
  const w = c.clientWidth, h=c.clientHeight;
  c.width = Math.max(260,w); c.height = Math.max(52,h);
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(!points || points.length<2) return;

  const xs = points.map(p=>p.x.getTime());
  const ys = points.map(p=>p.y);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const pad = 8;
  const xScale = (t)=> pad + ((t-minX)/(maxX-minX||1))*(c.width-2*pad);
  const yScale = (v)=> c.height - pad - ((v-minY)/(maxY-minY||1))*(c.height-2*pad);

  ctx.strokeStyle = '#233446'; ctx.lineWidth=1; ctx.setLineDash([2,3]);
  ctx.beginPath(); ctx.moveTo(pad, yScale(minY)); ctx.lineTo(c.width-pad, yScale(minY)); ctx.stroke();
  ctx.setLineDash([]);

  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-2') || '#2dd4bf';
  ctx.lineWidth = 2; ctx.beginPath();
  points.forEach((p,i)=>{ const x=xScale(p.x.getTime()), y=yScale(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();

  const lp = points[points.length-1]; const lx=xScale(lp.x.getTime()), ly=yScale(lp.y);
  ctx.fillStyle = '#e8eef6'; ctx.beginPath(); ctx.arc(lx,ly,3,0,Math.PI*2); ctx.fill();
}

/* Weight card: use any bodyWeight fields we find */
function renderWeight(){
  const sorted = [...workouts].sort(byDateAsc);
  const lastWeights = sorted
    .filter(w=>typeof w.bodyWeight==='number' && !isNaN(w.bodyWeight))
    .map(w=>({x:fmt(w.date), y:w.bodyWeight}));

  if(lastWeights.length===0){
    document.getElementById('latestWeight').textContent = '—';
    document.getElementById('weightTrend').textContent = '';
    return;
  }

  const latest = lastWeights.at(-1)?.y;
  const prev   = lastWeights.at(-2)?.y;
  document.getElementById('latestWeight').textContent = `${latest.toFixed(1)} lb`;
  const tEl = document.getElementById('weightTrend');
  const trend = (latest && prev) ? (latest - prev) : 0;
  if(trend){
    tEl.textContent = `${trend>0?'+':''}${trend.toFixed(1)} vs last`;
    tEl.style.color = trend<0 ? 'var(--good)' : 'var(--bad)';
  } else tEl.textContent = '';
  drawSpark('weightSpark', lastWeights);
}

/* Today/Previous workout panel — now sourced from localStorage */
function renderWorkoutPanel(){
  const list = [...workouts].sort(byDateAsc);
  const todayW = list.find(w=>w.date===todayISO);
  const inProgress = isTodayInProgress(todayW);
  const startBtn = document.getElementById('startToday');
  startBtn.textContent = inProgress ? 'Continue Workout' : 'Start Today’s Workout';

  // If there is a workout saved for today, always show it.
  const hasToday = !!todayW;
  const target = hasToday ? todayW : (list.filter(w=>w.exercises?.length).slice(0,-1).at(-1) || list.at(-1));
  const title = document.getElementById('workoutPanelTitle');
  title.textContent = hasToday ? 'Today’s Workout' : 'Previous Workout';

  document.getElementById('lastDate').textContent = shortDate(target.date);
  document.getElementById('lastVolume').textContent = totalVolume(target).toLocaleString()+' lb';
  document.getElementById('lastMoves').textContent = target.exercises.length;
  document.getElementById('lastSets').textContent = totalSets(target);

  const setsLeftWrap = document.getElementById('setsLeftBadge');
  if(hasToday){
    const left = totalSets(target) - completedSets(target);
    setsLeftWrap.style.display = 'inline-flex';
    document.getElementById('setsLeft').textContent = left;
  } else setsLeftWrap.style.display = 'none';

  const exList = document.getElementById('exList');
  exList.innerHTML = '';
  target.exercises.forEach(ex=>{
    const setsTxt = ex.sets.map(s=>`${s.completed?'✔':'○'} ${s.reps}×${s.weight||0}`).join(', ');
    const row = document.createElement('div');
    row.className='ex';
    row.innerHTML = `<b>${ex.name}</b><span>${setsTxt}</span>`;
    exList.appendChild(row);
  });
}

/* Calendar (numbers aligned) */
function renderCalendar(){
  const calTitle = document.getElementById('calTitle');
  const calGrid  = document.getElementById('calGrid');
  const calDOW   = document.getElementById('calDOW');
  calDOW.innerHTML = '';
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
    const e = document.createElement('div');
    e.className='dow'; e.textContent = d; calDOW.appendChild(e);
  });

  const year = today.getFullYear();
  const month = today.getMonth();
  const monthStart = new Date(year, month, 1);
  const monthEnd   = new Date(year, month+1, 0);
  calTitle.textContent = monthStart.toLocaleDateString(undefined, {month:'long', year:'numeric'});

  // volumes by day from workouts (incl. localStorage)
  const byDay = new Map();
  workouts.forEach(w=>{
    const d = fmt(w.date);
    if(d.getFullYear()===year && d.getMonth()===month){
      const k = d.getDate();
      byDay.set(k, (byDay.get(k)||0) + totalVolume(w));
    }
  });

  calGrid.innerHTML = '';
  const leadingBlanks = monthStart.getDay();
  for(let i=0;i<leadingBlanks;i++){
    const empty = document.createElement('div');
    empty.className='day muted'; calGrid.appendChild(empty);
  }
  for(let day=1; day<=monthEnd.getDate(); day++){
    const cell = document.createElement('div');
    const vol = byDay.get(day)||0;
    let state = '';
    if(vol>0) state = vol>5000 ? 'done' : 'partial';
    if(day===today.getDate() && month===today.getMonth() && year===today.getFullYear()) state += ' today';
    cell.className = `day ${state}`.trim();

    const num = document.createElement('div'); num.className='num'; num.textContent = day;
    cell.appendChild(num);
    if(vol){
      const ct  = document.createElement('div'); ct.className='count'; ct.textContent = Math.round(vol)+' lb';
      cell.appendChild(ct);
    }
    calGrid.appendChild(cell);
  }
}

/* In-progress detection */
function isTodayInProgress(todayW){
  if(!todayW){
    return localStorage.getItem('workoutInProgress') === todayISO;
  }
  const hasSets = totalSets(todayW) > 0;
  const allDone = completedSets(todayW) === totalSets(todayW);
  return hasSets && !allDone;
}

/* Buttons */
document.getElementById('startToday').addEventListener('click', ()=>{
  localStorage.setItem('workoutInProgress', todayISO);
  window.location.href = 'workout.html?start=today';
});
document.getElementById('viewAll').addEventListener('click', ()=>{
  window.location.href = 'workouts.html';
});
document.getElementById('logWeight').addEventListener('click', ()=>{
  const w = prompt('Enter today’s weight (lb):');
  if(!w) return;
  // persist weight onto today's saved object if present, else create a minimal one
  const k = `powerUp:${todayISO}`;
  const existing = localStorage.getItem(k);
  if(existing){
    const d = JSON.parse(existing); d.bodyWeight = parseFloat(w); localStorage.setItem(k, JSON.stringify(d));
  }else{
    localStorage.setItem(k, JSON.stringify({date: todayISO, bodyWeight:parseFloat(w), exercises:[]}));
  }
  // refresh from local storage
  location.reload();
});

/* Init */
function renderAll(){
  renderWeight();
  renderWorkoutPanel();
  renderCalendar();
}
renderAll();
window.addEventListener('resize', ()=>drawSpark('weightSpark',
  [...workouts].filter(w=>typeof w.bodyWeight==='number').sort(byDateAsc).map(w=>({x:fmt(w.date),y:w.bodyWeight}))
));
</script>
</body>
</html>
