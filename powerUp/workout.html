<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Power Up! ‚Äî Today</title>
<style>
  :root{
    --bg:#080c11; --panel:#0d131a; --ink:#e8eef6; --muted:#9fb0c7; --ring:#1c2a37;
    --accent:#4CAF50; --danger:#ef4444; --warn:#f59e0b;
    --finished-bg:#0f1f15; --finished-ring:#1f4030;
    --orange:#ff9500; --orange-bg:#2a1f0a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    background:linear-gradient(180deg,#070b10 0%, #0a1016 100%); color:var(--ink);
    display:flex; flex-direction:column;
  }

  header{background:#0b1118; border-bottom:1px solid var(--ring); color:var(--ink); padding:10px}
  .bar{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .home{all:unset; cursor:pointer; border:1px solid var(--ring); padding:.35rem .6rem; border-radius:.6rem}
  h1{margin:0; font-size:1rem}
  .date-nav{display:flex; align-items:center; gap:10px}
  .date-nav button{all:unset; cursor:pointer; padding:.3rem .5rem; border:1px solid var(--ring); border-radius:.5rem}
  .date-str{min-width:9.5ch; text-align:center}

  .wrap{width:min(900px,100%); margin-inline:auto; padding:10px; display:flex; flex-direction:column; gap:10px; flex:1}

  .card{background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:12px; box-shadow:0 8px 30px rgba(0,0,0,.25)}
  #powerCard .top{display:flex; align-items:baseline; gap:10px}
  #powerVal{font-size:1.9rem; font-weight:800}
  #powerTrend{font-size:.9rem; color:var(--muted)}
  .spark{width:100%; height:64px; display:block; margin-top:6px}
  .glow-warn{box-shadow:0 0 0 1px rgba(245,158,11,.3), 0 0 16px rgba(245,158,11,.25), inset 0 0 20px rgba(245,158,11,.08)}
  .glow-hot{box-shadow:0 0 0 1px rgba(239,68,68,.35), 0 0 24px rgba(239,68,68,.35), inset 0 0 24px rgba(239,68,68,.12)}

  .totals{position:sticky; top:0; z-index:20; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background:rgba(13,19,26,.9); backdrop-filter:saturate(1.1) blur(3px); border:1px solid var(--ring); border-radius:12px; padding:10px; font-size:.95rem}
  .totals.hidden{display:none}
  .chip{background:#0b1118; border:1px solid var(--ring); padding:.35rem .6rem; border-radius:999px; color:var(--muted)}
  .chip b{color:var(--ink)}
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .btn{all:unset; cursor:pointer; padding:.7rem 1rem; border-radius:12px; font-weight:700; background:linear-gradient(90deg,#4CAF50,#22c55e); color:#04130a; box-shadow:0 6px 20px rgba(34,197,94,.25)}
  .btn-ghost{all:unset; cursor:pointer; padding:.6rem .9rem; border:1px solid var(--ring); border-radius:10px; color:var(--muted)}
  .btn-danger{all:unset; cursor:pointer; padding:.45rem .6rem; border:1px solid #3a2227; border-radius:8px; color:#fecaca; background:#2a0f12}
  .btn-small{padding:.35rem .55rem; font-size:.85rem}
  .btn-today{all:unset; cursor:pointer; padding:.6rem .9rem; border:1px solid #d97706; border-radius:10px; color:#fbbf24; background:linear-gradient(90deg,#f59e0b,#d97706); font-weight:700}

  .group{background:#0b1118; border:1px solid var(--ring); border-radius:14px; padding:10px; margin-top:6px}
  .group h3{margin:.1rem 0 .4rem; font-size:1rem; color:var(--muted)}
  .ex{border:1px dashed var(--ring); border-radius:12px; padding:10px; margin:8px 0; display:grid; gap:8px}
  .ex.finished{background:var(--finished-bg); border-color:var(--finished-ring)}
  .ex-header{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
  .ex-name{font-weight:700}
  .tag{font-size:.9rem; color:var(--muted)}
  .sets{display:grid; gap:6px}
  .ex-actions-bottom{display:flex; gap:8px; margin-top:4px; justify-content:space-between; align-items:center}

  .set-row{display:grid; grid-template-columns: auto auto auto 1fr auto; gap:8px; align-items:center}
  .weight-input-group{display:flex; align-items:center; gap:4px}
  .num-input{width:6ch; max-width:6ch; padding:.55rem .55rem; border:1px solid #15212c; border-radius:8px; background:#091017; color:var(--ink); font-variant-numeric:tabular-nums}
  .num-input:focus{outline:2px solid #213240}
  .lbs-label{font-size:.85rem; color:var(--muted); white-space:nowrap}
  .flags{display:flex; align-items:center; gap:12px; color:var(--muted); font-size:.9rem}
  .tools{display:flex; gap:6px}
  .finished-display{color:var(--muted); font-size:.9rem; text-align:right}

  .spacer{height:70px}

  /* Popups */
  .popup{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; padding:10px; z-index:100}
  .sheet{width:min(650px, 96%); max-height:85vh; overflow:auto; background:#0b1118; border:1px solid var(--ring); border-radius:14px; padding:12px}
  .x{all:unset; cursor:pointer; float:right; border:1px solid var(--ring); padding:.25rem .5rem; border-radius:8px; color:#9fb0c7}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:8px}
  .opt{border:1px solid var(--ring); padding:10px; border-radius:10px; cursor:pointer; background:#0e151e; position:relative}
  .opt:hover{outline:1px solid #2b3a4a}
  .opt.used{background:var(--orange-bg); border-color:var(--orange); color:var(--orange)}

  /* Exercise popup header with back button */
  .ex-popup-header{display:flex; align-items:center; gap:10px; margin:6px 0 10px}
  .back-btn{all:unset; cursor:pointer; border:1px solid var(--ring); padding:.25rem .5rem; border-radius:8px; color:#9fb0c7}

  /* Create-new row in exercise popup */
  .create-row{display:flex; gap:8px; align-items:center; margin-bottom:8px}
  .create-input{flex:1; padding:.6rem .7rem; border:1px solid var(--ring); border-radius:10px; background:#0a1118; color:#e8eef6}
  .create-btn{all:unset; cursor:pointer; padding:.6rem .9rem; border-radius:10px; font-weight:700; background:linear-gradient(90deg,#4CAF50,#22c55e); color:#04130a; border:1px solid #295c38}
  
  /* Calendar */
  .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:4px}
  .cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin:4px 0; color:#9fb0c7; font-size:.85rem}
  .cal-cell{border:1px solid var(--ring); border-radius:8px; padding:8px; text-align:center; background:#0f141b}
  .cal-cell.workout{background:#0e1a12}
  .cal-nav{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px}
  .cal-nav button{all:unset; cursor:pointer; border:1px solid var(--ring); padding:.3rem .6rem; border-radius:8px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <button class="home" onclick="location.href='index.html'">‚üµ Home</button>
    <h1>Power Up! ‚Äî Today's Workout</h1>
    <div class="bar"><button class="home" id="openCalendar">üìÖ</button></div>
  </div>
  <div class="bar" style="margin-top:6px">
    <div class="date-nav">
      <button id="prevDay">‚Üê</button>
      <div class="date-str" id="dateStr">‚Äî</div>
      <button id="nextDay">‚Üí</button>
    </div>
    <div class="actions">
      <button class="btn" id="addExercise">Add Exercise</button>
      <button class="btn-ghost" id="saveBtn">Save</button>
      <button class="btn-today" id="todayBtn">Today</button>
      <button class="btn-ghost" id="clearBtn">Clear Day</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card" id="powerCard">
    <h3 style="margin:.1rem 0 .25rem; color:var(--muted)">Today's Volume</h3>
    <div class="top">
      <div id="powerVal">0 lb</div>
      <div id="powerTrend" class="muted">‚Äî</div>
    </div>
    <canvas id="powerSpark" class="spark"></canvas>
  </section>

  <section class="totals" id="totalsBar">
    <span class="chip">Sets: <b id="tSets">0</b></span>
    <span class="chip">Volume: <b id="tVol">0 lb</b></span>
    <span class="chip">Exercises: <b id="tEx">0</b></span>
    <span class="chip">Status: <b id="tStatus">Not started</b></span>
  </section>

  <div id="log"></div>
  <div class="spacer"></div>
</main>

<!-- Body Part sheet -->
<div class="popup" id="bpPopup">
  <div class="sheet">
    <button class="x" data-close="#bpPopup">‚úï</button>
    <h2 style="margin:6px 0 10px; font-size:1rem; color:#9fb0c7">Select Body Part</h2>
    <div class="grid" id="bpGrid"></div>
  </div>
</div>

<!-- Exercise sheet -->
<div class="popup" id="exPopup">
  <div class="sheet">
    <button class="x" data-close="#exPopup">‚úï</button>
    <div class="ex-popup-header">
      <button class="back-btn" id="backToBP">‚Üê Back</button>
      <h2 id="exTitle" style="margin:0; font-size:1rem; color:#9fb0c7; flex:1">Exercises</h2>
    </div>

    <!-- create-new row -->
    <div class="create-row">
      <input id="exCreateInput" class="create-input" placeholder="Create new exercise name‚Ä¶" />
      <button id="exCreateBtn" class="create-btn">Add</button>
    </div>

    <div class="grid" id="exGrid"></div>
  </div>
</div>

<!-- Calendar sheet -->
<div class="popup" id="calPopup">
  <div class="sheet">
    <button class="x" data-close="#calPopup">‚úï</button>
    <div class="cal-nav">
      <button id="calPrev">‚Üê</button>
      <div id="calMonth">‚Äî</div>
      <button id="calNext">‚Üí</button>
    </div>
    <div class="cal-head"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
    <div class="calendar" id="calGrid"></div>
  </div>
</div>

<script>
/* ---------- Catalog ---------- */
const exerciseOptions = {
  Chest: ['Bench Press','Incline Bench Press','Dumbbell Press','Dumbbell Flyes','Cable Fly','Chest Dips'],
  Back: ['Deadlift','Bent Over Row','Seated Cable Row','Lat Pulldown','One-arm DB Row','Chest-supported Row'],
  Biceps: ['Barbell Curl','DB Curl','Hammer Curl','Incline DB Curl','Cable Curl','Concentration Curl'],
  Triceps: ['Close-grip Bench','Skull Crushers','Cable Pushdown','Overhead Extension','Dips'],
  Shoulders: ['Overhead Press','Lateral Raise','Front Raise','Rear Delt Fly','Arnold Press','Upright Row','Shrug'],
  Legs: ['Back Squat','Front Squat','Leg Press','RDL','Lunge','Leg Extension','Ham Curl','Calf Raise'],
  Lats: ['Pull-up','Chin-up','Close Grip Pulldown','Pullover Machine'],
  Cardio: ['Running','Cycling','Rowing','Jump Rope','HIIT Circuit','Stair Climber']
};
const bodyParts = Object.keys(exerciseOptions);

/* ---- custom exercise persistence ---- */
const CUSTOM_KEY = 'powerUp:customExercises';
const getCustom = ()=> { try{ return JSON.parse(localStorage.getItem(CUSTOM_KEY)) || {}; }catch{ return {}; } };
const saveCustom = (obj)=> localStorage.setItem(CUSTOM_KEY, JSON.stringify(obj));

function addToCustomExercises(bodyPart, exerciseName) {
  // Add to localStorage custom exercises
  const custom = getCustom();
  custom[bodyPart] = custom[bodyPart] || [];
  if (!custom[bodyPart].includes(exerciseName)) {
    custom[bodyPart].push(exerciseName);
    saveCustom(custom);
  }
  
  // Also add to the main exerciseOptions object for this session
  if (!exerciseOptions[bodyPart].includes(exerciseName)) {
    exerciseOptions[bodyPart].push(exerciseName);
  }
}

function getAllExercises(bp){
  const base = exerciseOptions[bp] || [];
  const extras = getCustom()[bp] || [];
  return [...new Set([...base, ...extras])]; // dedupe
}

/* ---------- State & storage ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let current = new Date();
const keyFor = (d)=>`powerUp:${d.toISOString().slice(0,10)}`;

function blankDay(date){ return { date: date.toISOString().slice(0,10), exercises:[] }; }
function loadDay(date){ const raw = localStorage.getItem(keyFor(date)); return raw ? JSON.parse(raw) : blankDay(date); }
function saveDay(day){ localStorage.setItem(`powerUp:${day.date}`, JSON.stringify(day)); }

/* ---------- Maths ---------- */
function exStats(ex){
  const vol = ex.sets.reduce((s,a)=> s + (Number(a.weight)||0)*(Number(a.reps)||0), 0);
  const reps = ex.sets.reduce((s,a)=> s + (Number(a.reps)||0), 0);
  const avg = reps ? vol / reps : 0;
  return { vol, reps, avg };
}
function countedSets(ex){ return ex.finished ? ex.sets : ex.sets.filter(s=> !!s.done); }
function totalsFiltered(day){
  let sets=0, vol=0, exCount=day.exercises.length;
  day.exercises.forEach(ex=>{
    const cs = countedSets(ex);
    sets += cs.length;
    vol  += cs.reduce((s,a)=> s + (Number(a.weight)||0)*(Number(a.reps)||0), 0);
  });
  return {sets, vol, exCount};
}
function areAllSetsDone(day){
  const all = day.exercises.flatMap(ex=> ex.sets);
  return all.length>0 && all.every(s=> !!s.done);
}

/* ---------- Sparkline ---------- */
function drawSpark(el, points){
  const c = typeof el==='string' ? document.getElementById(el) : el;
  const w = c.clientWidth, h=c.clientHeight;
  c.width = Math.max(300,w); c.height = Math.max(56,h);
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  if(points.length<2) return;
  const xs = points.map((p,i)=>i);
  const ys = points.map(p=>p);
  const minX = 0, maxX = xs.length-1;
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const pad = 8;
  const xScale = (i)=> pad + ((i-minX)/(maxX-minX||1))*(c.width-2*pad);
  const yScale = (v)=> c.height - pad - ((v-minY)/(maxY-minY||1))*(c.height-2*pad);
  ctx.strokeStyle = '#233446'; ctx.lineWidth=1; ctx.setLineDash([2,3]);
  ctx.beginPath(); ctx.moveTo(pad, yScale(minY)); ctx.lineTo(c.width-pad, yScale(minY)); ctx.stroke();
  ctx.setLineDash([]);
  ctx.strokeStyle = '#2dd4bf'; ctx.lineWidth = 2; ctx.beginPath();
  points.forEach((v,i)=>{ const x=xScale(i), y=yScale(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  const lx=xScale(points.length-1), ly=yScale(points.at(-1));
  ctx.fillStyle = '#e8eef6'; ctx.beginPath(); ctx.arc(lx,ly,3,0,Math.PI*2); ctx.fill();
}

/* ---------- Rendering ---------- */
function render(){
  $('#dateStr').textContent = new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'numeric'}).format(current);
  const day = loadDay(current);
  renderPowerCard(day);

  const log = $('#log'); log.innerHTML = '';
  const groups = day.exercises.reduce((m,o)=>((m[o.bodyPart]??=[]).push(o),m),{});
  Object.entries(groups).forEach(([bp, list])=>{
    const g = document.createElement('div');
    g.className = 'group'; g.dataset.bodypart = bp;
    g.innerHTML = `<h3>${bp}</h3>`;
    list.forEach(ex=> g.appendChild(renderExercise(ex)));
    log.appendChild(g);
  });

  const {sets, vol, exCount} = totalsFiltered(day);
  $('#tSets').textContent = sets;
  $('#tVol').textContent = Math.round(vol) + ' lb';
  $('#tEx').textContent = exCount;
  $('#tStatus').textContent = (sets === 0) ? 'Not started' : (areAllSetsDone(day) ? 'Completed' : 'In progress');

  if ($('#calPopup').style.display === 'flex') buildCalendar(current);
}

function renderPowerCard(day){
  const { vol } = totalsFiltered(day);

  // compute yesterday's total
  const y = new Date(current);
  y.setDate(y.getDate() - 1);
  const prev = totalsFiltered(loadDay(y)).vol;

  $('#powerVal').textContent = Math.round(vol) + ' lb';
  const trend = vol - prev;
  $('#powerTrend').textContent = (prev > 0)
    ? `${trend >= 0 ? '+' : ''}${Math.round(trend)} vs. yesterday`
    : '‚Äî';

  const points = [];
  let run = 0;
  day.exercises.forEach(ex =>
    countedSets(ex).forEach(s => {
      run += (Number(s.weight) || 0) * (Number(s.reps) || 0);
      points.push(run);
    })
  );
  if (points.length < 2) points.push(Math.max(0, run));

  drawSpark('powerSpark', points);

  const card = document.getElementById('powerCard');
  card.classList.remove('glow-warn','glow-hot');
  if (vol > 1500) card.classList.add('glow-hot');
  else if (vol > 1000) card.classList.add('glow-warn');
}


function renderExercise(ex){
  const node = document.createElement('div');
  node.className = 'ex' + (ex.finished ? ' finished' : '');
  node.dataset.id = ex.id;
  const {vol, avg} = exStats(ex);
  node.innerHTML = `
    <div class="ex-header">
      <div>
        <div class="ex-name">${ex.name}</div>
        <div class="tag">${ex.sets.length} set(s) ‚Ä¢ ${Math.round(vol)} lb ‚Ä¢ avg ${Math.round(avg)} lb/rep</div>
      </div>
    </div>
    <div class="sets"></div>
    <div class="ex-actions-bottom">
      <div>
        <button class="btn-ghost btn-small" data-act="addSet" ${ex.finished ? 'style="display:none"' : ''}>+ Set</button>
        <button class="btn" style="padding:.6rem 1.2rem" data-act="toggleFinished">${ex.finished ? 'Finished ‚úì' : 'Finish'}</button>
      </div>
      <button class="btn-ghost btn-small" data-act="removeSet" ${ex.sets.length <= 1 || ex.finished ? 'style="display:none"' : ''}>- Set</button>
    </div>
  `;
  const setsWrap = node.querySelector('.sets');
  ex.sets.forEach((s, i)=> setsWrap.appendChild(renderSet(ex.id, s, i, !!ex.finished)));
  return node;
}

function renderSet(exId, s, idx, locked=false){
  const row = document.createElement('div');
  row.className = 'set-row'; row.dataset.exId = exId; row.dataset.idx = idx;
  const weight = Number(s.weight) || 0; const reps = Number(s.reps) || 0; const totalWeight = weight * reps;
  if (locked) {
    row.innerHTML = `
      <div class="weight-input-group">
        <input class="num-input" inputmode="decimal" pattern="[0-9.]*" placeholder="Wt" value="${s.weight ?? ''}" disabled/>
        <span class="lbs-label">lbs</span>
      </div>
      <input class="num-input" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" value="${s.reps ?? ''}" disabled/>
      <div class="finished-display">${Math.round(totalWeight)} lbs</div>
      <div class="flags" style="visibility:hidden;"></div>
      <div class="tools" style="visibility:hidden;"></div>
    `;
  } else {
    row.innerHTML = `
      <div class="weight-input-group">
        <input class="num-input" inputmode="decimal" pattern="[0-9.]*" placeholder="Wt" value="${s.weight ?? ''}" data-field="weight"/>
        <span class="lbs-label">lbs</span>
      </div>
      <input class="num-input" inputmode="numeric" pattern="[0-9]*" placeholder="Reps" value="${s.reps ?? ''}" data-field="reps"/>
      <div></div>
      <div class="flags">
        <label><input type="checkbox" ${s.superset?'checked':''} data-field="superset"/> Superset</label>
        <label><input type="checkbox" ${s.done?'checked':''} data-field="done"/> Done</label>
      </div>
      <div class="tools">
        <button class="btn-ghost btn-small" data-act="incW">+5</button>
        <button class="btn-ghost btn-small" data-act="decW">-5</button>
      </div>
    `;
  }
  return row;
}

/* ---------- Helpers & events ---------- */
function uid(){ return Math.random().toString(36).slice(2,9); }
function openPopup(id){ 
  $(id).style.display='flex'; 
  // Hide totals bar when opening popups
  if (id === '#bpPopup' || id === '#exPopup') {
    $('#totalsBar').classList.add('hidden');
  }
}
function closePopup(id){ 
  $(id).style.display='none'; 
  // Show totals bar when closing popups
  $('#totalsBar').classList.remove('hidden');
}
$$('.x').forEach(btn=> btn.addEventListener('click', e=> closePopup(e.target.dataset.close)));

/* Body part ‚Üí exercise flow */
let currentBP = null;

$('#addExercise').addEventListener('click', ()=>{
  const day = loadDay(current);
  const usedBodyParts = [...new Set(day.exercises.map(ex => ex.bodyPart))];
  
  const grid = $('#bpGrid'); grid.innerHTML = '';
  bodyParts.forEach(bp=>{
    const div = document.createElement('div');
    div.className = 'opt'; 
    if (usedBodyParts.includes(bp)) {
      div.classList.add('used');
    }
    div.textContent = bp; 
    div.dataset.bp = bp;
    grid.appendChild(div);
  });
  openPopup('#bpPopup');
});

// Back button in exercise popup
$('#backToBP').addEventListener('click', ()=>{
  closePopup('#exPopup');
  openPopup('#bpPopup');
});

$('#bpGrid').addEventListener('click', (e)=>{
  const bp = e.target.closest('.opt')?.dataset.bp; if(!bp) return;
  currentBP = bp;
  closePopup('#bpPopup');
  $('#exTitle').textContent = `Exercises ‚Äî ${bp}`;
  populateExerciseGrid(bp);
  $('#exCreateInput').value = '';
  openPopup('#exPopup');
});

function populateExerciseGrid(bp){
  const day = loadDay(current);
  const usedExercises = day.exercises.filter(ex => ex.bodyPart === bp).map(ex => ex.name);
  
  const grid = $('#exGrid'); grid.innerHTML = '';
  getAllExercises(bp).forEach(name=>{
    const div = document.createElement('div');
    div.className='opt'; 
    if (usedExercises.includes(name)) {
      div.classList.add('used');
    }
    div.textContent = name; 
    div.dataset.name = name; 
    div.dataset.bp = bp;
    grid.appendChild(div);
  });
}

/* Create-new button: adds to custom list and immediately creates the exercise */
$('#exCreateBtn').addEventListener('click', ()=>{
  const name = ($('#exCreateInput').value || '').trim();
  if(!name || !currentBP) return;

  // Add to custom exercises
  addToCustomExercises(currentBP, name);

  // create the exercise for the day
  createExerciseForDay(currentBP, name);
  closePopup('#exPopup');
});

$('#exGrid').addEventListener('click', (e)=>{
  const opt = e.target.closest('.opt'); if(!opt) return;
  const exerciseName = opt.dataset.name;
  const bodyPart = opt.dataset.bp;
  
  // Check if exercise already exists for today
  const day = loadDay(current);
  const existingEx = day.exercises.find(ex => ex.name === exerciseName && ex.bodyPart === bodyPart);
  
  if (existingEx) {
    // Add a new set to existing exercise instead of duplicating
    existingEx.sets.push({weight:'', reps:'', superset:false, done:false});
    saveDay(day);
    render();
    closePopup('#exPopup');
  } else {
    createExerciseForDay(bodyPart, exerciseName);
    closePopup('#exPopup');
  }
});

function createExerciseForDay(bp, name){
  const day = loadDay(current);
  day.exercises.push({ id: uid(), bodyPart: bp, name, finished:false, sets:[{weight:'', reps:'', superset:false, done:false}] });
  saveDay(day); render();
}

/* Exercise / Set actions */
$('#log').addEventListener('click', (e)=>{
  const act = e.target.dataset.act; if(!act) return;
  const day = loadDay(current);

  if(act==='addSet'){
    const exId = e.target.closest('.ex').dataset.id;
    const ex = day.exercises.find(x=>x.id===exId);
    ex.sets.push({weight:'', reps:'', superset:false, done:false});
    saveDay(day); render(); return;
  }
  
  if(act==='removeSet'){
    const exId = e.target.closest('.ex').dataset.id;
    const ex = day.exercises.find(x=>x.id===exId);
    if(ex.sets.length > 1) {
      ex.sets.pop(); // Remove the last set
      saveDay(day); render();
    }
    return;
  }
  
  if(act==='toggleFinished'){
    const node = e.target.closest('.ex'); const exId = node.dataset.id;
    const ex = day.exercises.find(x=>x.id===exId);
    ex.finished = !ex.finished; saveDay(day); render(); return;
  }
  
  if(act==='incW' || act==='decW'){
    const row = e.target.closest('.set-row');
    const ex = day.exercises.find(x=>x.id===row.dataset.exId);
    const idx = Number(row.dataset.idx);
    const delta = act==='incW' ? 5 : -5;
    const w = Number(ex.sets[idx].weight||0);
    ex.sets[idx].weight = Math.max(0, w + delta);
    saveDay(day); render(); return;
  }
});

/* Autosave inputs & checkboxes */
$('#log').addEventListener('input', (e)=>{
  const row = e.target.closest('.set-row'); if(!row) return;
  const field = e.target.dataset.field; if(!field) return;
  const day = loadDay(current);
  const ex = day.exercises.find(x=>x.id===row.dataset.exId);
  const idx = Number(row.dataset.idx);

  if(field==='weight' || field==='reps'){
    let clean = e.target.value.replace(/[^\d.]/g,'');
    if(clean.replace('.','').length > 4) clean = clean.slice(0,4);
    e.target.value = clean;
    ex.sets[idx][field] = clean;
    saveDay(day);

    const exNode = row.closest('.ex');
    const {vol:ev, avg} = exStats(ex);
    exNode.querySelector('.tag').textContent = `${ex.sets.length} set(s) ‚Ä¢ ${Math.round(ev)} lb ‚Ä¢ avg ${Math.round(avg)} lb/rep`;

    const {sets, vol, exCount} = totalsFiltered(day);
    $('#tSets').textContent = sets; $('#tVol').textContent = Math.round(vol)+' lb'; $('#tEx').textContent = exCount;
    renderPowerCard(day);
  }
});

$('#log').addEventListener('change', (e)=>{
  const row = e.target.closest('.set-row'); if(!row) return;
  const field = e.target.dataset.field; if(!field) return;
  const day = loadDay(current);
  const ex = day.exercises.find(x=>x.id===row.dataset.exId);
  const idx = Number(row.dataset.idx);

  if(field==='done' || field==='superset'){
    ex.sets[idx][field] = e.target.checked; saveDay(day);
    $('#tStatus').textContent = areAllSetsDone(day) ? 'Completed' : 'In progress';
    const {sets, vol, exCount} = totalsFiltered(day);
    $('#tSets').textContent = sets; $('#tVol').textContent = Math.round(vol)+' lb'; $('#tEx').textContent = exCount;
    renderPowerCard(day);
  }
});

/* Save / Clear / Today */
$('#saveBtn').addEventListener('click', ()=>{ const day = loadDay(current); saveDay(day); $('#saveBtn').textContent = 'Saved ‚úî'; setTimeout(()=> $('#saveBtn').textContent='Save', 1100); });
$('#clearBtn').addEventListener('click', ()=>{ if(!confirm('Clear all exercises for this day?')) return; saveDay(blankDay(current)); render(); });
$('#todayBtn').addEventListener('click', ()=>{ current = new Date(); render(); });

/* Date nav & calendar */
$('#prevDay').addEventListener('click', ()=>{ current.setDate(current.getDate()-1); render(); });
$('#nextDay').addEventListener('click', ()=>{ current.setDate(current.getDate()+1); render(); });

$('#openCalendar').addEventListener('click', ()=>{ openPopup('#calPopup'); buildCalendar(current); });
$('#calPrev').addEventListener('click', ()=>{ shiftCalendar(-1); });
$('#calNext').addEventListener('click', ()=>{ shiftCalendar(1); });

function shiftCalendar(delta){ const d = new Date($('#calMonth').dataset.anchor); d.setMonth(d.getMonth()+delta); buildCalendar(d); }
function buildCalendar(anchorDate){
  const y = anchorDate.getFullYear(), m = anchorDate.getMonth();
  $('#calMonth').textContent = new Intl.DateTimeFormat(undefined,{month:'long',year:'numeric'}).format(anchorDate);
  $('#calMonth').dataset.anchor = new Date(y,m,1).toISOString();
  const grid = $('#calGrid'); grid.innerHTML='';
  const first = new Date(y,m,1).getDay();
  const last = new Date(y,m+1,0).getDate();
  for(let i=0;i<first;i++){ const c=document.createElement('div'); c.className='cal-cell'; c.style.visibility='hidden'; grid.appendChild(c); }
  for(let d=1; d<=last; d++){
    const c = document.createElement('div'); c.className='cal-cell'; c.textContent = d;
    const dateISO = new Date(y,m,d).toISOString().slice(0,10);
    if(localStorage.getItem(`powerUp:${dateISO}`)){
      const day = JSON.parse(localStorage.getItem(`powerUp:${dateISO}`));
      if(day.exercises?.length) c.classList.add('workout');
    }
    c.addEventListener('click', ()=>{ current = new Date(y,m,d); closePopup('#calPopup'); render(); });
    grid.appendChild(c);
  }
}

/* Boot */
(function init(){
  const legacy = localStorage.getItem('powerUp');
  if(legacy){ try{ const data = JSON.parse(legacy); if(data?.date){ localStorage.setItem(`powerUp:${data.date}`, legacy); } }catch{} }
  current = new Date(); render();
  window.addEventListener('resize', ()=>{ const day = loadDay(current); renderPowerCard(day); });
})();
</script>
</body>
</html>
