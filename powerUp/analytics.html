<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Power Up! ‚Äî Analytics</title>
<style>
  :root{
    --bg:#0b0f14; --card:#131a22; --ink:#e8eef6; --muted:#9fb0c7; --accent:#4CAF50; --accent-2:#2dd4bf;
    --ring:#2a3543; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
    --gradient-primary: linear-gradient(135deg, #4CAF50, #2dd4bf);
    --gradient-warning: linear-gradient(135deg, #f59e0b, #fb923c);
    --gradient-danger: linear-gradient(135deg, #ef4444, #f87171);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#0a0e13 0%, #0d131a 100%); color:var(--ink);
    display:flex; flex-direction:column; overflow-x:hidden;
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:.6rem .9rem; border-bottom:1px solid var(--ring); background:#0e141b;
  }
  header h1{margin:0; font-size:1.05rem; letter-spacing:.2px}
  header .home{all:unset; cursor:pointer; padding:.35rem .6rem; border-radius:.6rem; border:1px solid var(--ring)}
  header .nav-tabs{display:flex; gap:2px; background:#0a1016; padding:4px; border-radius:10px; border:1px solid var(--ring)}
  header .tab{all:unset; cursor:pointer; padding:.4rem .8rem; border-radius:8px; font-size:.9rem; color:var(--muted); transition:all .2s}
  header .tab.active{background:var(--gradient-primary); color:#04130a; font-weight:600}

  .wrap{width:min(1200px, 100%); margin-inline:auto; padding:12px; flex:1; display:flex; flex-direction:column; gap:12px}

  .grid{display:grid; gap:12px; grid-template-columns: repeat(12, 1fr)}
  .card{
    background:var(--card); border:1px solid var(--ring); border-radius:14px;
    padding:14px; box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:.1rem 0 .6rem; font-size:1rem; color:var(--muted); font-weight:600; display:flex; align-items:center; gap:8px}
  .card-icon{font-size:1.1rem}

  .stat-card{grid-column: span 3; text-align:center; position:relative; overflow:hidden}
  .stat-card::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gradient-primary)}
  .stat-value{font-size:2rem; font-weight:800; margin:.5rem 0 .2rem; background:var(--gradient-primary); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text}
  .stat-label{font-size:.85rem; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}
  .stat-trend{font-size:.8rem; margin-top:.3rem; display:flex; align-items:center; justify-content:center; gap:4px}
  .trend-up{color:var(--good)} .trend-down{color:var(--bad)} .trend-neutral{color:var(--muted)}

  /* Compact summary row + top actions */
  .top-actions{display:flex; align-items:center; gap:10px}
  .download-btn{all:unset; cursor:pointer; padding:.5rem .85rem; border-radius:10px; font-size:.85rem; font-weight:700;
    background:var(--gradient-primary); color:#04130a; box-shadow:0 6px 18px rgba(34,197,94,.18)}
  .download-btn:active{transform:translateY(1px)}
  .stats-row{grid-column: span 12; display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:10px}
  .stats-row .stat-card{grid-column: auto; padding:10px}
  .stats-row .stat-value{font-size:1.35rem; margin:.35rem 0 .15rem}
  .stats-row .stat-label{font-size:.75rem}
  .stats-row .stat-trend{font-size:.74rem; margin-top:.2rem}
  .stats-row .card-icon{font-size:1rem}
  @media (max-width: 640px){
    .stats-row{grid-template-columns:repeat(2, minmax(0, 1fr))}
  }


  .chart-card{grid-column: span 8; position:relative}
  .chart-controls{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
  .btn{all:unset; cursor:pointer; padding:.5rem .8rem; border-radius:8px; font-size:.85rem; font-weight:600; transition:all .2s}
  .btn-primary{background:var(--gradient-primary); color:#04130a}
  .btn-ghost{border:1px solid var(--ring); color:var(--muted)}
  .btn-ghost:hover{background:rgba(255,255,255,.05)}
  .btn-ghost.active{background:var(--accent-2); color:#04130a}
  .chart-container{height:300px; position:relative}
  .chart{width:100%; height:100%}

  .pr-card{grid-column: span 4}
  .pr-list{display:flex; flex-direction:column; gap:8px; max-height:280px; overflow-y:auto}
  .pr-item{background:#0f141b; border:1px solid var(--ring); border-radius:10px; padding:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:all .2s}
  .pr-item:hover{background:#1a1f26; border-color:var(--accent)}
  .pr-exercise{font-weight:600; color:var(--ink)}
  .pr-weight{color:var(--accent-2); font-weight:700}
  .pr-date{font-size:.8rem; color:var(--muted)}

  .progression-card{grid-column: span 12}
  .exercise-selector{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap}
  .exercise-chip{all:unset; cursor:pointer; padding:.4rem .7rem; border-radius:20px; border:1px solid var(--ring); color:var(--muted); font-size:.85rem; transition:all .2s}
  .exercise-chip:hover{background:rgba(255,255,255,.05)}
  .exercise-chip.active{background:var(--accent); color:#04130a; border-color:var(--accent)}
  
  /* FIX #7: Muscle group filters */
  .muscle-filters{display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; padding:10px; background:#0a0f14; border-radius:10px; border:1px solid var(--ring)}
  .filter-btn{all:unset; cursor:pointer; padding:.35rem .65rem; border-radius:16px; border:1px solid var(--ring); color:var(--muted); font-size:.8rem; transition:all .2s; background:#0e141b}
  .filter-btn:hover{background:rgba(255,255,255,.05)}
  .filter-btn.active{background:var(--accent); color:#04130a; border-color:var(--accent); font-weight:600}

  .progression-stat{text-align:center; padding:12px; background:#0f141b; border:1px solid var(--ring); border-radius:10px}
  .progression-stat .stat-value{font-size:1.2rem; font-weight:700; margin-bottom:4px}
  .progression-stat .stat-label{font-size:.8rem; color:var(--muted)}

  .no-progression-data{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    text-align:center; color:var(--muted); font-size:1rem;
  }

  /* FIX #6: Removed "This Week" section styles - no longer needed */

  .popup{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; padding:10px; z-index:100}
  .sheet{width:min(700px, 96%); max-height:85vh; overflow:auto; background:#0b1118; border:1px solid var(--ring); border-radius:14px; padding:16px}
  .x{all:unset; cursor:pointer; float:right; border:1px solid var(--ring); padding:.25rem .5rem; border-radius:8px; color:#9fb0c7}

  @media (max-width: 1024px){
    .stat-card{grid-column: span 6}
    .chart-card{grid-column: span 12}
    .pr-card{grid-column: span 12}
  }
  @media (max-width: 640px){
    .stat-card{grid-column: span 12}
    .wrap{padding:8px; gap:8px}
    .card{padding:10px}
    .stat-value{font-size:1.6rem}
    .chart-container{height:250px}
    header .nav-tabs{display:none}
  }
  /* === Monthly + Weekly Summary blocks === */
  .summary-card{grid-column: span 12; padding:12px}
  .summary-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .summary-title{font-size:1rem; font-weight:700; color:var(--ink); letter-spacing:.2px}
  .summary-nav{display:flex; align-items:center; gap:6px}
  .nav-btn{all:unset; cursor:pointer; width:34px; height:30px; display:grid; place-items:center;
    border:1px solid var(--ring); border-radius:10px; color:var(--muted); background:#0e141b; transition:all .15s}
  .nav-btn:hover{background:rgba(255,255,255,.05)}
  .nav-btn:active{transform:translateY(1px)}
  .summary-metrics{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px}
  .summary-metric{background:#0f141b; border:1px solid var(--ring); border-radius:12px; padding:10px; text-align:center}
  .summary-metric .v{font-size:1.15rem; font-weight:800; color:var(--ink)}
  .summary-metric .l{font-size:.75rem; color:var(--muted); text-transform:uppercase; letter-spacing:.4px; margin-top:2px}

  /* === Exercise dropdown === */
  .exercise-selector{display:flex; align-items:center; gap:10px; margin-bottom:12px; flex-wrap:wrap}
  .exercise-selector label{color:var(--muted); font-size:.85rem}
  .exercise-dropdown{
    min-width:min(520px, 100%);
    padding:.6rem .75rem;
    border:1px solid var(--ring);
    border-radius:12px;
    background:#0a1016;
    color:var(--ink);
    font-weight:600;
    outline:none;
  }
  .exercise-dropdown:focus{border-color:color-mix(in oklab, var(--accent), #000 35%); box-shadow:0 0 0 2px rgba(45,212,191,.12)}

  /* === Personal Records one-line compression === */
  .pr-item{gap:10px}
  .pr-one-line{display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%}
  .pr-one-line .left{min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .pr-one-line .right{white-space:nowrap; color:var(--accent-2); font-weight:800}
  .pr-one-line .meta{color:var(--muted); font-weight:600}

</style>
</head>
<body>
  <header>
    <button class="home" onclick="location.href='index.html'">‚üµ Back</button>
    <h1>Power Up! ‚Äî Analytics</h1>
    <div class="nav-tabs">
      <button class="tab active" data-view="overview">Overview</button>
      <button class="tab" data-view="trends">Trends</button>
      <button class="tab" data-view="records">Records</button>
    </div>
  </header>

  <div class="wrap">
    <div class="top-actions">
      <button class="download-btn" id="downloadDataBtn">Download Data</button>
    </div>

    <div id="overviewTab" class="tab-content">
      <section class="grid">
        <div class="stats-row">
          <article class="card stat-card">
            <div class="card-icon">üí™</div>
            <div class="stat-value" id="totalVolume">0</div>
            <div class="stat-label">Total Volume (lb)</div>
            <div class="stat-trend trend-up" id="volumeTrend">‚Üó +12% this week</div>
          </article>

          <article class="card stat-card">
            <div class="card-icon">üèãÔ∏è</div>
            <div class="stat-value" id="totalWorkouts">0</div>
            <div class="stat-label">Total Workouts</div>
            <div class="stat-trend trend-neutral" id="workoutTrend">‚Üí Same as last week</div>
          </article>
        </div>


        <article class="card summary-card" id="monthlySummaryCard">
          <div class="summary-head">
            <div class="summary-nav">
              <button class="nav-btn" id="monthPrev" title="Previous month">‚Üê</button>
              <div class="summary-title" id="monthHeader">‚Äî</div>
              <button class="nav-btn" id="monthNext" title="Next month">‚Üí</button>
            </div>
          </div>
          <div class="summary-metrics">
            <div class="summary-metric">
              <div class="v" id="monthWorkouts">0</div>
              <div class="l">Workouts this month</div>
            </div>
            <div class="summary-metric">
              <div class="v" id="monthVolume">0</div>
              <div class="l">Volume this month (lb)</div>
            </div>
          </div>
        </article>

        <article class="card summary-card" id="weeklySummaryCard">
          <div class="summary-head">
            <div class="summary-nav">
              <button class="nav-btn" id="weekPrev" title="Previous week">‚Üê</button>
              <div class="summary-title" id="weekHeader">‚Äî</div>
              <button class="nav-btn" id="weekNext" title="Next week">‚Üí</button>
            </div>
          </div>
          <div class="summary-metrics">
            <div class="summary-metric">
              <div class="v" id="weekWorkouts">0</div>
              <div class="l">Workouts this week</div>
            </div>
            <div class="summary-metric">
              <div class="v" id="weekVolume">0</div>
              <div class="l">Volume this week (lb)</div>
            </div>
          </div>
        </article>


        <!-- FIX #4: Volume Trends as BAR CHART -->
        <article class="card chart-card">
          <h3><span class="card-icon">üìä</span>Volume Trends</h3>
          <div class="chart-controls">
            <button class="btn btn-ghost active" data-period="7d">7 Days</button>
            <button class="btn btn-ghost" data-period="14d">14 Days</button>
            <button class="btn btn-ghost" data-period="28d">28 Days</button>
          </div>
          <div class="chart-container">
            <canvas class="chart" id="volumeChart"></canvas>
          </div>
        </article>

        <!-- FIX #5: Clickable Personal Records -->
        <article class="card pr-card">
          <h3><span class="card-icon">üèÜ</span>Personal Records</h3>
          <div class="pr-list" id="prList"></div>
        </article>

        <!-- FIX #7: ALL exercises with filters -->
        <article class="card progression-card">
          <h3><span class="card-icon">üìà</span>Exercise Progression</h3>
          <div class="muscle-filters" id="muscleFilters"></div>
          <div class="exercise-selector" id="exerciseSelector"></div>
          <div class="chart-container">
            <canvas class="chart" id="progressionChart"></canvas>
          </div>
          <div id="progression-info" style="margin-top:12px"></div>
        </article>
      </section>
    </div>

    <div id="trendsTab" class="tab-content" style="display:none">
      <section class="grid">
        <article class="card chart-card" style="grid-column: span 12">
          <h3><span class="card-icon">üìà</span>Monthly Volume Comparison</h3>
          <div class="chart-container" style="height:400px">
            <canvas class="chart" id="monthlyChart"></canvas>
          </div>
        </article>
        
        <article class="card chart-card" style="grid-column: span 6">
          <h3><span class="card-icon">‚öñÔ∏è</span>Body Weight Trend</h3>
          <div class="chart-container">
            <canvas class="chart" id="weightChart"></canvas>
          </div>
        </article>

        <article class="card chart-card" style="grid-column: span 6">
          <h3><span class="card-icon">üéØ</span>Workout Frequency</h3>
          <div class="chart-container">
            <canvas class="chart" id="frequencyChart"></canvas>
          </div>
        </article>
      </section>
    </div>

    <div id="recordsTab" class="tab-content" style="display:none">
      <section class="grid">
        <article class="card" style="grid-column: span 12">
          <h3><span class="card-icon">üèÜ</span>All Personal Records</h3>
          <div id="allRecords"></div>
        </article>
      </section>
    </div>
  </div>

  <!-- FIX #5: PR Detail Popup -->
  <div class="popup" id="prDetailPopup">
    <div class="sheet">
      <button class="x" onclick="document.getElementById('prDetailPopup').style.display='none'">‚úï</button>
      <h2 id="prDetailTitle" style="margin:6px 0 10px; font-size:1.2rem; color:var(--ink)">Exercise Progression</h2>
      <div id="prDetailInfo" style="margin:10px 0; padding:10px; background:#0e141b; border-radius:8px; border:1px solid var(--ring)"></div>
      <canvas id="prDetailChart" style="width:100%; height:300px"></canvas>
      <div style="margin-top:10px; font-size:.85rem; color:var(--muted); text-align:center">
        üí° Yellow/orange bars indicate personal record sessions
      </div>
    </div>
  </div>

<script>
function readLocalDays(){
  const out = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!/^powerUp:\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    try{
      const day = JSON.parse(localStorage.getItem(k));
      if(!day?.date) continue;
      const converted = {
        date: day.date,
        bodyWeight: day.bodyWeight ?? undefined,
        exercises: (day.exercises||[]).map(ex=>({
          name: ex.name || ex.exercise || 'Exercise',
          bodyPart: ex.bodyPart || 'Unknown',
          sets: (ex.sets||[]).map(s=>({
            reps: Number(s.reps)||0,
            weight: Number(s.weight)||0,
            completed: !!s.done
          })),
          finished: !!ex.finished
        }))
      };
      out.push(converted);
    }catch(e){}
  }
  return out.sort((a,b)=> new Date(a.date) - new Date(b.date));
}

const workouts = readLocalDays();
const today = new Date();
const todayISO = today.toISOString().slice(0,10);

// === Month / Week summary state ===
let selectedMonth = new Date(today.getFullYear(), today.getMonth(), 1);
let selectedWeekStart = null; // Date (Sunday) within selectedMonth

function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }

function startOfWeekSunday(d){
  const x = new Date(d);
  const day = x.getDay(); // 0=Sun
  x.setDate(x.getDate() - day);
  x.setHours(0,0,0,0);
  return x;
}

// Week navigation must stay within the selected month.
// We enforce "full weeks" that are completely inside the month (Sun‚ÜíSat).
function firstSelectableWeekStart(monthDate){
  const ms = startOfMonth(monthDate);
  if(ms.getDay() === 0) return new Date(ms); // month starts Sunday
  // otherwise first full week starts on first Sunday AFTER the month start
  const firstSun = startOfWeekSunday(addDays(ms, 7));
  return firstSun;
}
function lastSelectableWeekStart(monthDate){
  const ms = startOfMonth(monthDate);
  const me = endOfMonth(monthDate);
  const latestStart = addDays(me, -6); // ensures Sun->Sat stays in month
  const candidate = startOfWeekSunday(latestStart);
  if(candidate < ms) return firstSelectableWeekStart(monthDate);
  return candidate;
}

function setDefaultWeekForMonth(){
  const ms = startOfMonth(selectedMonth);

  // Prefer the current week if we are looking at the current month; otherwise the first selectable week.
  const base = (ms.getFullYear() === today.getFullYear() && ms.getMonth() === today.getMonth())
    ? new Date(today)
    : new Date(ms);

  let ws = startOfWeekSunday(base);

  const firstWS = firstSelectableWeekStart(selectedMonth);
  const lastWS  = lastSelectableWeekStart(selectedMonth);

  if(ws < firstWS) ws = new Date(firstWS);
  if(ws > lastWS)  ws = new Date(lastWS);

  selectedWeekStart = ws;
}

function formatMonthHeader(d){
  return d.toLocaleDateString('en', { month:'long' });
}
function formatMD(d){
  return `${d.getMonth()+1}/${d.getDate()}`;
}
function formatWeekHeader(ws){
  const we = addDays(ws, 6);
  return `${formatMD(ws)} ‚Äì ${formatMD(we)}`;
}

function monthStats(monthDate){
  const ms = startOfMonth(monthDate);
  const me = endOfMonth(monthDate);

  const inMonth = workouts.filter(w=>{
    const wd = new Date(w.date + 'T00:00:00');
    return wd >= ms && wd <= me;
  });

  return {
    workouts: inMonth.length,
    volume: inMonth.reduce((s,w)=> s + totalVolume(w), 0)
  };
}

function weekStats(weekStart, monthDate){
  const ms = startOfMonth(monthDate);
  const me = endOfMonth(monthDate);
  const we = addDays(weekStart, 6);

  const inWeek = workouts.filter(w=>{
    const wd = new Date(w.date + 'T00:00:00');
    return wd >= weekStart && wd <= we && wd >= ms && wd <= me;
  });

  return {
    workouts: inWeek.length,
    volume: inWeek.reduce((s,w)=> s + totalVolume(w), 0)
  };
}

function renderMonthWeekSummaries(){
  if(!selectedWeekStart) setDefaultWeekForMonth();

  // Month
  const m = monthStats(selectedMonth);
  const mh = document.getElementById('monthHeader');
  if(mh) mh.textContent = formatMonthHeader(selectedMonth);
  const mw = document.getElementById('monthWorkouts');
  if(mw) mw.textContent = m.workouts.toLocaleString();
  const mv = document.getElementById('monthVolume');
  if(mv) mv.textContent = Math.round(m.volume).toLocaleString();

  // Week
  const w = weekStats(selectedWeekStart, selectedMonth);
  const wh = document.getElementById('weekHeader');
  if(wh) wh.textContent = formatWeekHeader(selectedWeekStart);
  const ww = document.getElementById('weekWorkouts');
  if(ww) ww.textContent = w.workouts.toLocaleString();
  const wv = document.getElementById('weekVolume');
  if(wv) wv.textContent = Math.round(w.volume).toLocaleString();

  // Button enable/disable
  const firstWS = firstSelectableWeekStart(selectedMonth);
  const lastWS  = lastSelectableWeekStart(selectedMonth);
  const prevBtn = document.getElementById('weekPrev');
  const nextBtn = document.getElementById('weekNext');

  if(prevBtn){
    prevBtn.style.opacity = (selectedWeekStart <= firstWS) ? .45 : 1;
    prevBtn.style.pointerEvents = (selectedWeekStart <= firstWS) ? 'none' : 'auto';
  }
  if(nextBtn){
    nextBtn.style.opacity = (selectedWeekStart >= lastWS) ? .45 : 1;
    nextBtn.style.pointerEvents = (selectedWeekStart >= lastWS) ? 'none' : 'auto';
  }
}

function bindMonthWeekNav(){
  const monthPrev = document.getElementById('monthPrev');
  const monthNext = document.getElementById('monthNext');
  const weekPrev  = document.getElementById('weekPrev');
  const weekNext  = document.getElementById('weekNext');

  if(monthPrev && !monthPrev.dataset.bound){
    monthPrev.dataset.bound = '1';
    monthPrev.addEventListener('click', ()=>{
      selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth()-1, 1);
      selectedWeekStart = null;
      renderMonthWeekSummaries();
    });
  }
  if(monthNext && !monthNext.dataset.bound){
    monthNext.dataset.bound = '1';
    monthNext.addEventListener('click', ()=>{
      selectedMonth = new Date(selectedMonth.getFullYear(), selectedMonth.getMonth()+1, 1);
      selectedWeekStart = null;
      renderMonthWeekSummaries();
    });
  }
  if(weekPrev && !weekPrev.dataset.bound){
    weekPrev.dataset.bound = '1';
    weekPrev.addEventListener('click', ()=>{
      const firstWS = firstSelectableWeekStart(selectedMonth);
      const next = addDays(selectedWeekStart, -7);
      if(next >= firstWS){
        selectedWeekStart = next;
        renderMonthWeekSummaries();
      }
    });
  }
  if(weekNext && !weekNext.dataset.bound){
    weekNext.dataset.bound = '1';
    weekNext.addEventListener('click', ()=>{
      const lastWS = lastSelectableWeekStart(selectedMonth);
      const next = addDays(selectedWeekStart, 7);
      if(next <= lastWS){
        selectedWeekStart = next;
        renderMonthWeekSummaries();
      }
    });
  }
}

// Remember dropdown selection when switching muscle groups
let lastSelectedExerciseKey = null;

function exportAllWorkoutData(){
  const all = [];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!/^powerUp:\d{4}-\d{2}-\d{2}$/.test(k)) continue;
    try{
      const day = JSON.parse(localStorage.getItem(k));
      if(day && day.date) all.push(day);
    }catch(e){}
  }
  all.sort((a,b)=> new Date(a.date) - new Date(b.date));
  return all;
}

function downloadJSON(filename, dataObj){
  const blob = new Blob([JSON.stringify(dataObj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}

function totalVolume(workout){
  // Count ALL logged sets (even if not explicitly marked 'done'),
  // so analytics matches the index/calendar totals.
  return workout.exercises.reduce((sum, ex) => {
    return sum + ex.sets.reduce((setSum, set) => {
      const w = Number(set.weight) || 0;
      const r = Number(set.reps) || 0;
      if(w > 0 && r > 0) return setSum + (w * r);
      return setSum;
    }, 0);
  }, 0);
}

function totalSets(workout){
  // Count ALL sets that have any entered weight or reps.
  return workout.exercises.reduce((sum, ex) => {
    const count = ex.sets.filter(s => (Number(s.weight)||0) > 0 || (Number(s.reps)||0) > 0).length;
    return sum + count;
  }, 0);
}

function getPersonalRecords(){
  const records = new Map();
  
  workouts.forEach(workout => {
    workout.exercises.forEach(ex => {
      ex.sets.forEach(set => {
        if(set.weight > 0) {
          const key = ex.name.toLowerCase();
          const currentPR = records.get(key);
          if(!currentPR || set.weight > currentPR.weight) {
            records.set(key, {
              exercise: ex.name,
              weight: set.weight,
              reps: set.reps,
              date: workout.date,
              bodyPart: ex.bodyPart
            });
          }
        }
      });
    });
  });
  
  return Array.from(records.values()).sort((a,b) => b.weight - a.weight);
}

function getPeriodStats(days = 7){
  const cutoff = new Date(today);
  cutoff.setDate(today.getDate() - days);
  
  const periodWorkouts = workouts.filter(w => new Date(w.date) >= cutoff);
  const volume = periodWorkouts.reduce((sum, w) => sum + totalVolume(w), 0);
  const sets = periodWorkouts.reduce((sum, w) => sum + totalSets(w), 0);
  
  return {
    workouts: periodWorkouts.length,
    volume,
    sets,
    avgVolume: periodWorkouts.length ? Math.round(volume / periodWorkouts.length) : 0
  };
}

/* FIX #4: Bar Chart with Y-axis labels */

function drawBarChart(canvasId, data, options = {}){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return;

  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();

  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const width = rect.width;
  const height = rect.height;

  const paddingTop = 22;
  const paddingBottom = 34;
  const leftPadding = 64;
  const rightPadding = 18;

  ctx.clearRect(0, 0, width, height);

  if(!data || data.length === 0) return;

  const values = data.map(d => Number(d.y) || 0);
  const maxY = Math.max(...values, 1);

  const plotW = width - leftPadding - rightPadding;
  const plotH = height - paddingTop - paddingBottom;
  const gap = Math.max(2, Math.floor(plotW / Math.max(1, data.length) * 0.15));
  const barW = Math.max(2, Math.floor((plotW - gap * (data.length - 1)) / data.length));

  // Y-axis label
  ctx.save();
  ctx.translate(18, paddingTop + plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillStyle = '#9fb0c7';
  ctx.font = 'bold 12px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(options.yLabel || 'Total Volume (lb)', 0, 0);
  ctx.restore();

  // Y grid + labels
  ctx.fillStyle = '#9fb0c7';
  ctx.font = '10px sans-serif';
  ctx.textAlign = 'right';

  for(let i = 0; i <= 4; i++) {
    const value = Math.round((maxY / 4) * i);
    const y = paddingTop + plotH - (i / 4) * plotH;

    // Grid line
    ctx.strokeStyle = '#233446';
    ctx.lineWidth = 1;
    ctx.setLineDash([2, 3]);
    ctx.beginPath();
    ctx.moveTo(leftPadding, y);
    ctx.lineTo(width - rightPadding, y);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillText(value.toLocaleString(), leftPadding - 6, y + 3);
  }

  // Bars + optional top labels
  data.forEach((point, index) => {
    const x = leftPadding + index * (barW + gap);
    const barH = (Number(point.y) / maxY) * plotH;
    const y = paddingTop + plotH - barH;

    const gradient = ctx.createLinearGradient(x, y, x, paddingTop + plotH);
    gradient.addColorStop(0, options.color || '#4CAF50');
    gradient.addColorStop(1, options.color2 || '#22c55e');

    ctx.fillStyle = gradient;
    ctx.fillRect(x, y, barW, barH);

    const topLabel = point.label || options.valueLabel?.(point, index);
    if(topLabel && barH > 14){
      ctx.fillStyle = '#e8eef6';
      ctx.font = 'bold 9px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(String(topLabel), x + barW/2, Math.max(10, y - 4));
    }

    // Consistency dot near baseline (workout / no-workout)
    if(options.showWorkoutDots){
      const dotY = paddingTop + plotH + 8; // slightly below baseline
      ctx.beginPath();
      ctx.arc(x + barW/2, dotY, 3, 0, Math.PI*2);
      ctx.fillStyle = point.didWorkout ? (options.dotOnColor || '#22c55e') : (options.dotOffColor || '#233446');
      ctx.fill();
    }
  });

  // X-axis labels
  const labels = options.xLabels || data.map(d => d.xLabel).filter(Boolean);
  if(labels && labels.length){
    const many = labels.length > 10;
    ctx.fillStyle = '#9fb0c7';
    ctx.font = '9px sans-serif';
    ctx.textAlign = 'center';

    labels.forEach((lab, i) => {
      const x = leftPadding + i * (barW + gap) + barW/2;
      const y = height - 10;

      if(many){
        ctx.save();
        ctx.translate(x, height - 6);
        ctx.rotate(-Math.PI/4);
        ctx.fillText(String(lab), 0, 0);
        ctx.restore();
      } else {
        ctx.fillText(String(lab), x, y);
      }
    });
  }
}

/* FIX #7: Get ALL exercises */
function getAllExercisesFromWorkouts() {
  const exerciseMap = new Map();
  
  workouts.forEach(workout => {
    workout.exercises.forEach(ex => {
      const key = `${ex.name}|${ex.bodyPart}`;
      if(!exerciseMap.has(key)) {
        exerciseMap.set(key, {
          name: ex.name,
          bodyPart: ex.bodyPart,
          workoutCount: 0
        });
      }
      exerciseMap.get(key).workoutCount++;
    });
  });
  
  return Array.from(exerciseMap.values())
    .sort((a, b) => b.workoutCount - a.workoutCount);
}

/* FIX #7: Muscle group filters */
function renderMuscleGroupFilters() {
  const container = document.getElementById('muscleFilters');
  const bodyParts = [...new Set(workouts.flatMap(w => 
    w.exercises.map(ex => ex.bodyPart)
  ))].sort();
  
  container.innerHTML = `
    <button class="filter-btn active" data-filter="all">All Exercises</button>
    ${bodyParts.map(bp => `
      <button class="filter-btn" data-filter="${bp}">${bp}</button>
    `).join('')}
  `;
  
  container.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      container.querySelectorAll('.filter-btn').forEach(b => 
        b.classList.remove('active'));
      btn.classList.add('active');
      
      const filter = btn.dataset.filter;
      renderFilteredExercises(filter);
    });
  });
}

/* FIX #7: Render exercises with filter */
function renderFilteredExercises(bodyPartFilter = 'all') {
  const exercises = getAllExercisesFromWorkouts();
  const filtered = bodyPartFilter === 'all'
    ? exercises
    : exercises.filter(ex => ex.bodyPart === bodyPartFilter);

  const selector = document.getElementById('exerciseSelector');
  if(!selector) return;

  if(filtered.length === 0) {
    selector.innerHTML = '<p style="color:var(--muted); padding:10px 0; margin:0">No exercises found for this muscle group</p>';
    const ctx = document.getElementById('progressionChart')?.getContext?.('2d');
    if(ctx) ctx.clearRect(0, 0, 2000, 2000);
    return;
  }

  // Dropdown replaces the long scrolling list (saves vertical space)
  selector.innerHTML = `
    <label for="exerciseDropdown">Exercise</label>
    <select class="exercise-dropdown" id="exerciseDropdown"></select>
  `;

  const dd = document.getElementById('exerciseDropdown');
  if(!dd) return;

  // Keep "most performed" at the top (already sorted by workoutCount desc)
  filtered.forEach(ex => {
    const opt = document.createElement('option');
    opt.value = `${ex.name}|||${ex.bodyPart}`;
    opt.textContent = `${ex.name} (${ex.workoutCount})`;
    dd.appendChild(opt);
  });

  // Restore last selection if it still exists; otherwise default to top option (most performed)
  if(lastSelectedExerciseKey) {
    const idx = Array.from(dd.options).findIndex(o => o.value === lastSelectedExerciseKey);
    if(idx >= 0) dd.selectedIndex = idx;
  }
  if(dd.selectedIndex < 0) dd.selectedIndex = 0;

  const [firstName, firstBodyPart] = dd.value.split('|||');

  // Draw initial chart, but never allow this to block month/week summaries, etc.
  try {
    drawProgressionChart(firstName, firstBodyPart);
  } catch (e) {
    console.warn('[progression] draw failed:', e);
  }

  dd.addEventListener('change', () => {
    lastSelectedExerciseKey = dd.value;
    const [name, bodyPart] = dd.value.split('|||');
    try {
      drawProgressionChart(name, bodyPart);
    } catch (e) {
      console.warn('[progression] draw failed:', e);
    }
  });
}


function drawVolumeChart(period = '7d'){
  // Daily bars for consistency view (includes 0-volume days)
  const volByDate = new Map();
  workouts.forEach(w => volByDate.set(w.date, totalVolume(w)));

  const days =
    period === '7d'  ? 7  :
    period === '14d' ? 14 :
    28;

  const start = new Date(today);
  start.setDate(today.getDate() - (days - 1));

  const data = [];
  for(let i=0; i<days; i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    const iso = d.toISOString().slice(0,10);

    const vol = volByDate.get(iso) || 0;

    data.push({
      date: iso,
      y: vol,
      xLabel: d.toLocaleDateString(undefined, { month:'short', day:'numeric' }),
      didWorkout: vol > 0,
      label: vol ? Math.round(vol).toLocaleString() : ''
    });
  }

  drawBarChart('volumeChart', data, {
    color: '#4CAF50',
    color2: '#22c55e',
    yLabel: 'Total Volume (lb)',
    xLabels: data.map(d => d.xLabel),
    showWorkoutDots: true
  });
}

/* FIX #5: PR Detail with chart */
function getExerciseHistory(exerciseName, bodyPart, maxWorkouts = 20) {
  const history = [];
  
  workouts.forEach(workout => {
    const exercise = workout.exercises.find(ex => 
      ex.name.toLowerCase().trim() === exerciseName.toLowerCase().trim() &&
      ex.bodyPart === bodyPart
    );
    
    if(exercise && exercise.sets && exercise.sets.length > 0) {
      const completedSets = exercise.sets.filter(set => (Number(set.weight)||0) > 0 && (Number(set.reps)||0) > 0);
      
      if(completedSets.length > 0) {
        const maxWeight = Math.max(...completedSets
          .map(s => Number(s.weight) || 0)
          .filter(w => w > 0));
        
        if(maxWeight > 0) {
          history.push({
            date: workout.date,
            y: maxWeight,
            workout: workout
          });
        }
      }
    }
  });
  
  history.sort((a, b) => new Date(a.date) - new Date(b.date));
  return history.slice(-maxWorkouts);
}

/* FIX #5: Draw PR chart with yellow highlights */
function drawPRChart(canvasId, data, prWeight, options = {}){
  const canvas = document.getElementById(canvasId);
  if(!canvas || !data || data.length === 0) return;
  
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  
  const width = rect.width;
  const height = rect.height;
  const padding = 40;
  const barWidth = Math.max(20, (width - 2 * padding) / data.length - 10);
  
  const values = data.map(d => d.y);
  const maxY = Math.max(...values);
  
  ctx.clearRect(0, 0, width, height);
  
  // Grid lines
  ctx.strokeStyle = '#233446';
  ctx.lineWidth = 1;
  ctx.setLineDash([2, 3]);
  for(let i = 0; i <= 4; i++) {
    const y = padding + (i / 4) * (height - 2 * padding);
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(width - padding, y);
    ctx.stroke();
  }
  ctx.setLineDash([]);
  
  // Draw bars
  data.forEach((item, i) => {
    const x = padding + i * (barWidth + 10);
    const barHeight = (item.y / maxY) * (height - 2 * padding);
    const y = height - padding - barHeight;
    
    // Highlight PRs in yellow/orange
    let gradient;
    if(item.y === prWeight) {
      gradient = ctx.createLinearGradient(x, y, x, height - padding);
      gradient.addColorStop(0, '#fbbf24');
      gradient.addColorStop(1, '#f59e0b');
    } else {
      gradient = ctx.createLinearGradient(x, y, x, height - padding);
      gradient.addColorStop(0, '#4CAF50');
      gradient.addColorStop(1, '#22c55e');
    }
    
    ctx.fillStyle = gradient;
    ctx.fillRect(x, y, barWidth, barHeight);
    
    // Weight label
    ctx.fillStyle = item.y === prWeight ? '#fbbf24' : '#e8eef6';
    ctx.font = item.y === prWeight ? 'bold 11px sans-serif' : '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(item.y + 'lb', x + barWidth/2, y - 5);
    
    // Date label
    if(data.length <= 10) {
      ctx.fillStyle = '#9fb0c7';
      ctx.font = '9px sans-serif';
      const dateLabel = new Date(item.date).toLocaleDateString('en', {month:'short', day:'numeric'});
      ctx.fillText(dateLabel, x + barWidth/2, height - padding + 15);
    }
  });
}


function getExerciseProgressionHistory(exerciseName, bodyPart, maxWorkouts = 20) {
  const history = [];

  workouts.forEach(workout => {
    const exercise = workout.exercises.find(ex =>
      ex.name.toLowerCase().trim() === exerciseName.toLowerCase().trim() &&
      ex.bodyPart === bodyPart
    );

    if(!exercise || !exercise.sets || exercise.sets.length === 0) return;

    const completedSets = exercise.sets.filter(set => (Number(set.weight)||0) > 0 && (Number(set.reps)||0) > 0);
    if(completedSets.length === 0) return;

    // Find max weight for that day, then max reps at that weight
    const maxW = Math.max(...completedSets.map(s => Number(s.weight) || 0));
    if(!maxW || maxW <= 0) return;

    const maxR = Math.max(...completedSets
      .filter(s => (Number(s.weight) || 0) === maxW)
      .map(s => Number(s.reps) || 0));

    history.push({
      date: workout.date,
      y: maxW,          // keep bar height based on weight
      weight: maxW,
      reps: maxR || 0,
      label: `${maxW}√ó${maxR||0}`
    });
  });

  history.sort((a, b) => new Date(a.date) - new Date(b.date));
  return history.slice(-maxWorkouts);
}

function drawProgressionChart(exerciseName, bodyPart) {
  if(!exerciseName) return;

  const progressionData = getExerciseProgressionHistory(exerciseName, bodyPart);

  const canvas = document.getElementById('progressionChart');
  const container = canvas.parentElement;
  const existingMessage = container.querySelector('.no-progression-data');
  if(existingMessage) existingMessage.remove();

  if(progressionData.length === 0) {
    renderNoProgressionData(exerciseName);
    return;
  }

  const xLabels = progressionData.map(d => {
    const dt = new Date(d.date + 'T00:00:00');
    return String(dt.getDate());
  });

  // Keep labels readable on longer histories
  const tickEvery = (xLabels.length >= 16 ? 2 : 1);

  drawBarChart('progressionChart', progressionData, {
    color: '$1',
    color2: '$2',
    yLabel: '$3',
    xLabels,
    xTickEvery: tickEvery,
    monthDividers: true,
    valueLabel: (p)=> `${p.weight}√ó${p.reps||0}`
  });

  updateProgressionInfo(exerciseName, progressionData);
}

function renderNoProgressionData(exerciseName) {
  const container = document.querySelector('#progressionChart').parentElement;
  
  const message = document.createElement('div');
  message.className = 'no-progression-data';
  message.innerHTML = `
    <div style="font-size: 2rem; margin-bottom: 8px;">üìä</div>
    <div>No data found for <strong>${exerciseName}</strong></div>
    <div style="font-size: 0.9rem; margin-top: 4px;">Complete some workouts to see progression</div>
  `;
  
  container.style.position = 'relative';
  container.appendChild(message);
}

/* FIX #8: Enhanced progression info */

function updateProgressionInfo(exerciseName, data) {
  let infoPanel = document.getElementById('progression-info');

  if(!infoPanel) {
    infoPanel = document.createElement('div');
    infoPanel.id = 'progression-info';
    infoPanel.style.cssText = `
      margin-top: 12px;
      padding: 10px;
      background: #0f141b;
      border: 1px solid var(--ring);
      border-radius: 12px;
      display: flex;
      gap: 10px;
      align-items: stretch;
      justify-content: space-between;
      flex-wrap: wrap;
    `;

    const chartContainer = document.getElementById('progressionChart').parentElement;
    chartContainer.appendChild(infoPanel);
  }

  const first = data[0];
  const last = data[data.length - 1];

  const best = data.reduce((m, d) => (d.weight > m.weight ? d : m), data[0]);
  // For PR, if there are multiple entries with same weight, prefer the highest reps at that weight.
  const prCandidates = data.filter(d => d.weight === best.weight);
  const pr = prCandidates.reduce((m, d) => (d.reps > m.reps ? d : m), prCandidates[0]);

  const weightGain = (last.weight || 0) - (first.weight || 0);
  const repGain = (last.reps || 0) - (first.reps || 0);

  const firstStrength = (first.weight || 0) * (first.reps || 0);
  const lastStrength = (last.weight || 0) * (last.reps || 0);
  const pctGain = firstStrength > 0 ? ((lastStrength - firstStrength) / firstStrength) * 100 : 0;

  const gainW = (weightGain > 0 ? `+${weightGain}` : `${weightGain}`);
  const gainR = (repGain > 0 ? `+${repGain}` : `${repGain}`);

  infoPanel.innerHTML = `
    <div class="progression-stat" style="flex:1 1 150px; padding:10px">
      <div style="font-size:1.2rem; margin-bottom:2px;">üí™</div>
      <div class="stat-value" style="font-size:1.05rem; font-weight:800; margin:0; -webkit-text-fill-color:unset; background:none; color:var(--accent)">${last.weight} √ó ${last.reps||0}</div>
      <div class="stat-label" style="font-size:.75rem">Current Max</div>
    </div>

    <div class="progression-stat" style="flex:1 1 150px; padding:10px">
      <div style="font-size:1.2rem; margin-bottom:2px;">üèÜ</div>
      <div class="stat-value" style="font-size:1.05rem; font-weight:800; margin:0; -webkit-text-fill-color:unset; background:none; color:var(--accent-2)">${pr.weight} √ó ${pr.reps||0}</div>
      <div class="stat-label" style="font-size:.75rem">All-Time PR</div>
    </div>

    <div class="progression-stat" style="flex:1 1 150px; padding:10px">
      <div style="font-size:1.2rem; margin-bottom:2px;">üìà</div>
      <div class="stat-value" style="font-size:1.05rem; font-weight:800; margin:0; -webkit-text-fill-color:unset; background:none; color:var(--good)">${gainW} √ó ${gainR}</div>
      <div class="stat-label" style="font-size:.75rem">Total Gain</div>
    </div>

    <div class="progression-stat" style="flex:1 1 150px; padding:10px">
      <div style="font-size:1.2rem; margin-bottom:2px;">‚ö°</div>
      <div class="stat-value" style="font-size:1.05rem; font-weight:800; margin:0; -webkit-text-fill-color:unset; background:none; color:var(--warn)">${last.weight} √ó ${last.reps||0}</div>
      <div class="stat-label" style="font-size:.75rem">Percent Gain</div>
      <div style="margin-top:4px; font-size:.75rem; color:var(--muted)">${pctGain >= 0 ? '+' : ''}${pctGain.toFixed(1)}%</div>
    </div>
  `;
}

function renderOverview(){
  const thisWeek = getPeriodStats(7);

  // Only keep the metrics that still exist on the page
  document.getElementById('totalVolume').textContent = thisWeek.volume.toLocaleString();
  document.getElementById('totalWorkouts').textContent = thisWeek.workouts;

  // Month / Week summaries (default to current month + current week inside that month)
  bindMonthWeekNav();
  renderMonthWeekSummaries();

  // Personal Records (one-line compressed)
  const prs = getPersonalRecords().slice(0, 8);
  const prList = document.getElementById('prList');
  prList.innerHTML = '';

  prs.forEach(pr => {
    const item = document.createElement('div');
    item.className = 'pr-item';

    const prVol = (Number(pr.weight)||0) * (Number(pr.reps)||0);
    const d = new Date(pr.date + 'T00:00:00');
    const dStr = `${d.getMonth()+1}/${d.getDate()}`;

    item.innerHTML = `
      <div class="pr-one-line">
        <div class="left">
          <span class="pr-exercise">${pr.exercise}</span>
          <span class="meta"> ‚Äî ${pr.weight} √ó ${pr.reps || 0} reps | PR Volume: ${prVol.toLocaleString()} | Date: ${dStr}</span>
        </div>
        <div class="right">${pr.weight} lb</div>
      </div>
    `;
    item.addEventListener('click', () => showPRDetail(pr));
    prList.appendChild(item);
  });

  // Exercise progression filters + dropdown
  renderMuscleGroupFilters();
  renderFilteredExercises('all');

  // Volume trends chart
  drawVolumeChart('7d');

  // Download button
  const dl = document.getElementById('downloadDataBtn');
  if(dl && !dl.dataset.bound){
    dl.dataset.bound = '1';
    dl.addEventListener('click', ()=>{
      const data = exportAllWorkoutData();
      const stamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
      downloadJSON(`powerup-workouts-${stamp}.json`, data);
    });
  }
}


/* FIX #5: Show PR detail modal */
function showPRDetail(pr) {
  const history = getExerciseHistory(pr.exercise, pr.bodyPart, 20);
  
  document.getElementById('prDetailTitle').textContent = `${pr.exercise} - Progression`;
  document.getElementById('prDetailInfo').innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; text-align:center">
      <div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--accent-2)">${pr.weight} lb</div>
        <div style="font-size:.85rem; color:var(--muted); margin-top:4px">Current PR</div>
      </div>
      <div>
        <div style="font-size:1.5rem; font-weight:700; color:var(--accent)">${history.length}</div>
        <div style="font-size:.85rem; color:var(--muted); margin-top:4px">Total Workouts</div>
      </div>
    </div>
    <div style="margin-top:8px; font-size:.9rem; color:var(--muted); text-align:center">
      ${new Date(pr.date).toLocaleDateString('en', {month:'long', day:'numeric', year:'numeric'})}
    </div>
  `;
  
  document.getElementById('prDetailPopup').style.display = 'flex';
  
  setTimeout(() => {
    drawPRChart('prDetailChart', history, pr.weight);
  }, 100);
}

function renderAllRecords(){
  const records = getPersonalRecords();
  const container = document.getElementById('allRecords');
  
  const byBodyPart = records.reduce((acc, record) => {
    const part = record.bodyPart || 'Other';
    if(!acc[part]) acc[part] = [];
    acc[part].push(record);
    return acc;
  }, {});
  
  container.innerHTML = '';
  Object.entries(byBodyPart).forEach(([bodyPart, records]) => {
    const section = document.createElement('div');
    section.innerHTML = `
      <h4 style="margin:1rem 0 .5rem; color:var(--accent); font-size:1.1rem">${bodyPart}</h4>
      <div style="display:grid; gap:8px">
        ${records.map(pr => `
          <div class="pr-item" onclick="showPRDetail(${JSON.stringify(pr).replace(/"/g, '&quot;')})">
            <div>
              <div class="pr-exercise">${pr.exercise}</div>
              <div class="pr-date">${pr.reps} reps ‚Ä¢ ${new Date(pr.date).toLocaleDateString()}</div>
            </div>
            <div class="pr-weight">${pr.weight} lb</div>
          </div>
        `).join('')}
      </div>
    `;
    container.appendChild(section);
  });
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const view = tab.dataset.view;
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
      content.style.display = 'none';
    });
    document.getElementById(view + 'Tab').style.display = 'block';
    
    if(view === 'records') renderAllRecords();
  });
});

document.querySelectorAll('[data-period]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-period]').forEach(b => {
      b.classList.remove('active');
      b.classList.add('btn-ghost');
      b.classList.remove('btn-primary');
    });
    btn.classList.add('active');
    btn.classList.add('btn-primary');
    btn.classList.remove('btn-ghost');
    
    drawVolumeChart(btn.dataset.period);
  });
});

renderOverview();

window.addEventListener('resize', () => {
  setTimeout(() => {
    drawVolumeChart(document.querySelector('[data-period].active')?.dataset.period || '7d');
    const activeExercise = document.querySelector('.exercise-chip.active')?.textContent;
    if(activeExercise) {
      const name = activeExercise.split(' (')[0];
      const bodyPart = document.querySelector('.exercise-chip.active')?.dataset.bodypart;
      if(name && bodyPart) drawProgressionChart(name, bodyPart);
    }
  }, 100);
});
</script>
</body>
</html>